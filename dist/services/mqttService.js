var a18_0x314e=['exit','handleAppExit','uncaughtException','Connected\x20to\x20broker\x20client:','player/open','player/close','player/reboot','player/load_playlist','player/reload_playlist','player/update','player/ifconfig','reportStatus','received\x20message\x20%s\x20%s','handleOpenRequest','handleRebootRequest','handleReloadPlaylistRequest','handleLoadPlaylistRequest','handleUpdateRequest','handleRegisterRequest','playerId','registerClient','all','syncPlaylistsService','handleUpdateRequest:\x20','Git\x20updating','pull','summary','changes','shutdown','loadMediaList','reloadMediaList','shutdown\x20-r\x20now','sending\x20state\x20%s','player/state','open','opening','sendStateUpdate','handleCloseRequest','closed','closing','stack','false','sign','MqttService','__esModule','./../infrastructure/HttpClientService','fs-extra','request','request-progress','child_process','exec','is-image','string-template','mqtt','uuid/v4','state','httpClientService','init','mqttInit_mosquitto','mqttInit_google','velvety-glazing-252020','my-registry','us-central1','RS256','mqtt.googleapis.com','events','projects/','/locations/','/devices/','createJwt','round','now','connect','/config','subscribe','/state','/commands/#','log','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','publish\x20result:','close','error','Message\x20received:\x20','Config\x20message\x20received:\x20','startsWith','/commands','from','base64','packetsend','clientId','this.clientId','lulo_mqtt','run.lulo_2018#.','mqttClient','mqttClient_connect','bind','message','mqttClient_message'];(function(_0x488f65,_0x2dd385){var _0xf56412=function(_0x11d23b){while(--_0x11d23b){_0x488f65['push'](_0x488f65['shift']());}};_0xf56412(++_0x2dd385);}(a18_0x314e,0x1c0));var a18_0xb708=function(_0x4046d5,_0x3f1cf9){_0x4046d5=_0x4046d5-0x0;var _0x12bedb=a18_0x314e[_0x4046d5];return _0x12bedb;};'use strict';Object['defineProperty'](exports,a18_0xb708('0x0'),{'value':!![]});const HttpClientService_1=require(a18_0xb708('0x1'));const fs=require('fs');const fsExtra=require(a18_0xb708('0x2'));const request=require(a18_0xb708('0x3'));const progress=require(a18_0xb708('0x4'));const {spawn}=require('child_process');const exec=require(a18_0xb708('0x5'))[a18_0xb708('0x6')];const isImage=require(a18_0xb708('0x7'));const format=require(a18_0xb708('0x8'));const os=require('os');const mqtt=require(a18_0xb708('0x9'));const uuidv4=require(a18_0xb708('0xa'));const jwt=require('jsonwebtoken');class MqttService{constructor(_0x40e269){this['syncPlaylistsService']=_0x40e269;this[a18_0xb708('0xb')]='closed';this[a18_0xb708('0xc')]=new HttpClientService_1['HttpClientService']();}[a18_0xb708('0xd')](){this[a18_0xb708('0xe')]();}[a18_0xb708('0xf')](){console['log']('mqttInit');const _0x333fa4=a18_0xb708('0x10');const _0x7f87e0='my-node-device';const _0x42b871=a18_0xb708('0x11');const _0x2917f9=a18_0xb708('0x12');const _0x148964=a18_0xb708('0x13');const _0x242e70='resources/keys/rsa_private.pem';const _0x299519=a18_0xb708('0x14');const _0x10a666=0x1bb;const _0x29b622=a18_0xb708('0x15');const _0x18a1de=0x5;const _0x36d2a3=a18_0xb708('0x16')+_0x333fa4+a18_0xb708('0x17')+_0x2917f9+'/registries/'+_0x42b871+a18_0xb708('0x18')+_0x7f87e0;const _0x430eab={'host':_0x299519,'port':_0x10a666,'clientId':_0x36d2a3,'username':'unused','password':this[a18_0xb708('0x19')](_0x333fa4,_0x242e70,_0x148964),'protocol':'mqtts','secureProtocol':'TLSv1_2_method'};const _0x2889ed=Math[a18_0xb708('0x1a')](Date[a18_0xb708('0x1b')]()/0x3e8);const _0x457ec5=mqtt[a18_0xb708('0x1c')](_0x430eab);_0x457ec5['subscribe']('/devices/'+_0x7f87e0+a18_0xb708('0x1d'),{'qos':0x1});_0x457ec5[a18_0xb708('0x1e')](a18_0xb708('0x18')+_0x7f87e0+a18_0xb708('0x1f'),{'qos':0x1});_0x457ec5[a18_0xb708('0x1e')](a18_0xb708('0x18')+_0x7f87e0+a18_0xb708('0x20'),{'qos':0x0});const _0x200ef7=a18_0xb708('0x18')+_0x7f87e0+'/'+_0x29b622;_0x457ec5['on'](a18_0xb708('0x1c'),_0x12e8e9=>{console[a18_0xb708('0x21')](a18_0xb708('0x1c'));if(!_0x12e8e9){console[a18_0xb708('0x21')](a18_0xb708('0x22'));}else{const _0x200ef7=a18_0xb708('0x23');const _0x49eddb=_0x42b871+'/'+_0x7f87e0+a18_0xb708('0x24');_0x457ec5[a18_0xb708('0x25')](_0x200ef7,_0x49eddb,{'qos':0x1},_0x24718c=>{console['log'](a18_0xb708('0x26'));console[a18_0xb708('0x21')](_0x24718c);if(!_0x24718c){}});}});_0x457ec5['on'](a18_0xb708('0x27'),()=>{console[a18_0xb708('0x21')](a18_0xb708('0x27'));});_0x457ec5['on'](a18_0xb708('0x28'),_0x28bf43=>{console[a18_0xb708('0x21')]('error',_0x28bf43);});_0x457ec5['on']('message',(_0x4a836a,_0x26ee14)=>{let _0x22598e=a18_0xb708('0x29');console['log'](_0x4a836a);console['log'](_0x26ee14+'');if(_0x4a836a==='/devices/'+_0x7f87e0+a18_0xb708('0x1d')){_0x22598e=a18_0xb708('0x2a');}else if(_0x4a836a[a18_0xb708('0x2b')](a18_0xb708('0x18')+_0x7f87e0+a18_0xb708('0x2c'))){_0x22598e='Command\x20message\x20received:\x20';}_0x22598e+=Buffer[a18_0xb708('0x2d')](_0x26ee14,a18_0xb708('0x2e'))['toString']('ascii');console['log'](_0x22598e);});_0x457ec5['on'](a18_0xb708('0x2f'),()=>{});console[a18_0xb708('0x21')](_0x430eab);}['mqttInit_mosquitto'](){console[a18_0xb708('0x21')]('mqttInit');this[a18_0xb708('0x30')]=uuidv4();console[a18_0xb708('0x21')](a18_0xb708('0x31'));console['log'](this[a18_0xb708('0x30')]);const _0xe31336={'clientId':this[a18_0xb708('0x30')],'username':a18_0xb708('0x32'),'password':a18_0xb708('0x33'),'clean':!![]};this['mqttClient']=mqtt[a18_0xb708('0x1c')]('mqtt://lulo.run',_0xe31336);this[a18_0xb708('0x34')]['on'](a18_0xb708('0x1c'),this[a18_0xb708('0x35')][a18_0xb708('0x36')](this));this[a18_0xb708('0x34')]['on'](a18_0xb708('0x37'),this[a18_0xb708('0x38')]['bind'](this));this['mqttClient']['on'](a18_0xb708('0x27'),()=>{console[a18_0xb708('0x21')]('close');});process['on'](a18_0xb708('0x39'),this[a18_0xb708('0x3a')][a18_0xb708('0x36')](this));process['on']('SIGINT',this[a18_0xb708('0x3a')][a18_0xb708('0x36')](this));process['on'](a18_0xb708('0x3b'),this[a18_0xb708('0x3a')][a18_0xb708('0x36')](this));}[a18_0xb708('0x35')](){console[a18_0xb708('0x21')](a18_0xb708('0x3c')+this[a18_0xb708('0x30')]);this[a18_0xb708('0x34')][a18_0xb708('0x1e')](a18_0xb708('0x3d'));this[a18_0xb708('0x34')][a18_0xb708('0x1e')](a18_0xb708('0x3e'));this[a18_0xb708('0x34')]['subscribe'](a18_0xb708('0x3f'),{'qos':0x2});this[a18_0xb708('0x34')][a18_0xb708('0x1e')](a18_0xb708('0x40'),{'qos':0x2});this[a18_0xb708('0x34')][a18_0xb708('0x1e')](a18_0xb708('0x41'),{'qos':0x2});this[a18_0xb708('0x34')][a18_0xb708('0x1e')](a18_0xb708('0x42'),{'qos':0x2});this['mqttClient'][a18_0xb708('0x1e')](a18_0xb708('0x43'),{'qos':0x2});this[a18_0xb708('0x34')][a18_0xb708('0x1e')]('player/register',{'qos':0x2});}[a18_0xb708('0x44')](){}[a18_0xb708('0x38')](_0x3d5280,_0x5c58c0){console['log'](a18_0xb708('0x45'),_0x3d5280,_0x5c58c0);switch(_0x3d5280){case'player/open':return this[a18_0xb708('0x46')](_0x5c58c0);case a18_0xb708('0x3e'):return this['handleCloseRequest'](_0x5c58c0);case a18_0xb708('0x3f'):return this[a18_0xb708('0x47')](_0x5c58c0);case a18_0xb708('0x41'):return this[a18_0xb708('0x48')](_0x5c58c0);case a18_0xb708('0x40'):return this[a18_0xb708('0x49')](_0x5c58c0);case a18_0xb708('0x42'):return this[a18_0xb708('0x4a')](_0x5c58c0);case a18_0xb708('0x43'):return this['handleIfconfigRequest'](_0x5c58c0);case'player/register':return this[a18_0xb708('0x4b')](_0x5c58c0);}}['handleRegisterRequest'](_0x41c8a6){if(_0x41c8a6=='all'||_0x41c8a6==String(this['syncPlaylistsService'][a18_0xb708('0x4c')])){this['syncPlaylistsService'][a18_0xb708('0x4d')]();}}['handleIfconfigRequest'](_0xa8521d){if(_0xa8521d==a18_0xb708('0x4e')||_0xa8521d==String(this[a18_0xb708('0x4f')][a18_0xb708('0x4c')])){}}['handleUpdateRequest'](_0x1e4505){console[a18_0xb708('0x21')](a18_0xb708('0x50')+_0x1e4505);if(_0x1e4505==a18_0xb708('0x4e')||_0x1e4505==String(this[a18_0xb708('0x4f')][a18_0xb708('0x4c')])){const _0x5e8572=__dirname;const _0x492df0=require('simple-git')(_0x5e8572);console[a18_0xb708('0x21')](a18_0xb708('0x51'));_0x492df0[a18_0xb708('0x52')]((_0x2cfe70,_0x35ea02)=>{if(_0x2cfe70){console[a18_0xb708('0x21')]('Error\x20git\x20updated');this[a18_0xb708('0x4a')](_0x1e4505);return;}else{}console[a18_0xb708('0x21')]('Git\x20updated');console['log'](_0x35ea02);if(_0x35ea02&&_0x35ea02[a18_0xb708('0x53')][a18_0xb708('0x54')]){const _0x249a6d=spawn(a18_0xb708('0x55'),['-r',a18_0xb708('0x1b')]);}else{}});}}[a18_0xb708('0x49')](_0x590154){if(_0x590154==a18_0xb708('0x4e')||_0x590154==String(this['syncPlaylistsService'][a18_0xb708('0x4c')])){this[a18_0xb708('0x4f')][a18_0xb708('0x56')]();}}[a18_0xb708('0x48')](_0x58e4e6){if(String(_0x58e4e6)==a18_0xb708('0x4e')||String(_0x58e4e6)==String(this[a18_0xb708('0x4f')][a18_0xb708('0x4c')])){this[a18_0xb708('0x4f')][a18_0xb708('0x57')]();}}['handleRebootRequest'](_0x14001c){if(_0x14001c==a18_0xb708('0x4e')||_0x14001c==String(this[a18_0xb708('0x4f')][a18_0xb708('0x4c')])){console[a18_0xb708('0x21')]('handleRebootRequest\x20shutdown');try{exec(a18_0xb708('0x58'),function(_0x29024e,_0x46d4ee,_0x3280fa){console[a18_0xb708('0x21')](_0x29024e);console[a18_0xb708('0x21')](_0x46d4ee);console[a18_0xb708('0x21')](_0x3280fa);});}catch(_0x4a7be0){console[a18_0xb708('0x21')](_0x4a7be0);}}}['sendStateUpdate'](){console[a18_0xb708('0x21')](a18_0xb708('0x59'),this['state']);this[a18_0xb708('0x34')][a18_0xb708('0x25')](a18_0xb708('0x5a'),this[a18_0xb708('0x4f')][a18_0xb708('0x4c')]+'-'+this[a18_0xb708('0xb')]);}[a18_0xb708('0x46')](_0x5f15ce){if(this[a18_0xb708('0xb')]!==a18_0xb708('0x5b')&&this[a18_0xb708('0xb')]!==a18_0xb708('0x5c')){console['log']('opening\x20player\x20door');this['state']=a18_0xb708('0x5c');this[a18_0xb708('0x5d')]();setTimeout(()=>{this[a18_0xb708('0xb')]='open';this['sendStateUpdate']();},0x1388);}}[a18_0xb708('0x5e')](_0x39efb5){if(this['state']!==a18_0xb708('0x5f')&&this[a18_0xb708('0xb')]!==a18_0xb708('0x60')){this['state']=a18_0xb708('0x60');this[a18_0xb708('0x5d')]();setTimeout(()=>{this['state']=a18_0xb708('0x5f');this[a18_0xb708('0x5d')]();},0x1388);}}[a18_0xb708('0x3a')](_0x267aef,_0x41e78f){if(_0x41e78f){console[a18_0xb708('0x21')](_0x41e78f[a18_0xb708('0x61')]);}this[a18_0xb708('0x34')][a18_0xb708('0x25')]('player/connected',a18_0xb708('0x62'));}[a18_0xb708('0x19')](_0x516e75,_0xc2b1b6,_0xa22edc){const _0x3da726={'iat':Math['round'](Date[a18_0xb708('0x1b')]()/0x3e8),'exp':Math['round'](Date[a18_0xb708('0x1b')]()/0x3e8)+0x14*0x3c,'aud':_0x516e75};const _0x206ee7=fs['readFileSync'](_0xc2b1b6);return jwt[a18_0xb708('0x63')](_0x3da726,_0x206ee7,{'algorithm':_0xa22edc});}}exports[a18_0xb708('0x64')]=MqttService;