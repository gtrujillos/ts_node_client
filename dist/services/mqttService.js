var a18_0x4109=['bind','mqttClient_message','exit','handleAppExit','uncaughtException','Connected\x20to\x20broker\x20client:','player/open','player/close','player/load_playlist','player/reload_playlist','player/update','player/ifconfig','player/update_settings','reportStatus','handleOpenRequest','handleCloseRequest','player/reboot','handleRebootRequest','handleReloadPlaylistRequest','handleLoadPlaylistRequest','handleUpdateRequest','player/register','handleRegisterRequest','all','syncPlaylistsService','playerId','registerClient','handleUpdateRequest:\x20','simple-git','Git\x20updating','Error\x20git\x20updated','summary','changes','loadMediaList','reloadMediaList','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','reboot','handleUpdateSettingsRequest','handleUpdateSettingsRequest:\x20','updateSettings','sendStateUpdate','sending\x20state\x20%s','player/state','opening','opening\x20player\x20door','open','false','sign','MqttService','defineProperty','./../infrastructure/HttpClientService','fs-extra','request','child_process','exec','is-image','string-template','mqtt','jsonwebtoken','state','closed','httpClientService','HttpClientService','init','mqttInit_google','log','mqttInit','velvety-glazing-252020','my-node-device','my-registry','us-central1','RS256','resources/keys/rsa_private.pem','mqtt.googleapis.com','projects/','/locations/','/registries/','/devices/','unused','createJwt','TLSv1_2_method','round','now','subscribe','/state','/commands/#','connect','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','publish\x20result:','close','error','message','Config\x20message\x20received:\x20','startsWith','Command\x20message\x20received:\x20','from','base64','toString','ascii','mqttInit_mosquitto','clientId','this.clientId','run.lulo_2018#.','mqttClient','mqtt://lulo.run','mqttClient_connect'];(function(_0x23057d,_0x22cd12){var _0xbd1fa0=function(_0x3d1b6e){while(--_0x3d1b6e){_0x23057d['push'](_0x23057d['shift']());}};_0xbd1fa0(++_0x22cd12);}(a18_0x4109,0x178));var a18_0x3037=function(_0x3162fa,_0x574eb2){_0x3162fa=_0x3162fa-0x0;var _0x5b0a85=a18_0x4109[_0x3162fa];return _0x5b0a85;};'use strict';Object[a18_0x3037('0x0')](exports,'__esModule',{'value':!![]});const HttpClientService_1=require(a18_0x3037('0x1'));const fs=require('fs');const fsExtra=require(a18_0x3037('0x2'));const request=require(a18_0x3037('0x3'));const progress=require('request-progress');const spawn=require(a18_0x3037('0x4'))['spawn'];const exec=require(a18_0x3037('0x4'))[a18_0x3037('0x5')];const isImage=require(a18_0x3037('0x6'));const format=require(a18_0x3037('0x7'));const os=require('os');const mqtt=require(a18_0x3037('0x8'));const uuidv4=require('uuid/v4');const jwt=require(a18_0x3037('0x9'));class MqttService{constructor(_0x592441){this['syncPlaylistsService']=_0x592441;this[a18_0x3037('0xa')]=a18_0x3037('0xb');this[a18_0x3037('0xc')]=new HttpClientService_1[(a18_0x3037('0xd'))]();}[a18_0x3037('0xe')](){this['mqttInit_mosquitto']();}[a18_0x3037('0xf')](){console[a18_0x3037('0x10')](a18_0x3037('0x11'));const _0x4286d0=a18_0x3037('0x12');const _0x399ef5=a18_0x3037('0x13');const _0x17ee6c=a18_0x3037('0x14');const _0x1236fa=a18_0x3037('0x15');const _0x481d0e=a18_0x3037('0x16');const _0x3568ee=a18_0x3037('0x17');const _0x11d87d=a18_0x3037('0x18');const _0x4b9ef1=0x1bb;const _0x508c59='events';const _0x4edf13=0x5;const _0x53cfce=a18_0x3037('0x19')+_0x4286d0+a18_0x3037('0x1a')+_0x1236fa+a18_0x3037('0x1b')+_0x17ee6c+a18_0x3037('0x1c')+_0x399ef5;const _0x1421a8={'host':_0x11d87d,'port':_0x4b9ef1,'clientId':_0x53cfce,'username':a18_0x3037('0x1d'),'password':this[a18_0x3037('0x1e')](_0x4286d0,_0x3568ee,_0x481d0e),'protocol':'mqtts','secureProtocol':a18_0x3037('0x1f')};const _0x2d601e=Math[a18_0x3037('0x20')](Date[a18_0x3037('0x21')]()/0x3e8);const _0x401b6b=mqtt['connect'](_0x1421a8);_0x401b6b['subscribe']('/devices/'+_0x399ef5+'/config',{'qos':0x1});_0x401b6b[a18_0x3037('0x22')](a18_0x3037('0x1c')+_0x399ef5+a18_0x3037('0x23'),{'qos':0x1});_0x401b6b['subscribe']('/devices/'+_0x399ef5+a18_0x3037('0x24'),{'qos':0x0});const _0x48dd43=a18_0x3037('0x1c')+_0x399ef5+'/'+_0x508c59;_0x401b6b['on'](a18_0x3037('0x25'),_0x265be5=>{console[a18_0x3037('0x10')]('connect');if(!_0x265be5){console['log'](a18_0x3037('0x26'));}else{const _0x48dd43=a18_0x3037('0x27');const _0x4cad74=_0x17ee6c+'/'+_0x399ef5+a18_0x3037('0x28');_0x401b6b[a18_0x3037('0x29')](_0x48dd43,_0x4cad74,{'qos':0x1},_0x2af006=>{console[a18_0x3037('0x10')](a18_0x3037('0x2a'));console[a18_0x3037('0x10')](_0x2af006);if(!_0x2af006){}});}});_0x401b6b['on']('close',()=>{console[a18_0x3037('0x10')](a18_0x3037('0x2b'));});_0x401b6b['on']('error',_0x49f1e8=>{console['log'](a18_0x3037('0x2c'),_0x49f1e8);});_0x401b6b['on'](a18_0x3037('0x2d'),(_0x24f955,_0x5a787d)=>{let _0x5a5e7c='Message\x20received:\x20';console['log'](_0x24f955);console[a18_0x3037('0x10')](_0x5a787d+'');if(_0x24f955===a18_0x3037('0x1c')+_0x399ef5+'/config'){_0x5a5e7c=a18_0x3037('0x2e');}else if(_0x24f955[a18_0x3037('0x2f')](a18_0x3037('0x1c')+_0x399ef5+'/commands')){_0x5a5e7c=a18_0x3037('0x30');}_0x5a5e7c+=Buffer[a18_0x3037('0x31')](_0x5a787d,a18_0x3037('0x32'))[a18_0x3037('0x33')](a18_0x3037('0x34'));console[a18_0x3037('0x10')](_0x5a5e7c);});_0x401b6b['on']('packetsend',()=>{});console[a18_0x3037('0x10')](_0x1421a8);}[a18_0x3037('0x35')](){console['log']('mqttInit');this[a18_0x3037('0x36')]=uuidv4();console[a18_0x3037('0x10')](a18_0x3037('0x37'));console[a18_0x3037('0x10')](this[a18_0x3037('0x36')]);const _0xca7574={'clientId':this['clientId'],'username':'lulo_mqtt','password':a18_0x3037('0x38'),'clean':!![]};this[a18_0x3037('0x39')]=mqtt[a18_0x3037('0x25')](a18_0x3037('0x3a'),_0xca7574);this[a18_0x3037('0x39')]['on'](a18_0x3037('0x25'),this[a18_0x3037('0x3b')][a18_0x3037('0x3c')](this));this[a18_0x3037('0x39')]['on'](a18_0x3037('0x2d'),this[a18_0x3037('0x3d')]['bind'](this));this['mqttClient']['on'](a18_0x3037('0x2b'),()=>{console[a18_0x3037('0x10')](a18_0x3037('0x2b'));});process['on'](a18_0x3037('0x3e'),this[a18_0x3037('0x3f')]['bind'](this));process['on']('SIGINT',this[a18_0x3037('0x3f')][a18_0x3037('0x3c')](this));process['on'](a18_0x3037('0x40'),this[a18_0x3037('0x3f')]['bind'](this));}['mqttClient_connect'](){console[a18_0x3037('0x10')](a18_0x3037('0x41')+this[a18_0x3037('0x36')]);this[a18_0x3037('0x39')][a18_0x3037('0x22')](a18_0x3037('0x42'));this[a18_0x3037('0x39')][a18_0x3037('0x22')](a18_0x3037('0x43'));this['mqttClient'][a18_0x3037('0x22')]('player/reboot',{'qos':0x2});this[a18_0x3037('0x39')]['subscribe'](a18_0x3037('0x44'),{'qos':0x2});this[a18_0x3037('0x39')][a18_0x3037('0x22')](a18_0x3037('0x45'),{'qos':0x2});this['mqttClient'][a18_0x3037('0x22')](a18_0x3037('0x46'),{'qos':0x2});this['mqttClient'][a18_0x3037('0x22')](a18_0x3037('0x47'),{'qos':0x2});this[a18_0x3037('0x39')][a18_0x3037('0x22')]('player/register',{'qos':0x2});this['mqttClient']['subscribe'](a18_0x3037('0x48'),{'qos':0x2});}[a18_0x3037('0x49')](){}[a18_0x3037('0x3d')](_0x6b4079,_0x294fa4){console[a18_0x3037('0x10')]('received\x20message\x20%s\x20%s',_0x6b4079,_0x294fa4);switch(_0x6b4079){case'player/open':return this[a18_0x3037('0x4a')](_0x294fa4);case'player/close':return this[a18_0x3037('0x4b')](_0x294fa4);case a18_0x3037('0x4c'):return this[a18_0x3037('0x4d')](_0x294fa4);case a18_0x3037('0x45'):return this[a18_0x3037('0x4e')](_0x294fa4);case'player/load_playlist':return this[a18_0x3037('0x4f')](_0x294fa4);case a18_0x3037('0x46'):return this[a18_0x3037('0x50')](_0x294fa4);case a18_0x3037('0x47'):return this['handleIfconfigRequest'](_0x294fa4);case a18_0x3037('0x51'):return this[a18_0x3037('0x52')](_0x294fa4);case a18_0x3037('0x48'):return this['handleUpdateSettingsRequest'](_0x294fa4);}}[a18_0x3037('0x52')](_0x5e09a3){if(_0x5e09a3==a18_0x3037('0x53')||_0x5e09a3==String(this[a18_0x3037('0x54')][a18_0x3037('0x55')])){this[a18_0x3037('0x54')][a18_0x3037('0x56')]();}}['handleIfconfigRequest'](_0x517c51){if(_0x517c51==a18_0x3037('0x53')||_0x517c51==String(this[a18_0x3037('0x54')][a18_0x3037('0x55')])){}}[a18_0x3037('0x50')](_0x58c72c){console[a18_0x3037('0x10')](a18_0x3037('0x57')+_0x58c72c);if(_0x58c72c==a18_0x3037('0x53')||_0x58c72c==String(this[a18_0x3037('0x54')]['playerId'])){const _0x71ae95=__dirname;const _0x56f8ee=require(a18_0x3037('0x58'))(_0x71ae95);console['log'](a18_0x3037('0x59'));_0x56f8ee['pull']((_0xabc51b,_0x2c72f3)=>{if(_0xabc51b){console[a18_0x3037('0x10')](a18_0x3037('0x5a'));this[a18_0x3037('0x50')](_0x58c72c);return;}else{}console[a18_0x3037('0x10')]('Git\x20updated');console[a18_0x3037('0x10')](_0x2c72f3);if(_0x2c72f3&&_0x2c72f3[a18_0x3037('0x5b')][a18_0x3037('0x5c')]){this['syncPlaylistsService']['reboot']();}else{}});}}[a18_0x3037('0x4f')](_0x1402f2){if(_0x1402f2==a18_0x3037('0x53')||_0x1402f2==String(this[a18_0x3037('0x54')]['playerId'])){this[a18_0x3037('0x54')][a18_0x3037('0x5d')]();}}[a18_0x3037('0x4e')](_0xb8a4d0){if(String(_0xb8a4d0)=='all'||String(_0xb8a4d0)==String(this[a18_0x3037('0x54')][a18_0x3037('0x55')])){this['syncPlaylistsService'][a18_0x3037('0x5e')]();}}[a18_0x3037('0x4d')](_0x5d1d5a){if(_0x5d1d5a==a18_0x3037('0x53')||_0x5d1d5a==String(this[a18_0x3037('0x54')][a18_0x3037('0x55')])){console['log'](a18_0x3037('0x5f'));try{this[a18_0x3037('0x54')][a18_0x3037('0x60')]();}catch(_0x70323e){console['log'](_0x70323e);}}}[a18_0x3037('0x61')](_0xfe57f8){if(_0xfe57f8==a18_0x3037('0x53')||_0xfe57f8==String(this[a18_0x3037('0x54')][a18_0x3037('0x55')])){console[a18_0x3037('0x10')](a18_0x3037('0x62'));try{this[a18_0x3037('0x54')][a18_0x3037('0x63')]();}catch(_0x5d928c){console[a18_0x3037('0x10')](_0x5d928c);}}}[a18_0x3037('0x64')](){console[a18_0x3037('0x10')](a18_0x3037('0x65'),this['state']);this[a18_0x3037('0x39')][a18_0x3037('0x29')](a18_0x3037('0x66'),this[a18_0x3037('0x54')][a18_0x3037('0x55')]+'-'+this[a18_0x3037('0xa')]);}[a18_0x3037('0x4a')](_0xb54292){if(this[a18_0x3037('0xa')]!=='open'&&this['state']!==a18_0x3037('0x67')){console[a18_0x3037('0x10')](a18_0x3037('0x68'));this['state']=a18_0x3037('0x67');this[a18_0x3037('0x64')]();setTimeout(()=>{this[a18_0x3037('0xa')]=a18_0x3037('0x69');this[a18_0x3037('0x64')]();},0x1388);}}[a18_0x3037('0x4b')](_0x5abb84){if(this[a18_0x3037('0xa')]!==a18_0x3037('0xb')&&this['state']!=='closing'){this[a18_0x3037('0xa')]='closing';this[a18_0x3037('0x64')]();setTimeout(()=>{this[a18_0x3037('0xa')]=a18_0x3037('0xb');this[a18_0x3037('0x64')]();},0x1388);}}[a18_0x3037('0x3f')](_0x4d37aa,_0x3728f6){if(_0x3728f6){console[a18_0x3037('0x10')](_0x3728f6['stack']);}this[a18_0x3037('0x39')][a18_0x3037('0x29')]('player/connected',a18_0x3037('0x6a'));}[a18_0x3037('0x1e')](_0x32e2bf,_0x2ec26d,_0x38d030){const _0x349986={'iat':Math[a18_0x3037('0x20')](Date[a18_0x3037('0x21')]()/0x3e8),'exp':Math[a18_0x3037('0x20')](Date[a18_0x3037('0x21')]()/0x3e8)+0x14*0x3c,'aud':_0x32e2bf};const _0x2fa170=fs['readFileSync'](_0x2ec26d);return jwt[a18_0x3037('0x6b')](_0x349986,_0x2fa170,{'algorithm':_0x38d030});}}exports[a18_0x3037('0x6c')]=MqttService;