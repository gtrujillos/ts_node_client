var a18_0x508a=['open','opening','closing','stack','player/connected','false','sign','MqttService','defineProperty','fs-extra','request','child_process','spawn','is-image','string-template','uuid/v4','jsonwebtoken','syncPlaylistsService','closed','httpClientService','mqttInit_google','log','mqttInit','velvety-glazing-252020','my-node-device','my-registry','us-central1','RS256','resources/keys/rsa_private.pem','/locations/','/devices/','unused','createJwt','mqtts','TLSv1_2_method','round','now','connect','subscribe','/state','/commands/#','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','publish\x20result:','close','error','Message\x20received:\x20','/config','Config\x20message\x20received:\x20','startsWith','/commands','Command\x20message\x20received:\x20','from','base64','toString','mqttInit_mosquitto','clientId','run.lulo_2018#.','mqttClient','mqttClient_connect','bind','message','handleAppExit','Connected\x20to\x20broker\x20client:','player/open','player/close','player/reboot','player/load_playlist','player/update','player/ifconfig','player/register','player/update_settings','player/turn_off_tv','reportStatus','received\x20message\x20%s\x20%s','handleOpenRequest','handleCloseRequest','handleRebootRequest','player/reload_playlist','handleReloadPlaylistRequest','handleRegisterRequest','handleUpdateSettingsRequest','handleTurnOffTVRequest','player/turn_on_tv','handleTurnOnTVRequest','all','playerId','handleIfconfigRequest','handleUpdateRequest','handleUpdateRequest:\x20','simple-git','Error\x20git\x20updated','Git\x20updated','summary','changes','reboot','handleLoadPlaylistRequest','loadMediaList','reloadMediaList','updateSettings','turnOffTV','sendStateUpdate','sending\x20state\x20%s','state'];(function(_0x27a4fe,_0x2d6382){var _0x77e2ff=function(_0x2129f1){while(--_0x2129f1){_0x27a4fe['push'](_0x27a4fe['shift']());}};_0x77e2ff(++_0x2d6382);}(a18_0x508a,0x146));var a18_0x4c70=function(_0x54e9f7,_0x3ccd9a){_0x54e9f7=_0x54e9f7-0x0;var _0x2ebbff=a18_0x508a[_0x54e9f7];return _0x2ebbff;};'use strict';Object[a18_0x4c70('0x0')](exports,'__esModule',{'value':!![]});const HttpClientService_1=require('./../infrastructure/HttpClientService');const fs=require('fs');const fsExtra=require(a18_0x4c70('0x1'));const request=require(a18_0x4c70('0x2'));const progress=require('request-progress');const spawn=require(a18_0x4c70('0x3'))[a18_0x4c70('0x4')];const exec=require('child_process')['exec'];const isImage=require(a18_0x4c70('0x5'));const format=require(a18_0x4c70('0x6'));const os=require('os');const mqtt=require('mqtt');const uuidv4=require(a18_0x4c70('0x7'));const jwt=require(a18_0x4c70('0x8'));class MqttService{constructor(_0x3376c5){this[a18_0x4c70('0x9')]=_0x3376c5;this['state']=a18_0x4c70('0xa');this[a18_0x4c70('0xb')]=new HttpClientService_1['HttpClientService']();}['init'](){this['mqttInit_mosquitto']();}[a18_0x4c70('0xc')](){console[a18_0x4c70('0xd')](a18_0x4c70('0xe'));const _0x199732=a18_0x4c70('0xf');const _0x48a614=a18_0x4c70('0x10');const _0x2fae97=a18_0x4c70('0x11');const _0x2f994c=a18_0x4c70('0x12');const _0x351586=a18_0x4c70('0x13');const _0x3e1380=a18_0x4c70('0x14');const _0x2e7eff='mqtt.googleapis.com';const _0x5bdb4d=0x1bb;const _0x4791d4='events';const _0x215f39=0x5;const _0x43f1a1='projects/'+_0x199732+a18_0x4c70('0x15')+_0x2f994c+'/registries/'+_0x2fae97+a18_0x4c70('0x16')+_0x48a614;const _0x235ee4={'host':_0x2e7eff,'port':_0x5bdb4d,'clientId':_0x43f1a1,'username':a18_0x4c70('0x17'),'password':this[a18_0x4c70('0x18')](_0x199732,_0x3e1380,_0x351586),'protocol':a18_0x4c70('0x19'),'secureProtocol':a18_0x4c70('0x1a')};const _0x3889f3=Math[a18_0x4c70('0x1b')](Date[a18_0x4c70('0x1c')]()/0x3e8);const _0x2242ac=mqtt[a18_0x4c70('0x1d')](_0x235ee4);_0x2242ac[a18_0x4c70('0x1e')]('/devices/'+_0x48a614+'/config',{'qos':0x1});_0x2242ac[a18_0x4c70('0x1e')](a18_0x4c70('0x16')+_0x48a614+a18_0x4c70('0x1f'),{'qos':0x1});_0x2242ac[a18_0x4c70('0x1e')](a18_0x4c70('0x16')+_0x48a614+a18_0x4c70('0x20'),{'qos':0x0});const _0x477745=a18_0x4c70('0x16')+_0x48a614+'/'+_0x4791d4;_0x2242ac['on'](a18_0x4c70('0x1d'),_0x3e8fb7=>{console[a18_0x4c70('0xd')](a18_0x4c70('0x1d'));if(!_0x3e8fb7){console['log'](a18_0x4c70('0x21'));}else{const _0x477745=a18_0x4c70('0x22');const _0x3f0029=_0x2fae97+'/'+_0x48a614+a18_0x4c70('0x23');_0x2242ac[a18_0x4c70('0x24')](_0x477745,_0x3f0029,{'qos':0x1},_0xbed8b6=>{console[a18_0x4c70('0xd')](a18_0x4c70('0x25'));console[a18_0x4c70('0xd')](_0xbed8b6);if(!_0xbed8b6){}});}});_0x2242ac['on'](a18_0x4c70('0x26'),()=>{console[a18_0x4c70('0xd')]('close');});_0x2242ac['on'](a18_0x4c70('0x27'),_0x4ed1d1=>{console[a18_0x4c70('0xd')](a18_0x4c70('0x27'),_0x4ed1d1);});_0x2242ac['on']('message',(_0x237127,_0x1132f6)=>{let _0xdef481=a18_0x4c70('0x28');console[a18_0x4c70('0xd')](_0x237127);console[a18_0x4c70('0xd')](_0x1132f6+'');if(_0x237127===a18_0x4c70('0x16')+_0x48a614+a18_0x4c70('0x29')){_0xdef481=a18_0x4c70('0x2a');}else if(_0x237127[a18_0x4c70('0x2b')]('/devices/'+_0x48a614+a18_0x4c70('0x2c'))){_0xdef481=a18_0x4c70('0x2d');}_0xdef481+=Buffer[a18_0x4c70('0x2e')](_0x1132f6,a18_0x4c70('0x2f'))[a18_0x4c70('0x30')]('ascii');console[a18_0x4c70('0xd')](_0xdef481);});_0x2242ac['on']('packetsend',()=>{});console[a18_0x4c70('0xd')](_0x235ee4);}[a18_0x4c70('0x31')](){console[a18_0x4c70('0xd')]('mqttInit');this['clientId']=uuidv4();console['log']('this.clientId');console[a18_0x4c70('0xd')](this[a18_0x4c70('0x32')]);const _0x4bd878={'clientId':this[a18_0x4c70('0x32')],'username':'lulo_mqtt','password':a18_0x4c70('0x33'),'clean':!![]};this[a18_0x4c70('0x34')]=mqtt[a18_0x4c70('0x1d')]('mqtt://lulo.run',_0x4bd878);this['mqttClient']['on'](a18_0x4c70('0x1d'),this[a18_0x4c70('0x35')][a18_0x4c70('0x36')](this));this[a18_0x4c70('0x34')]['on'](a18_0x4c70('0x37'),this['mqttClient_message'][a18_0x4c70('0x36')](this));this[a18_0x4c70('0x34')]['on'](a18_0x4c70('0x26'),()=>{console['log'](a18_0x4c70('0x26'));});process['on']('exit',this[a18_0x4c70('0x38')][a18_0x4c70('0x36')](this));process['on']('SIGINT',this[a18_0x4c70('0x38')][a18_0x4c70('0x36')](this));process['on']('uncaughtException',this[a18_0x4c70('0x38')][a18_0x4c70('0x36')](this));}[a18_0x4c70('0x35')](){console[a18_0x4c70('0xd')](a18_0x4c70('0x39')+this[a18_0x4c70('0x32')]);this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x3a'));this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x3b'));this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x3c'),{'qos':0x2});this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x3d'),{'qos':0x2});this[a18_0x4c70('0x34')]['subscribe']('player/reload_playlist',{'qos':0x2});this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x3e'),{'qos':0x2});this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x3f'),{'qos':0x2});this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')](a18_0x4c70('0x40'),{'qos':0x2});this['mqttClient'][a18_0x4c70('0x1e')](a18_0x4c70('0x41'),{'qos':0x2});this['mqttClient'][a18_0x4c70('0x1e')](a18_0x4c70('0x42'),{'qos':0x2});this[a18_0x4c70('0x34')][a18_0x4c70('0x1e')]('player/turn_on_tv',{'qos':0x2});}[a18_0x4c70('0x43')](){}['mqttClient_message'](_0x6dab90,_0x3311a4){console[a18_0x4c70('0xd')](a18_0x4c70('0x44'),_0x6dab90,_0x3311a4);switch(_0x6dab90){case a18_0x4c70('0x3a'):return this[a18_0x4c70('0x45')](_0x3311a4);case a18_0x4c70('0x3b'):return this[a18_0x4c70('0x46')](_0x3311a4);case a18_0x4c70('0x3c'):return this[a18_0x4c70('0x47')](_0x3311a4);case a18_0x4c70('0x48'):return this[a18_0x4c70('0x49')](_0x3311a4);case a18_0x4c70('0x3d'):return this['handleLoadPlaylistRequest'](_0x3311a4);case a18_0x4c70('0x3e'):return this['handleUpdateRequest'](_0x3311a4);case a18_0x4c70('0x3f'):return this['handleIfconfigRequest'](_0x3311a4);case a18_0x4c70('0x40'):return this[a18_0x4c70('0x4a')](_0x3311a4);case a18_0x4c70('0x41'):return this[a18_0x4c70('0x4b')](_0x3311a4);case a18_0x4c70('0x42'):return this[a18_0x4c70('0x4c')](_0x3311a4);case a18_0x4c70('0x4d'):return this[a18_0x4c70('0x4e')](_0x3311a4);}}[a18_0x4c70('0x4a')](_0x1b927f){if(_0x1b927f==a18_0x4c70('0x4f')||_0x1b927f==String(this['syncPlaylistsService'][a18_0x4c70('0x50')])){this[a18_0x4c70('0x9')]['registerClient']();}}[a18_0x4c70('0x51')](_0x28b20d){if(_0x28b20d=='all'||_0x28b20d==String(this[a18_0x4c70('0x9')][a18_0x4c70('0x50')])){}}[a18_0x4c70('0x52')](_0x36e15e){console[a18_0x4c70('0xd')](a18_0x4c70('0x53')+_0x36e15e);if(_0x36e15e==a18_0x4c70('0x4f')||_0x36e15e==String(this[a18_0x4c70('0x9')][a18_0x4c70('0x50')])){const _0x4e5f5b=__dirname;const _0x15f88e=require(a18_0x4c70('0x54'))(_0x4e5f5b);console[a18_0x4c70('0xd')]('Git\x20updating');_0x15f88e['pull']((_0x24953d,_0x5e1528)=>{if(_0x24953d){console[a18_0x4c70('0xd')](a18_0x4c70('0x55'));this['handleUpdateRequest'](_0x36e15e);return;}else{}console[a18_0x4c70('0xd')](a18_0x4c70('0x56'));console['log'](_0x5e1528);if(_0x5e1528&&_0x5e1528[a18_0x4c70('0x57')][a18_0x4c70('0x58')]){this['syncPlaylistsService'][a18_0x4c70('0x59')]();}else{}});}}[a18_0x4c70('0x5a')](_0x3f2fae){if(_0x3f2fae==a18_0x4c70('0x4f')||_0x3f2fae==String(this['syncPlaylistsService']['playerId'])){this['syncPlaylistsService'][a18_0x4c70('0x5b')]();}}[a18_0x4c70('0x49')](_0x351c3a){if(String(_0x351c3a)==a18_0x4c70('0x4f')||String(_0x351c3a)==String(this[a18_0x4c70('0x9')][a18_0x4c70('0x50')])){this[a18_0x4c70('0x9')][a18_0x4c70('0x5c')]();}}['handleRebootRequest'](_0x4da7d5){if(_0x4da7d5==a18_0x4c70('0x4f')||_0x4da7d5==String(this['syncPlaylistsService'][a18_0x4c70('0x50')])){console[a18_0x4c70('0xd')]('handleRebootRequest\x20shutdown\x20-r\x20now:\x20');try{this[a18_0x4c70('0x9')][a18_0x4c70('0x59')]();}catch(_0x1849be){console[a18_0x4c70('0xd')](_0x1849be);}}}[a18_0x4c70('0x4b')](_0x12154b){if(_0x12154b=='all'||_0x12154b==String(this[a18_0x4c70('0x9')][a18_0x4c70('0x50')])){console[a18_0x4c70('0xd')]('handleUpdateSettingsRequest:\x20');try{this[a18_0x4c70('0x9')][a18_0x4c70('0x5d')]();}catch(_0x5c8a87){console[a18_0x4c70('0xd')](_0x5c8a87);}}}[a18_0x4c70('0x4e')](_0x2b1c0f){if(_0x2b1c0f==a18_0x4c70('0x4f')||_0x2b1c0f==String(this['syncPlaylistsService']['playerId'])){console[a18_0x4c70('0xd')]('handleTurnOnTVRequest:\x20');try{this[a18_0x4c70('0x9')]['turnOnTV']();}catch(_0x4ceeba){console[a18_0x4c70('0xd')](_0x4ceeba);}}}[a18_0x4c70('0x4c')](_0x29bd32){if(_0x29bd32=='all'||_0x29bd32==String(this['syncPlaylistsService'][a18_0x4c70('0x50')])){console[a18_0x4c70('0xd')]('handleTurnOffTVRequest:\x20');try{this[a18_0x4c70('0x9')][a18_0x4c70('0x5e')]();}catch(_0x2994da){console[a18_0x4c70('0xd')](_0x2994da);}}}[a18_0x4c70('0x5f')](){console['log'](a18_0x4c70('0x60'),this[a18_0x4c70('0x61')]);this[a18_0x4c70('0x34')][a18_0x4c70('0x24')]('player/state',this[a18_0x4c70('0x9')][a18_0x4c70('0x50')]+'-'+this[a18_0x4c70('0x61')]);}[a18_0x4c70('0x45')](_0x56257c){if(this['state']!==a18_0x4c70('0x62')&&this['state']!==a18_0x4c70('0x63')){console[a18_0x4c70('0xd')]('opening\x20player\x20door');this[a18_0x4c70('0x61')]=a18_0x4c70('0x63');this[a18_0x4c70('0x5f')]();setTimeout(()=>{this[a18_0x4c70('0x61')]='open';this[a18_0x4c70('0x5f')]();},0x1388);}}[a18_0x4c70('0x46')](_0x29a047){if(this[a18_0x4c70('0x61')]!==a18_0x4c70('0xa')&&this[a18_0x4c70('0x61')]!==a18_0x4c70('0x64')){this[a18_0x4c70('0x61')]='closing';this['sendStateUpdate']();setTimeout(()=>{this[a18_0x4c70('0x61')]=a18_0x4c70('0xa');this['sendStateUpdate']();},0x1388);}}[a18_0x4c70('0x38')](_0x7a3487,_0xf8de09){if(_0xf8de09){console[a18_0x4c70('0xd')](_0xf8de09[a18_0x4c70('0x65')]);}this[a18_0x4c70('0x34')][a18_0x4c70('0x24')](a18_0x4c70('0x66'),a18_0x4c70('0x67'));}[a18_0x4c70('0x18')](_0x39bd18,_0x4da0eb,_0x46a6ce){const _0x4959dc={'iat':Math[a18_0x4c70('0x1b')](Date[a18_0x4c70('0x1c')]()/0x3e8),'exp':Math[a18_0x4c70('0x1b')](Date[a18_0x4c70('0x1c')]()/0x3e8)+0x14*0x3c,'aud':_0x39bd18};const _0x51380a=fs['readFileSync'](_0x4da0eb);return jwt[a18_0x4c70('0x68')](_0x4959dc,_0x51380a,{'algorithm':_0x46a6ce});}}exports[a18_0x4c70('0x69')]=MqttService;