var a18_0x3a3f=['sign','defineProperty','__esModule','./../infrastructure/HttpClientService','fs-extra','spawn','child_process','exec','is-image','mqtt','uuid/v4','state','closed','httpClientService','HttpClientService','init','mqttInit_mosquitto','mqttInit_google','mqttInit','velvety-glazing-252020','my-registry','us-central1','events','projects/','/locations/','/registries/','/devices/','unused','createJwt','mqtts','TLSv1_2_method','round','connect','/config','subscribe','log','Client\x20not\x20connected...','-payload-0','publish','publish\x20result:','close','error','message','Message\x20received:\x20','Config\x20message\x20received:\x20','/commands','Command\x20message\x20received:\x20','base64','ascii','clientId','this.clientId','lulo_mqtt','mqtt://lulo.run','mqttClient_connect','bind','mqttClient','mqttClient_message','exit','handleAppExit','SIGINT','uncaughtException','player/open','player/close','player/load_playlist','player/reload_playlist','player/update','player/ifconfig','player/register','reportStatus','received\x20message\x20%s\x20%s','handleOpenRequest','handleRebootRequest','handleReloadPlaylistRequest','handleRegisterRequest','syncPlaylistsService','playerId','registerClient','handleIfconfigRequest','handleUpdateRequest','handleUpdateRequest:\x20','all','simple-git','Git\x20updating','pull','Error\x20git\x20updated','Git\x20updated','changes','shutdown','now','handleLoadPlaylistRequest','loadMediaList','reloadMediaList','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','sudo\x20/sbin/shutdown\x20-r\x20now','sendStateUpdate','sending\x20state\x20%s','player/state','open','opening','opening\x20player\x20door','handleCloseRequest','closing','player/connected','false','readFileSync'];(function(_0x16b206,_0x18b471){var _0x1ede76=function(_0xbf22){while(--_0xbf22){_0x16b206['push'](_0x16b206['shift']());}};_0x1ede76(++_0x18b471);}(a18_0x3a3f,0x13c));var a18_0x364f=function(_0x40ff86,_0x14ac54){_0x40ff86=_0x40ff86-0x0;var _0x4bc8f9=a18_0x3a3f[_0x40ff86];return _0x4bc8f9;};'use strict';Object[a18_0x364f('0x0')](exports,a18_0x364f('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x364f('0x2'));const fs=require('fs');const fsExtra=require(a18_0x364f('0x3'));const request=require('request');const progress=require('request-progress');const spawn=require('child_process')[a18_0x364f('0x4')];const exec=require(a18_0x364f('0x5'))[a18_0x364f('0x6')];const isImage=require(a18_0x364f('0x7'));const format=require('string-template');const os=require('os');const mqtt=require(a18_0x364f('0x8'));const uuidv4=require(a18_0x364f('0x9'));const jwt=require('jsonwebtoken');class MqttService{constructor(_0x48dede){this['syncPlaylistsService']=_0x48dede;this[a18_0x364f('0xa')]=a18_0x364f('0xb');this[a18_0x364f('0xc')]=new HttpClientService_1[(a18_0x364f('0xd'))]();}[a18_0x364f('0xe')](){this[a18_0x364f('0xf')]();}[a18_0x364f('0x10')](){console['log'](a18_0x364f('0x11'));const _0x3f7d5f=a18_0x364f('0x12');const _0x8f8ba7='my-node-device';const _0x4400e8=a18_0x364f('0x13');const _0x54b80e=a18_0x364f('0x14');const _0x17ab21='RS256';const _0x496cd0='resources/keys/rsa_private.pem';const _0x5f45ff='mqtt.googleapis.com';const _0x24cbbd=0x1bb;const _0x3a0d09=a18_0x364f('0x15');const _0x5e1ce8=0x5;const _0xaf26ed=a18_0x364f('0x16')+_0x3f7d5f+a18_0x364f('0x17')+_0x54b80e+a18_0x364f('0x18')+_0x4400e8+a18_0x364f('0x19')+_0x8f8ba7;const _0x5e4a91={'host':_0x5f45ff,'port':_0x24cbbd,'clientId':_0xaf26ed,'username':a18_0x364f('0x1a'),'password':this[a18_0x364f('0x1b')](_0x3f7d5f,_0x496cd0,_0x17ab21),'protocol':a18_0x364f('0x1c'),'secureProtocol':a18_0x364f('0x1d')};const _0x3c5280=Math[a18_0x364f('0x1e')](Date['now']()/0x3e8);const _0x1de69=mqtt[a18_0x364f('0x1f')](_0x5e4a91);_0x1de69['subscribe'](a18_0x364f('0x19')+_0x8f8ba7+a18_0x364f('0x20'),{'qos':0x1});_0x1de69[a18_0x364f('0x21')]('/devices/'+_0x8f8ba7+'/state',{'qos':0x1});_0x1de69['subscribe'](a18_0x364f('0x19')+_0x8f8ba7+'/commands/#',{'qos':0x0});const _0x5b4098=a18_0x364f('0x19')+_0x8f8ba7+'/'+_0x3a0d09;_0x1de69['on'](a18_0x364f('0x1f'),_0x27597b=>{console[a18_0x364f('0x22')](a18_0x364f('0x1f'));if(!_0x27597b){console[a18_0x364f('0x22')](a18_0x364f('0x23'));}else{const _0x5b4098='/projects/velvety-glazing-252020/topics/my-topic';const _0x1c1f54=_0x4400e8+'/'+_0x8f8ba7+a18_0x364f('0x24');_0x1de69[a18_0x364f('0x25')](_0x5b4098,_0x1c1f54,{'qos':0x1},_0xde5f71=>{console['log'](a18_0x364f('0x26'));console[a18_0x364f('0x22')](_0xde5f71);if(!_0xde5f71){}});}});_0x1de69['on'](a18_0x364f('0x27'),()=>{console[a18_0x364f('0x22')](a18_0x364f('0x27'));});_0x1de69['on'](a18_0x364f('0x28'),_0x3f886c=>{console[a18_0x364f('0x22')](a18_0x364f('0x28'),_0x3f886c);});_0x1de69['on'](a18_0x364f('0x29'),(_0x5945c3,_0x3da179)=>{let _0x14b122=a18_0x364f('0x2a');console[a18_0x364f('0x22')](_0x5945c3);console[a18_0x364f('0x22')](_0x3da179+'');if(_0x5945c3===a18_0x364f('0x19')+_0x8f8ba7+a18_0x364f('0x20')){_0x14b122=a18_0x364f('0x2b');}else if(_0x5945c3['startsWith'](a18_0x364f('0x19')+_0x8f8ba7+a18_0x364f('0x2c'))){_0x14b122=a18_0x364f('0x2d');}_0x14b122+=Buffer['from'](_0x3da179,a18_0x364f('0x2e'))['toString'](a18_0x364f('0x2f'));console[a18_0x364f('0x22')](_0x14b122);});_0x1de69['on']('packetsend',()=>{});console['log'](_0x5e4a91);}['mqttInit_mosquitto'](){console[a18_0x364f('0x22')]('mqttInit');this[a18_0x364f('0x30')]=uuidv4();console[a18_0x364f('0x22')](a18_0x364f('0x31'));console[a18_0x364f('0x22')](this[a18_0x364f('0x30')]);const _0x15b2ba={'clientId':this[a18_0x364f('0x30')],'username':a18_0x364f('0x32'),'password':'run.lulo_2018#.','clean':!![]};this['mqttClient']=mqtt[a18_0x364f('0x1f')](a18_0x364f('0x33'),_0x15b2ba);this['mqttClient']['on']('connect',this[a18_0x364f('0x34')][a18_0x364f('0x35')](this));this[a18_0x364f('0x36')]['on'](a18_0x364f('0x29'),this[a18_0x364f('0x37')][a18_0x364f('0x35')](this));this[a18_0x364f('0x36')]['on'](a18_0x364f('0x27'),()=>{console[a18_0x364f('0x22')](a18_0x364f('0x27'));});process['on'](a18_0x364f('0x38'),this[a18_0x364f('0x39')][a18_0x364f('0x35')](this));process['on'](a18_0x364f('0x3a'),this[a18_0x364f('0x39')][a18_0x364f('0x35')](this));process['on'](a18_0x364f('0x3b'),this[a18_0x364f('0x39')][a18_0x364f('0x35')](this));}[a18_0x364f('0x34')](){console[a18_0x364f('0x22')]('Connected\x20to\x20broker\x20client:'+this[a18_0x364f('0x30')]);this[a18_0x364f('0x36')][a18_0x364f('0x21')](a18_0x364f('0x3c'));this[a18_0x364f('0x36')]['subscribe'](a18_0x364f('0x3d'));this['mqttClient'][a18_0x364f('0x21')]('player/reboot',{'qos':0x2});this[a18_0x364f('0x36')][a18_0x364f('0x21')](a18_0x364f('0x3e'),{'qos':0x2});this['mqttClient'][a18_0x364f('0x21')](a18_0x364f('0x3f'),{'qos':0x2});this[a18_0x364f('0x36')][a18_0x364f('0x21')](a18_0x364f('0x40'),{'qos':0x2});this[a18_0x364f('0x36')][a18_0x364f('0x21')](a18_0x364f('0x41'),{'qos':0x2});this['mqttClient'][a18_0x364f('0x21')](a18_0x364f('0x42'),{'qos':0x2});}[a18_0x364f('0x43')](){}[a18_0x364f('0x37')](_0x373779,_0x484df9){console[a18_0x364f('0x22')](a18_0x364f('0x44'),_0x373779,_0x484df9);switch(_0x373779){case a18_0x364f('0x3c'):return this[a18_0x364f('0x45')](_0x484df9);case'player/close':return this['handleCloseRequest'](_0x484df9);case'player/reboot':return this[a18_0x364f('0x46')](_0x484df9);case a18_0x364f('0x3f'):return this[a18_0x364f('0x47')](_0x484df9);case a18_0x364f('0x3e'):return this['handleLoadPlaylistRequest'](_0x484df9);case a18_0x364f('0x40'):return this['handleUpdateRequest'](_0x484df9);case a18_0x364f('0x41'):return this['handleIfconfigRequest'](_0x484df9);case a18_0x364f('0x42'):return this['handleRegisterRequest'](_0x484df9);}}[a18_0x364f('0x48')](_0x1ca06c){if(_0x1ca06c=='all'||_0x1ca06c==String(this[a18_0x364f('0x49')][a18_0x364f('0x4a')])){this[a18_0x364f('0x49')][a18_0x364f('0x4b')]();}}[a18_0x364f('0x4c')](_0x1b99dd){if(_0x1b99dd=='all'||_0x1b99dd==String(this[a18_0x364f('0x49')][a18_0x364f('0x4a')])){}}[a18_0x364f('0x4d')](_0x1a0878){console[a18_0x364f('0x22')](a18_0x364f('0x4e')+_0x1a0878);if(_0x1a0878==a18_0x364f('0x4f')||_0x1a0878==String(this[a18_0x364f('0x49')][a18_0x364f('0x4a')])){const _0xee80b5=__dirname;const _0x41aa06=require(a18_0x364f('0x50'))(_0xee80b5);console['log'](a18_0x364f('0x51'));_0x41aa06[a18_0x364f('0x52')]((_0x4756f4,_0x2f594)=>{if(_0x4756f4){console[a18_0x364f('0x22')](a18_0x364f('0x53'));this[a18_0x364f('0x4d')](_0x1a0878);return;}else{}console['log'](a18_0x364f('0x54'));console[a18_0x364f('0x22')](_0x2f594);if(_0x2f594&&_0x2f594['summary'][a18_0x364f('0x55')]){const _0x4a2103=spawn(a18_0x364f('0x56'),['-r',a18_0x364f('0x57')]);}else{}});}}[a18_0x364f('0x58')](_0x4d0eb6){if(_0x4d0eb6=='all'||_0x4d0eb6==String(this['syncPlaylistsService'][a18_0x364f('0x4a')])){this['syncPlaylistsService'][a18_0x364f('0x59')]();}}[a18_0x364f('0x47')](_0x8a83ac){if(String(_0x8a83ac)=='all'||String(_0x8a83ac)==String(this['syncPlaylistsService']['playerId'])){this[a18_0x364f('0x49')][a18_0x364f('0x5a')]();}}['handleRebootRequest'](_0x209daa){if(_0x209daa=='all'||_0x209daa==String(this[a18_0x364f('0x49')][a18_0x364f('0x4a')])){console[a18_0x364f('0x22')](a18_0x364f('0x5b'));try{exec(a18_0x364f('0x5c'),function(_0x3fb63c){console[a18_0x364f('0x22')](_0x3fb63c);});}catch(_0x45af69){console['log'](_0x45af69);}}}[a18_0x364f('0x5d')](){console[a18_0x364f('0x22')](a18_0x364f('0x5e'),this['state']);this['mqttClient'][a18_0x364f('0x25')](a18_0x364f('0x5f'),this[a18_0x364f('0x49')]['playerId']+'-'+this['state']);}[a18_0x364f('0x45')](_0x1347e3){if(this[a18_0x364f('0xa')]!==a18_0x364f('0x60')&&this[a18_0x364f('0xa')]!==a18_0x364f('0x61')){console[a18_0x364f('0x22')](a18_0x364f('0x62'));this[a18_0x364f('0xa')]=a18_0x364f('0x61');this['sendStateUpdate']();setTimeout(()=>{this['state']=a18_0x364f('0x60');this[a18_0x364f('0x5d')]();},0x1388);}}[a18_0x364f('0x63')](_0x122bd2){if(this[a18_0x364f('0xa')]!==a18_0x364f('0xb')&&this[a18_0x364f('0xa')]!==a18_0x364f('0x64')){this['state']='closing';this[a18_0x364f('0x5d')]();setTimeout(()=>{this['state']=a18_0x364f('0xb');this[a18_0x364f('0x5d')]();},0x1388);}}['handleAppExit'](_0x3c5325,_0x2d3e52){if(_0x2d3e52){console[a18_0x364f('0x22')](_0x2d3e52['stack']);}this['mqttClient'][a18_0x364f('0x25')](a18_0x364f('0x65'),a18_0x364f('0x66'));}[a18_0x364f('0x1b')](_0x42c082,_0x38321,_0x50d38d){const _0xbccfda={'iat':Math['round'](Date[a18_0x364f('0x57')]()/0x3e8),'exp':Math[a18_0x364f('0x1e')](Date['now']()/0x3e8)+0x14*0x3c,'aud':_0x42c082};const _0x3c3773=fs[a18_0x364f('0x67')](_0x38321);return jwt[a18_0x364f('0x68')](_0xbccfda,_0x3c3773,{'algorithm':_0x50d38d});}}exports['MqttService']=MqttService;