var a18_0x5846=['__esModule','./../infrastructure/HttpClientService','fs-extra','request','request-progress','child_process','spawn','exec','is-image','mqtt','uuid/v4','jsonwebtoken','syncPlaylistsService','closed','httpClientService','HttpClientService','mqttInit_mosquitto','mqttInit_google','log','mqttInit','velvety-glazing-252020','my-registry','us-central1','resources/keys/rsa_private.pem','mqtt.googleapis.com','events','projects/','/locations/','/registries/','/devices/','unused','createJwt','mqtts','TLSv1_2_method','now','subscribe','/config','/commands/#','connect','publish\x20result:','close','error','message','Message\x20received:\x20','Config\x20message\x20received:\x20','/commands','from','base64','toString','clientId','this.clientId','mqttClient','mqtt://lulo.run','mqttClient_connect','bind','mqttClient_message','handleAppExit','uncaughtException','player/close','player/reboot','player/load_playlist','player/update','player/ifconfig','received\x20message\x20%s\x20%s','player/open','handleCloseRequest','handleRebootRequest','player/reload_playlist','handleUpdateRequest','handleIfconfigRequest','handleRegisterRequest','all','playerId','simple-git','Git\x20updating','pull','Error\x20git\x20updated','Git\x20updated','summary','changes','shutdown','handleLoadPlaylistRequest','handleReloadPlaylistRequest','reloadMediaList','sendStateUpdate','sending\x20state\x20%s','state','publish','player/state','handleOpenRequest','open','opening','closing','player/connected','false','round','sign','MqttService','defineProperty'];(function(_0x2230bd,_0x40e2c5){var _0x14e5fd=function(_0x21c4d6){while(--_0x21c4d6){_0x2230bd['push'](_0x2230bd['shift']());}};_0x14e5fd(++_0x40e2c5);}(a18_0x5846,0x18b));var a18_0x394d=function(_0x26ff02,_0x3c8a58){_0x26ff02=_0x26ff02-0x0;var _0xbfa71a=a18_0x5846[_0x26ff02];return _0xbfa71a;};'use strict';Object[a18_0x394d('0x0')](exports,a18_0x394d('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x394d('0x2'));const fs=require('fs');const fsExtra=require(a18_0x394d('0x3'));const request=require(a18_0x394d('0x4'));const progress=require(a18_0x394d('0x5'));const spawn=require(a18_0x394d('0x6'))[a18_0x394d('0x7')];const exec=require('child_process')[a18_0x394d('0x8')];const isImage=require(a18_0x394d('0x9'));const format=require('string-template');const os=require('os');const mqtt=require(a18_0x394d('0xa'));const uuidv4=require(a18_0x394d('0xb'));const jwt=require(a18_0x394d('0xc'));class MqttService{constructor(_0x42b9c8){this[a18_0x394d('0xd')]=_0x42b9c8;this['state']=a18_0x394d('0xe');this[a18_0x394d('0xf')]=new HttpClientService_1[(a18_0x394d('0x10'))]();}['init'](){this[a18_0x394d('0x11')]();}[a18_0x394d('0x12')](){console[a18_0x394d('0x13')](a18_0x394d('0x14'));const _0x5d91e7=a18_0x394d('0x15');const _0x100ee7='my-node-device';const _0x2afe81=a18_0x394d('0x16');const _0x106a12=a18_0x394d('0x17');const _0x4eb412='RS256';const _0x5d359d=a18_0x394d('0x18');const _0x12fe2d=a18_0x394d('0x19');const _0x50472e=0x1bb;const _0x41493a=a18_0x394d('0x1a');const _0x155116=0x5;const _0x1c3203=a18_0x394d('0x1b')+_0x5d91e7+a18_0x394d('0x1c')+_0x106a12+a18_0x394d('0x1d')+_0x2afe81+a18_0x394d('0x1e')+_0x100ee7;const _0x1d1088={'host':_0x12fe2d,'port':_0x50472e,'clientId':_0x1c3203,'username':a18_0x394d('0x1f'),'password':this[a18_0x394d('0x20')](_0x5d91e7,_0x5d359d,_0x4eb412),'protocol':a18_0x394d('0x21'),'secureProtocol':a18_0x394d('0x22')};const _0xc6935f=Math['round'](Date[a18_0x394d('0x23')]()/0x3e8);const _0x494299=mqtt['connect'](_0x1d1088);_0x494299[a18_0x394d('0x24')](a18_0x394d('0x1e')+_0x100ee7+a18_0x394d('0x25'),{'qos':0x1});_0x494299[a18_0x394d('0x24')]('/devices/'+_0x100ee7+'/state',{'qos':0x1});_0x494299[a18_0x394d('0x24')](a18_0x394d('0x1e')+_0x100ee7+a18_0x394d('0x26'),{'qos':0x0});const _0x21b6d1='/devices/'+_0x100ee7+'/'+_0x41493a;_0x494299['on'](a18_0x394d('0x27'),_0x1f0969=>{console[a18_0x394d('0x13')](a18_0x394d('0x27'));if(!_0x1f0969){console[a18_0x394d('0x13')]('Client\x20not\x20connected...');}else{const _0x21b6d1='/projects/velvety-glazing-252020/topics/my-topic';const _0x476fd1=_0x2afe81+'/'+_0x100ee7+'-payload-0';_0x494299['publish'](_0x21b6d1,_0x476fd1,{'qos':0x1},_0xcd3c2=>{console[a18_0x394d('0x13')](a18_0x394d('0x28'));console['log'](_0xcd3c2);if(!_0xcd3c2){}});}});_0x494299['on'](a18_0x394d('0x29'),()=>{console['log'](a18_0x394d('0x29'));});_0x494299['on'](a18_0x394d('0x2a'),_0x292187=>{console['log'](a18_0x394d('0x2a'),_0x292187);});_0x494299['on'](a18_0x394d('0x2b'),(_0x57e0da,_0x4d24f5)=>{let _0x6fb1ed=a18_0x394d('0x2c');console['log'](_0x57e0da);console[a18_0x394d('0x13')](_0x4d24f5+'');if(_0x57e0da===a18_0x394d('0x1e')+_0x100ee7+a18_0x394d('0x25')){_0x6fb1ed=a18_0x394d('0x2d');}else if(_0x57e0da['startsWith'](a18_0x394d('0x1e')+_0x100ee7+a18_0x394d('0x2e'))){_0x6fb1ed='Command\x20message\x20received:\x20';}_0x6fb1ed+=Buffer[a18_0x394d('0x2f')](_0x4d24f5,a18_0x394d('0x30'))[a18_0x394d('0x31')]('ascii');console[a18_0x394d('0x13')](_0x6fb1ed);});_0x494299['on']('packetsend',()=>{});console[a18_0x394d('0x13')](_0x1d1088);}[a18_0x394d('0x11')](){console[a18_0x394d('0x13')](a18_0x394d('0x14'));this[a18_0x394d('0x32')]=uuidv4();console[a18_0x394d('0x13')](a18_0x394d('0x33'));console[a18_0x394d('0x13')](this[a18_0x394d('0x32')]);const _0xc83597={'clientId':this[a18_0x394d('0x32')],'username':'lulo_mqtt','password':'run.lulo_2018#.','clean':!![]};this[a18_0x394d('0x34')]=mqtt[a18_0x394d('0x27')](a18_0x394d('0x35'),_0xc83597);this[a18_0x394d('0x34')]['on'](a18_0x394d('0x27'),this[a18_0x394d('0x36')][a18_0x394d('0x37')](this));this[a18_0x394d('0x34')]['on'](a18_0x394d('0x2b'),this[a18_0x394d('0x38')][a18_0x394d('0x37')](this));this[a18_0x394d('0x34')]['on'](a18_0x394d('0x29'),()=>{console[a18_0x394d('0x13')](a18_0x394d('0x29'));});process['on']('exit',this['handleAppExit']['bind'](this));process['on']('SIGINT',this[a18_0x394d('0x39')][a18_0x394d('0x37')](this));process['on'](a18_0x394d('0x3a'),this[a18_0x394d('0x39')][a18_0x394d('0x37')](this));}[a18_0x394d('0x36')](){console[a18_0x394d('0x13')]('Connected\x20to\x20broker\x20client:'+this[a18_0x394d('0x32')]);this['mqttClient'][a18_0x394d('0x24')]('player/open');this[a18_0x394d('0x34')][a18_0x394d('0x24')](a18_0x394d('0x3b'));this[a18_0x394d('0x34')][a18_0x394d('0x24')](a18_0x394d('0x3c'),{'qos':0x2});this[a18_0x394d('0x34')][a18_0x394d('0x24')](a18_0x394d('0x3d'),{'qos':0x2});this[a18_0x394d('0x34')][a18_0x394d('0x24')]('player/reload_playlist',{'qos':0x2});this[a18_0x394d('0x34')][a18_0x394d('0x24')](a18_0x394d('0x3e'),{'qos':0x2});this[a18_0x394d('0x34')][a18_0x394d('0x24')](a18_0x394d('0x3f'),{'qos':0x2});this[a18_0x394d('0x34')][a18_0x394d('0x24')]('player/register',{'qos':0x2});}['reportStatus'](){}[a18_0x394d('0x38')](_0x4cd440,_0x46c47c){console[a18_0x394d('0x13')](a18_0x394d('0x40'),_0x4cd440,_0x46c47c);switch(_0x4cd440){case a18_0x394d('0x41'):return this['handleOpenRequest'](_0x46c47c);case a18_0x394d('0x3b'):return this[a18_0x394d('0x42')](_0x46c47c);case a18_0x394d('0x3c'):return this[a18_0x394d('0x43')](_0x46c47c);case a18_0x394d('0x44'):return this['handleReloadPlaylistRequest'](_0x46c47c);case a18_0x394d('0x3d'):return this['handleLoadPlaylistRequest'](_0x46c47c);case a18_0x394d('0x3e'):return this[a18_0x394d('0x45')](_0x46c47c);case a18_0x394d('0x3f'):return this[a18_0x394d('0x46')](_0x46c47c);case'player/register':return this[a18_0x394d('0x47')](_0x46c47c);}}['handleRegisterRequest'](_0x38280d){if(_0x38280d==a18_0x394d('0x48')||_0x38280d==String(this['syncPlaylistsService']['playerId'])){this[a18_0x394d('0xd')]['registerClient']();}}['handleIfconfigRequest'](_0x58b670){if(_0x58b670==a18_0x394d('0x48')||_0x58b670==String(this['syncPlaylistsService'][a18_0x394d('0x49')])){}}[a18_0x394d('0x45')](_0x1e1b7b){console[a18_0x394d('0x13')]('handleUpdateRequest:\x20'+_0x1e1b7b);if(_0x1e1b7b=='all'||_0x1e1b7b==String(this[a18_0x394d('0xd')][a18_0x394d('0x49')])){const _0x168651=__dirname;const _0x28f830=require(a18_0x394d('0x4a'))(_0x168651);console[a18_0x394d('0x13')](a18_0x394d('0x4b'));_0x28f830[a18_0x394d('0x4c')]((_0x43b435,_0x341346)=>{if(_0x43b435){console[a18_0x394d('0x13')](a18_0x394d('0x4d'));this['handleUpdateRequest'](_0x1e1b7b);return;}else{}console['log'](a18_0x394d('0x4e'));console[a18_0x394d('0x13')](_0x341346);if(_0x341346&&_0x341346[a18_0x394d('0x4f')][a18_0x394d('0x50')]){const _0x57e8d0=spawn(a18_0x394d('0x51'),['-r','now']);}else{}});}}[a18_0x394d('0x52')](_0x11ebd7){if(_0x11ebd7=='all'||_0x11ebd7==String(this['syncPlaylistsService']['playerId'])){this[a18_0x394d('0xd')]['loadMediaList']();}}[a18_0x394d('0x53')](_0x5eeb64){if(String(_0x5eeb64)==a18_0x394d('0x48')||String(_0x5eeb64)==String(this['syncPlaylistsService'][a18_0x394d('0x49')])){this['syncPlaylistsService'][a18_0x394d('0x54')]();}}[a18_0x394d('0x43')](_0x456a1d){if(_0x456a1d==a18_0x394d('0x48')||_0x456a1d==String(this['syncPlaylistsService'][a18_0x394d('0x49')])){console[a18_0x394d('0x13')]('handleRebootRequest\x20shutdown\x20-r\x20now:\x20');try{exec('sudo\x20/sbin/shutdown\x20-r\x20now',function(_0x159dae){console['log'](_0x159dae);});}catch(_0x5f2223){console[a18_0x394d('0x13')](_0x5f2223);}}}[a18_0x394d('0x55')](){console['log'](a18_0x394d('0x56'),this[a18_0x394d('0x57')]);this['mqttClient'][a18_0x394d('0x58')](a18_0x394d('0x59'),this[a18_0x394d('0xd')][a18_0x394d('0x49')]+'-'+this['state']);}[a18_0x394d('0x5a')](_0x3e5904){if(this[a18_0x394d('0x57')]!==a18_0x394d('0x5b')&&this['state']!==a18_0x394d('0x5c')){console[a18_0x394d('0x13')]('opening\x20player\x20door');this['state']=a18_0x394d('0x5c');this['sendStateUpdate']();setTimeout(()=>{this[a18_0x394d('0x57')]='open';this[a18_0x394d('0x55')]();},0x1388);}}['handleCloseRequest'](_0x4a7749){if(this[a18_0x394d('0x57')]!==a18_0x394d('0xe')&&this[a18_0x394d('0x57')]!==a18_0x394d('0x5d')){this[a18_0x394d('0x57')]=a18_0x394d('0x5d');this[a18_0x394d('0x55')]();setTimeout(()=>{this['state']=a18_0x394d('0xe');this[a18_0x394d('0x55')]();},0x1388);}}[a18_0x394d('0x39')](_0x4a2b3f,_0x51c9ae){if(_0x51c9ae){console['log'](_0x51c9ae['stack']);}this[a18_0x394d('0x34')][a18_0x394d('0x58')](a18_0x394d('0x5e'),a18_0x394d('0x5f'));}['createJwt'](_0x349dca,_0x470c57,_0x4c6baf){const _0x1506c8={'iat':Math[a18_0x394d('0x60')](Date['now']()/0x3e8),'exp':Math[a18_0x394d('0x60')](Date[a18_0x394d('0x23')]()/0x3e8)+0x14*0x3c,'aud':_0x349dca};const _0x2df178=fs['readFileSync'](_0x470c57);return jwt[a18_0x394d('0x61')](_0x1506c8,_0x2df178,{'algorithm':_0x4c6baf});}}exports[a18_0x394d('0x62')]=MqttService;