var a20_0x1359=['opening','opening\x20player\x20door','closing','stack','player/connected','readFileSync','__esModule','fs-extra','request-progress','child_process','spawn','exec','string-template','mqtt','uuid/v4','jsonwebtoken','state','closed','httpClientService','HttpClientService','init','mqttInit_mosquitto','mqttInit_google','log','velvety-glazing-252020','my-node-device','my-registry','us-central1','resources/keys/rsa_private.pem','mqtt.googleapis.com','/locations/','/devices/','unused','createJwt','mqtts','round','now','connect','subscribe','/config','/state','/commands/#','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','publish\x20result:','close','error','message','Message\x20received:\x20','Config\x20message\x20received:\x20','startsWith','/commands','from','toString','ascii','packetsend','mqttInit','clientId','this.clientId','lulo_mqtt','run.lulo_2018#.','mqttClient','mqttClient_connect','bind','exit','handleAppExit','SIGINT','uncaughtException','Connected\x20to\x20broker\x20client:','player/open','player/close','player/load_playlist','player/reload_playlist','player/update_settings','player/turn_off_tv','player/turn_on_tv','reportStatus','mqttClient_message','handleCloseRequest','handleRebootRequest','handleLoadPlaylistRequest','player/update','handleUpdateRequest','player/ifconfig','handleIfconfigRequest','handleRegisterRequest','handleTurnOnTVRequest','all','playerId','registerClient','syncPlaylistsService','handleUpdateRequest:\x20','pull','Error\x20git\x20updated','Git\x20updated','changes','reboot','handleReloadPlaylistRequest','reloadMediaList','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','handleUpdateSettingsRequest','handleUpdateSettingsRequest:\x20','updateSettings','handleTurnOnTVRequest:\x20','turnOnTV','handleTurnOffTVRequest','handleTurnOffTVRequest:\x20','turnOffTV','sendStateUpdate','sending\x20state\x20%s','open'];(function(_0x4069bb,_0x280326){var _0x4becb4=function(_0x430ee3){while(--_0x430ee3){_0x4069bb['push'](_0x4069bb['shift']());}};_0x4becb4(++_0x280326);}(a20_0x1359,0x77));var a20_0x31da=function(_0x46b1d8,_0x18e84a){_0x46b1d8=_0x46b1d8-0x0;var _0x15dfac=a20_0x1359[_0x46b1d8];return _0x15dfac;};'use strict';Object['defineProperty'](exports,a20_0x31da('0x0'),{'value':!![]});const HttpClientService_1=require('./../infrastructure/HttpClientService');const fs=require('fs');const fsExtra=require(a20_0x31da('0x1'));const request=require('request');const progress=require(a20_0x31da('0x2'));const spawn=require(a20_0x31da('0x3'))[a20_0x31da('0x4')];const exec=require(a20_0x31da('0x3'))[a20_0x31da('0x5')];const isImage=require('is-image');const format=require(a20_0x31da('0x6'));const os=require('os');const mqtt=require(a20_0x31da('0x7'));const uuidv4=require(a20_0x31da('0x8'));const jwt=require(a20_0x31da('0x9'));class MqttService{constructor(_0x2d32a2){this['syncPlaylistsService']=_0x2d32a2;this[a20_0x31da('0xa')]=a20_0x31da('0xb');this[a20_0x31da('0xc')]=new HttpClientService_1[(a20_0x31da('0xd'))]();}[a20_0x31da('0xe')](){this[a20_0x31da('0xf')]();}[a20_0x31da('0x10')](){console[a20_0x31da('0x11')]('mqttInit');const _0x6e1772=a20_0x31da('0x12');const _0x332e9b=a20_0x31da('0x13');const _0xa49385=a20_0x31da('0x14');const _0x3fecf6=a20_0x31da('0x15');const _0x52197c='RS256';const _0x342dc6=a20_0x31da('0x16');const _0x2eb7c9=a20_0x31da('0x17');const _0x260b6a=0x1bb;const _0x20c0a8='events';const _0x9e6316=0x5;const _0x59a8cb='projects/'+_0x6e1772+a20_0x31da('0x18')+_0x3fecf6+'/registries/'+_0xa49385+a20_0x31da('0x19')+_0x332e9b;const _0x5925e9={'host':_0x2eb7c9,'port':_0x260b6a,'clientId':_0x59a8cb,'username':a20_0x31da('0x1a'),'password':this[a20_0x31da('0x1b')](_0x6e1772,_0x342dc6,_0x52197c),'protocol':a20_0x31da('0x1c'),'secureProtocol':'TLSv1_2_method'};const _0x8b7c05=Math[a20_0x31da('0x1d')](Date[a20_0x31da('0x1e')]()/0x3e8);const _0x3ca22d=mqtt[a20_0x31da('0x1f')](_0x5925e9);_0x3ca22d[a20_0x31da('0x20')](a20_0x31da('0x19')+_0x332e9b+a20_0x31da('0x21'),{'qos':0x1});_0x3ca22d[a20_0x31da('0x20')](a20_0x31da('0x19')+_0x332e9b+a20_0x31da('0x22'),{'qos':0x1});_0x3ca22d[a20_0x31da('0x20')](a20_0x31da('0x19')+_0x332e9b+a20_0x31da('0x23'),{'qos':0x0});const _0x1d5744=a20_0x31da('0x19')+_0x332e9b+'/'+_0x20c0a8;_0x3ca22d['on'](a20_0x31da('0x1f'),_0x381ae4=>{console['log'](a20_0x31da('0x1f'));if(!_0x381ae4){console['log'](a20_0x31da('0x24'));}else{const _0x1d5744=a20_0x31da('0x25');const _0x18efca=_0xa49385+'/'+_0x332e9b+a20_0x31da('0x26');_0x3ca22d[a20_0x31da('0x27')](_0x1d5744,_0x18efca,{'qos':0x1},_0x17c48d=>{console[a20_0x31da('0x11')](a20_0x31da('0x28'));console[a20_0x31da('0x11')](_0x17c48d);if(!_0x17c48d){}});}});_0x3ca22d['on'](a20_0x31da('0x29'),()=>{console['log'](a20_0x31da('0x29'));});_0x3ca22d['on']('error',_0x311061=>{console[a20_0x31da('0x11')](a20_0x31da('0x2a'),_0x311061);});_0x3ca22d['on'](a20_0x31da('0x2b'),(_0xf57e47,_0x51b195)=>{let _0x33d844=a20_0x31da('0x2c');console['log'](_0xf57e47);console[a20_0x31da('0x11')](_0x51b195+'');if(_0xf57e47===a20_0x31da('0x19')+_0x332e9b+a20_0x31da('0x21')){_0x33d844=a20_0x31da('0x2d');}else if(_0xf57e47[a20_0x31da('0x2e')](a20_0x31da('0x19')+_0x332e9b+a20_0x31da('0x2f'))){_0x33d844='Command\x20message\x20received:\x20';}_0x33d844+=Buffer[a20_0x31da('0x30')](_0x51b195,'base64')[a20_0x31da('0x31')](a20_0x31da('0x32'));console[a20_0x31da('0x11')](_0x33d844);});_0x3ca22d['on'](a20_0x31da('0x33'),()=>{});console[a20_0x31da('0x11')](_0x5925e9);}[a20_0x31da('0xf')](){console[a20_0x31da('0x11')](a20_0x31da('0x34'));this[a20_0x31da('0x35')]=uuidv4();console['log'](a20_0x31da('0x36'));console['log'](this[a20_0x31da('0x35')]);const _0x536dc8={'clientId':this[a20_0x31da('0x35')],'username':a20_0x31da('0x37'),'password':a20_0x31da('0x38'),'clean':!![]};this['mqttClient']=mqtt['connect']('mqtt://lulo.run',_0x536dc8);this[a20_0x31da('0x39')]['on']('connect',this[a20_0x31da('0x3a')]['bind'](this));this[a20_0x31da('0x39')]['on']('message',this['mqttClient_message'][a20_0x31da('0x3b')](this));this[a20_0x31da('0x39')]['on'](a20_0x31da('0x29'),()=>{console[a20_0x31da('0x11')](a20_0x31da('0x29'));});process['on'](a20_0x31da('0x3c'),this[a20_0x31da('0x3d')][a20_0x31da('0x3b')](this));process['on'](a20_0x31da('0x3e'),this[a20_0x31da('0x3d')][a20_0x31da('0x3b')](this));process['on'](a20_0x31da('0x3f'),this['handleAppExit'][a20_0x31da('0x3b')](this));}[a20_0x31da('0x3a')](){console['log'](a20_0x31da('0x40')+this[a20_0x31da('0x35')]);this[a20_0x31da('0x39')][a20_0x31da('0x20')](a20_0x31da('0x41'));this[a20_0x31da('0x39')]['subscribe'](a20_0x31da('0x42'));this[a20_0x31da('0x39')][a20_0x31da('0x20')]('player/reboot',{'qos':0x2});this[a20_0x31da('0x39')]['subscribe'](a20_0x31da('0x43'),{'qos':0x2});this[a20_0x31da('0x39')][a20_0x31da('0x20')](a20_0x31da('0x44'),{'qos':0x2});this[a20_0x31da('0x39')][a20_0x31da('0x20')]('player/update',{'qos':0x2});this[a20_0x31da('0x39')][a20_0x31da('0x20')]('player/ifconfig',{'qos':0x2});this[a20_0x31da('0x39')]['subscribe']('player/register',{'qos':0x2});this['mqttClient'][a20_0x31da('0x20')](a20_0x31da('0x45'),{'qos':0x2});this[a20_0x31da('0x39')][a20_0x31da('0x20')](a20_0x31da('0x46'),{'qos':0x2});this[a20_0x31da('0x39')][a20_0x31da('0x20')](a20_0x31da('0x47'),{'qos':0x2});}[a20_0x31da('0x48')](){}[a20_0x31da('0x49')](_0x587854,_0x304131){console['log']('received\x20message\x20%s\x20%s',_0x587854,_0x304131);switch(_0x587854){case a20_0x31da('0x41'):return this['handleOpenRequest'](_0x304131);case'player/close':return this[a20_0x31da('0x4a')](_0x304131);case'player/reboot':return this[a20_0x31da('0x4b')](_0x304131);case'player/reload_playlist':return this['handleReloadPlaylistRequest'](_0x304131);case'player/load_playlist':return this[a20_0x31da('0x4c')](_0x304131);case a20_0x31da('0x4d'):return this[a20_0x31da('0x4e')](_0x304131);case a20_0x31da('0x4f'):return this[a20_0x31da('0x50')](_0x304131);case'player/register':return this[a20_0x31da('0x51')](_0x304131);case a20_0x31da('0x45'):return this['handleUpdateSettingsRequest'](_0x304131);case a20_0x31da('0x46'):return this['handleTurnOffTVRequest'](_0x304131);case a20_0x31da('0x47'):return this[a20_0x31da('0x52')](_0x304131);}}[a20_0x31da('0x51')](_0x3a5ef8){if(_0x3a5ef8==a20_0x31da('0x53')||_0x3a5ef8==String(this['syncPlaylistsService'][a20_0x31da('0x54')])){this['syncPlaylistsService'][a20_0x31da('0x55')]();}}['handleIfconfigRequest'](_0x23b67d){if(_0x23b67d=='all'||_0x23b67d==String(this[a20_0x31da('0x56')]['playerId'])){}}['handleUpdateRequest'](_0x2f1535){console[a20_0x31da('0x11')](a20_0x31da('0x57')+_0x2f1535);if(_0x2f1535==a20_0x31da('0x53')||_0x2f1535==String(this[a20_0x31da('0x56')][a20_0x31da('0x54')])){const _0x33e399=__dirname;const _0x2042d5=require('simple-git')(_0x33e399);console['log']('Git\x20updating');_0x2042d5[a20_0x31da('0x58')]((_0x453b81,_0x220990)=>{if(_0x453b81){console[a20_0x31da('0x11')](a20_0x31da('0x59'));this[a20_0x31da('0x4e')](_0x2f1535);return;}else{}console['log'](a20_0x31da('0x5a'));console[a20_0x31da('0x11')](_0x220990);if(_0x220990&&_0x220990['summary'][a20_0x31da('0x5b')]){this[a20_0x31da('0x56')][a20_0x31da('0x5c')]();}else{}});}}[a20_0x31da('0x4c')](_0x470964){if(_0x470964==a20_0x31da('0x53')||_0x470964==String(this[a20_0x31da('0x56')][a20_0x31da('0x54')])){this[a20_0x31da('0x56')]['loadMediaList']();}}[a20_0x31da('0x5d')](_0x13dfe2){if(String(_0x13dfe2)==a20_0x31da('0x53')||String(_0x13dfe2)==String(this[a20_0x31da('0x56')][a20_0x31da('0x54')])){this[a20_0x31da('0x56')][a20_0x31da('0x5e')]();}}['handleRebootRequest'](_0x8c89cf){if(_0x8c89cf=='all'||_0x8c89cf==String(this['syncPlaylistsService'][a20_0x31da('0x54')])){console[a20_0x31da('0x11')](a20_0x31da('0x5f'));try{this[a20_0x31da('0x56')][a20_0x31da('0x5c')]();}catch(_0x3c97ec){console['log'](_0x3c97ec);}}}[a20_0x31da('0x60')](_0x22570e){if(_0x22570e==a20_0x31da('0x53')||_0x22570e==String(this[a20_0x31da('0x56')][a20_0x31da('0x54')])){console[a20_0x31da('0x11')](a20_0x31da('0x61'));try{this[a20_0x31da('0x56')][a20_0x31da('0x62')]();}catch(_0x345bbe){console['log'](_0x345bbe);}}}['handleTurnOnTVRequest'](_0x349f76){if(_0x349f76==a20_0x31da('0x53')||_0x349f76==String(this['syncPlaylistsService']['playerId'])){console[a20_0x31da('0x11')](a20_0x31da('0x63'));try{this[a20_0x31da('0x56')][a20_0x31da('0x64')]();}catch(_0x2718a0){console[a20_0x31da('0x11')](_0x2718a0);}}}[a20_0x31da('0x65')](_0xc6600e){if(_0xc6600e=='all'||_0xc6600e==String(this['syncPlaylistsService'][a20_0x31da('0x54')])){console[a20_0x31da('0x11')](a20_0x31da('0x66'));try{this['syncPlaylistsService'][a20_0x31da('0x67')]();}catch(_0x393324){console[a20_0x31da('0x11')](_0x393324);}}}[a20_0x31da('0x68')](){console[a20_0x31da('0x11')](a20_0x31da('0x69'),this[a20_0x31da('0xa')]);this[a20_0x31da('0x39')][a20_0x31da('0x27')]('player/state',this['syncPlaylistsService']['playerId']+'-'+this[a20_0x31da('0xa')]);}['handleOpenRequest'](_0x4c234e){if(this['state']!==a20_0x31da('0x6a')&&this[a20_0x31da('0xa')]!==a20_0x31da('0x6b')){console[a20_0x31da('0x11')](a20_0x31da('0x6c'));this[a20_0x31da('0xa')]=a20_0x31da('0x6b');this[a20_0x31da('0x68')]();setTimeout(()=>{this[a20_0x31da('0xa')]=a20_0x31da('0x6a');this[a20_0x31da('0x68')]();},0x1388);}}[a20_0x31da('0x4a')](_0x1948fa){if(this[a20_0x31da('0xa')]!==a20_0x31da('0xb')&&this['state']!==a20_0x31da('0x6d')){this[a20_0x31da('0xa')]='closing';this[a20_0x31da('0x68')]();setTimeout(()=>{this[a20_0x31da('0xa')]=a20_0x31da('0xb');this[a20_0x31da('0x68')]();},0x1388);}}[a20_0x31da('0x3d')](_0x45175e,_0x32e515){if(_0x32e515){console['log'](_0x32e515[a20_0x31da('0x6e')]);}this[a20_0x31da('0x39')][a20_0x31da('0x27')](a20_0x31da('0x6f'),'false');}[a20_0x31da('0x1b')](_0x53c7fe,_0x66b155,_0x3ac186){const _0xa86ee2={'iat':Math['round'](Date[a20_0x31da('0x1e')]()/0x3e8),'exp':Math[a20_0x31da('0x1d')](Date[a20_0x31da('0x1e')]()/0x3e8)+0x14*0x3c,'aud':_0x53c7fe};const _0x4c9d85=fs[a20_0x31da('0x70')](_0x66b155);return jwt['sign'](_0xa86ee2,_0x4c9d85,{'algorithm':_0x3ac186});}}exports['MqttService']=MqttService;