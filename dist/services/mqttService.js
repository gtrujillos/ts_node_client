var a18_0x5190=['playerId','handleUpdateRequest:\x20','Git\x20updating','pull','Error\x20git\x20updated','Git\x20updated','changes','shutdown','loadMediaList','handleReloadPlaylistRequest','handleRebootRequest','sudo','reboot','sendStateUpdate','sending\x20state\x20%s','state','handleOpenRequest','opening\x20player\x20door','opening','open','closing','stack','false','defineProperty','__esModule','./../infrastructure/HttpClientService','fs-extra','request','request-progress','child_process','spawn','is-image','string-template','mqtt','uuid/v4','jsonwebtoken','syncPlaylistsService','closed','httpClientService','HttpClientService','init','mqttInit_google','velvety-glazing-252020','my-node-device','my-registry','us-central1','RS256','mqtt.googleapis.com','projects/','/locations/','/registries/','unused','createJwt','TLSv1_2_method','round','now','connect','subscribe','/devices/','/state','log','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','close','Message\x20received:\x20','/config','from','toString','ascii','packetsend','mqttInit_mosquitto','clientId','lulo_mqtt','mqttClient','mqtt://lulo.run','bind','mqttClient_message','exit','handleAppExit','SIGINT','uncaughtException','mqttClient_connect','Connected\x20to\x20broker\x20client:','player/open','player/close','player/reboot','player/load_playlist','player/update','player/register','reportStatus','handleCloseRequest','player/reload_playlist','handleLoadPlaylistRequest','handleUpdateRequest','player/ifconfig','handleIfconfigRequest','handleRegisterRequest','all','registerClient'];(function(_0x398d08,_0xcfdc0f){var _0x41facc=function(_0x4bb01b){while(--_0x4bb01b){_0x398d08['push'](_0x398d08['shift']());}};_0x41facc(++_0xcfdc0f);}(a18_0x5190,0x1ab));var a18_0x1d76=function(_0x25f5e9,_0x1abe8c){_0x25f5e9=_0x25f5e9-0x0;var _0x278661=a18_0x5190[_0x25f5e9];return _0x278661;};'use strict';Object[a18_0x1d76('0x0')](exports,a18_0x1d76('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x1d76('0x2'));const fs=require('fs');const fsExtra=require(a18_0x1d76('0x3'));const request=require(a18_0x1d76('0x4'));const progress=require(a18_0x1d76('0x5'));const spawn=require(a18_0x1d76('0x6'))[a18_0x1d76('0x7')];const isImage=require(a18_0x1d76('0x8'));const format=require(a18_0x1d76('0x9'));const os=require('os');const mqtt=require(a18_0x1d76('0xa'));const uuidv4=require(a18_0x1d76('0xb'));const jwt=require(a18_0x1d76('0xc'));class MqttService{constructor(_0x2880e1){this[a18_0x1d76('0xd')]=_0x2880e1;this['state']=a18_0x1d76('0xe');this[a18_0x1d76('0xf')]=new HttpClientService_1[(a18_0x1d76('0x10'))]();}[a18_0x1d76('0x11')](){this['mqttInit_mosquitto']();}[a18_0x1d76('0x12')](){console['log']('mqttInit');const _0x308ebb=a18_0x1d76('0x13');const _0x2199b5=a18_0x1d76('0x14');const _0x2c3b70=a18_0x1d76('0x15');const _0x4f7511=a18_0x1d76('0x16');const _0x2fdd33=a18_0x1d76('0x17');const _0x44d4c6='resources/keys/rsa_private.pem';const _0x15eb76=a18_0x1d76('0x18');const _0x39dc7d=0x1bb;const _0x1d5a87='events';const _0x1368bf=0x5;const _0x1e723a=a18_0x1d76('0x19')+_0x308ebb+a18_0x1d76('0x1a')+_0x4f7511+a18_0x1d76('0x1b')+_0x2c3b70+'/devices/'+_0x2199b5;const _0x131214={'host':_0x15eb76,'port':_0x39dc7d,'clientId':_0x1e723a,'username':a18_0x1d76('0x1c'),'password':this[a18_0x1d76('0x1d')](_0x308ebb,_0x44d4c6,_0x2fdd33),'protocol':'mqtts','secureProtocol':a18_0x1d76('0x1e')};const _0x175d25=Math[a18_0x1d76('0x1f')](Date[a18_0x1d76('0x20')]()/0x3e8);const _0x533081=mqtt[a18_0x1d76('0x21')](_0x131214);_0x533081[a18_0x1d76('0x22')](a18_0x1d76('0x23')+_0x2199b5+'/config',{'qos':0x1});_0x533081[a18_0x1d76('0x22')](a18_0x1d76('0x23')+_0x2199b5+a18_0x1d76('0x24'),{'qos':0x1});_0x533081[a18_0x1d76('0x22')](a18_0x1d76('0x23')+_0x2199b5+'/commands/#',{'qos':0x0});const _0x2e2aa3=a18_0x1d76('0x23')+_0x2199b5+'/'+_0x1d5a87;_0x533081['on'](a18_0x1d76('0x21'),_0x53a350=>{console['log'](a18_0x1d76('0x21'));if(!_0x53a350){console[a18_0x1d76('0x25')](a18_0x1d76('0x26'));}else{const _0x2e2aa3=a18_0x1d76('0x27');const _0x1882b9=_0x2c3b70+'/'+_0x2199b5+a18_0x1d76('0x28');_0x533081[a18_0x1d76('0x29')](_0x2e2aa3,_0x1882b9,{'qos':0x1},_0x2ef717=>{console[a18_0x1d76('0x25')]('publish\x20result:');console[a18_0x1d76('0x25')](_0x2ef717);if(!_0x2ef717){}});}});_0x533081['on'](a18_0x1d76('0x2a'),()=>{console[a18_0x1d76('0x25')]('close');});_0x533081['on']('error',_0x118766=>{console[a18_0x1d76('0x25')]('error',_0x118766);});_0x533081['on']('message',(_0x294c8e,_0xe1b50b)=>{let _0x237e6d=a18_0x1d76('0x2b');console['log'](_0x294c8e);console['log'](_0xe1b50b+'');if(_0x294c8e==='/devices/'+_0x2199b5+a18_0x1d76('0x2c')){_0x237e6d='Config\x20message\x20received:\x20';}else if(_0x294c8e['startsWith']('/devices/'+_0x2199b5+'/commands')){_0x237e6d='Command\x20message\x20received:\x20';}_0x237e6d+=Buffer[a18_0x1d76('0x2d')](_0xe1b50b,'base64')[a18_0x1d76('0x2e')](a18_0x1d76('0x2f'));console[a18_0x1d76('0x25')](_0x237e6d);});_0x533081['on'](a18_0x1d76('0x30'),()=>{});console['log'](_0x131214);}[a18_0x1d76('0x31')](){console[a18_0x1d76('0x25')]('mqttInit');this[a18_0x1d76('0x32')]=uuidv4();console['log']('this.clientId');console['log'](this['clientId']);const _0x1bd1b3={'clientId':this['clientId'],'username':a18_0x1d76('0x33'),'password':'run.lulo_2018#.','clean':!![]};this[a18_0x1d76('0x34')]=mqtt[a18_0x1d76('0x21')](a18_0x1d76('0x35'),_0x1bd1b3);this[a18_0x1d76('0x34')]['on'](a18_0x1d76('0x21'),this['mqttClient_connect'][a18_0x1d76('0x36')](this));this['mqttClient']['on']('message',this[a18_0x1d76('0x37')][a18_0x1d76('0x36')](this));this[a18_0x1d76('0x34')]['on'](a18_0x1d76('0x2a'),()=>{console[a18_0x1d76('0x25')](a18_0x1d76('0x2a'));});process['on'](a18_0x1d76('0x38'),this[a18_0x1d76('0x39')][a18_0x1d76('0x36')](this));process['on'](a18_0x1d76('0x3a'),this[a18_0x1d76('0x39')]['bind'](this));process['on'](a18_0x1d76('0x3b'),this[a18_0x1d76('0x39')][a18_0x1d76('0x36')](this));}[a18_0x1d76('0x3c')](){console[a18_0x1d76('0x25')](a18_0x1d76('0x3d')+this[a18_0x1d76('0x32')]);this[a18_0x1d76('0x34')][a18_0x1d76('0x22')](a18_0x1d76('0x3e'));this[a18_0x1d76('0x34')][a18_0x1d76('0x22')](a18_0x1d76('0x3f'));this[a18_0x1d76('0x34')]['subscribe'](a18_0x1d76('0x40'),{'qos':0x2});this[a18_0x1d76('0x34')][a18_0x1d76('0x22')](a18_0x1d76('0x41'),{'qos':0x2});this[a18_0x1d76('0x34')][a18_0x1d76('0x22')]('player/reload_playlist',{'qos':0x2});this['mqttClient']['subscribe'](a18_0x1d76('0x42'),{'qos':0x2});this[a18_0x1d76('0x34')]['subscribe']('player/ifconfig',{'qos':0x2});this[a18_0x1d76('0x34')][a18_0x1d76('0x22')](a18_0x1d76('0x43'),{'qos':0x2});}[a18_0x1d76('0x44')](){}['mqttClient_message'](_0x117330,_0x4010ac){console[a18_0x1d76('0x25')]('received\x20message\x20%s\x20%s',_0x117330,_0x4010ac);switch(_0x117330){case'player/open':return this['handleOpenRequest'](_0x4010ac);case'player/close':return this[a18_0x1d76('0x45')](_0x4010ac);case a18_0x1d76('0x40'):return this['handleRebootRequest'](_0x4010ac);case a18_0x1d76('0x46'):return this['handleReloadPlaylistRequest'](_0x4010ac);case'player/load_playlist':return this[a18_0x1d76('0x47')](_0x4010ac);case a18_0x1d76('0x42'):return this[a18_0x1d76('0x48')](_0x4010ac);case a18_0x1d76('0x49'):return this[a18_0x1d76('0x4a')](_0x4010ac);case a18_0x1d76('0x43'):return this['handleRegisterRequest'](_0x4010ac);}}[a18_0x1d76('0x4b')](_0x580101){if(_0x580101==a18_0x1d76('0x4c')||_0x580101==String(this[a18_0x1d76('0xd')]['playerId'])){this['syncPlaylistsService'][a18_0x1d76('0x4d')]();}}[a18_0x1d76('0x4a')](_0x42a1f7){if(_0x42a1f7==a18_0x1d76('0x4c')||_0x42a1f7==String(this[a18_0x1d76('0xd')][a18_0x1d76('0x4e')])){}}[a18_0x1d76('0x48')](_0x18d120){console[a18_0x1d76('0x25')](a18_0x1d76('0x4f')+_0x18d120);if(_0x18d120==a18_0x1d76('0x4c')||_0x18d120==String(this[a18_0x1d76('0xd')][a18_0x1d76('0x4e')])){const _0x2cc70e=__dirname;const _0xf87c3e=require('simple-git')(_0x2cc70e);console[a18_0x1d76('0x25')](a18_0x1d76('0x50'));_0xf87c3e[a18_0x1d76('0x51')]((_0x58a2a1,_0x371791)=>{if(_0x58a2a1){console[a18_0x1d76('0x25')](a18_0x1d76('0x52'));this[a18_0x1d76('0x48')](_0x18d120);return;}else{}console[a18_0x1d76('0x25')](a18_0x1d76('0x53'));console[a18_0x1d76('0x25')](_0x371791);if(_0x371791&&_0x371791['summary'][a18_0x1d76('0x54')]){const _0x105c0f=spawn(a18_0x1d76('0x55'),['-r',a18_0x1d76('0x20')]);}else{}});}}[a18_0x1d76('0x47')](_0x4fd051){if(_0x4fd051==a18_0x1d76('0x4c')||_0x4fd051==String(this[a18_0x1d76('0xd')][a18_0x1d76('0x4e')])){this['syncPlaylistsService'][a18_0x1d76('0x56')]();}}[a18_0x1d76('0x57')](_0x276d42){if(String(_0x276d42)==a18_0x1d76('0x4c')||String(_0x276d42)==String(this['syncPlaylistsService'][a18_0x1d76('0x4e')])){this[a18_0x1d76('0xd')]['reloadMediaList']();}}['handleRebootRequest'](_0x4dcce0){if(_0x4dcce0==a18_0x1d76('0x4c')||_0x4dcce0==String(this[a18_0x1d76('0xd')][a18_0x1d76('0x4e')])){console['log'](a18_0x1d76('0x58'));try{const _0x125348=spawn(a18_0x1d76('0x59'),[a18_0x1d76('0x5a')]);}catch(_0x335365){console[a18_0x1d76('0x25')](_0x335365);}}}[a18_0x1d76('0x5b')](){console['log'](a18_0x1d76('0x5c'),this['state']);this[a18_0x1d76('0x34')][a18_0x1d76('0x29')]('player/state',this[a18_0x1d76('0xd')][a18_0x1d76('0x4e')]+'-'+this[a18_0x1d76('0x5d')]);}[a18_0x1d76('0x5e')](_0x348ef7){if(this[a18_0x1d76('0x5d')]!=='open'&&this[a18_0x1d76('0x5d')]!=='opening'){console['log'](a18_0x1d76('0x5f'));this[a18_0x1d76('0x5d')]=a18_0x1d76('0x60');this[a18_0x1d76('0x5b')]();setTimeout(()=>{this[a18_0x1d76('0x5d')]=a18_0x1d76('0x61');this[a18_0x1d76('0x5b')]();},0x1388);}}[a18_0x1d76('0x45')](_0x32be48){if(this[a18_0x1d76('0x5d')]!=='closed'&&this[a18_0x1d76('0x5d')]!==a18_0x1d76('0x62')){this[a18_0x1d76('0x5d')]='closing';this[a18_0x1d76('0x5b')]();setTimeout(()=>{this['state']=a18_0x1d76('0xe');this['sendStateUpdate']();},0x1388);}}[a18_0x1d76('0x39')](_0x59780d,_0x23ea56){if(_0x23ea56){console['log'](_0x23ea56[a18_0x1d76('0x63')]);}this['mqttClient'][a18_0x1d76('0x29')]('player/connected',a18_0x1d76('0x64'));}['createJwt'](_0xf2457e,_0x517ff8,_0x4e4db5){const _0x57097b={'iat':Math['round'](Date[a18_0x1d76('0x20')]()/0x3e8),'exp':Math[a18_0x1d76('0x1f')](Date['now']()/0x3e8)+0x14*0x3c,'aud':_0xf2457e};const _0x338adb=fs['readFileSync'](_0x517ff8);return jwt['sign'](_0x57097b,_0x338adb,{'algorithm':_0x4e4db5});}}exports['MqttService']=MqttService;