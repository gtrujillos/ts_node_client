var a18_0x4a9d=['error','message','Message\x20received:\x20','startsWith','/commands','Command\x20message\x20received:\x20','from','toString','packetsend','this.clientId','clientId','lulo_mqtt','run.lulo_2018#.','mqttClient','mqtt://lulo.run','mqttClient_connect','bind','mqttClient_message','handleAppExit','SIGINT','player/close','player/reboot','player/load_playlist','player/reload_playlist','player/ifconfig','player/register','reportStatus','received\x20message\x20%s\x20%s','player/open','handleOpenRequest','handleCloseRequest','handleRebootRequest','handleLoadPlaylistRequest','player/update','handleUpdateRequest','handleIfconfigRequest','syncPlaylistsService','playerId','registerClient','all','handleUpdateRequest:\x20','Git\x20updating','pull','Error\x20git\x20updated','Git\x20updated','summary','shutdown','loadMediaList','handleReloadPlaylistRequest','reloadMediaList','sendStateUpdate','sending\x20state\x20%s','publish','player/state','open','opening','closing','stack','player/connected','false','readFileSync','sign','MqttService','defineProperty','__esModule','./../infrastructure/HttpClientService','request-progress','child_process','is-image','mqtt','uuid/v4','jsonwebtoken','state','closed','httpClientService','HttpClientService','init','mqttInit_google','log','velvety-glazing-252020','my-node-device','my-registry','us-central1','mqtt.googleapis.com','projects/','/locations/','/registries/','/devices/','createJwt','mqtts','round','now','subscribe','/config','/state','/commands/#','connect','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish\x20result:','close'];(function(_0x10e34b,_0x171a00){var _0x3505f5=function(_0x22b5e2){while(--_0x22b5e2){_0x10e34b['push'](_0x10e34b['shift']());}};_0x3505f5(++_0x171a00);}(a18_0x4a9d,0x10b));var a18_0x4ee2=function(_0x4ec993,_0x23604d){_0x4ec993=_0x4ec993-0x0;var _0x56d704=a18_0x4a9d[_0x4ec993];return _0x56d704;};'use strict';Object[a18_0x4ee2('0x0')](exports,a18_0x4ee2('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x4ee2('0x2'));const fs=require('fs');const fsExtra=require('fs-extra');const request=require('request');const progress=require(a18_0x4ee2('0x3'));const spawn=require(a18_0x4ee2('0x4'))['spawn'];const isImage=require(a18_0x4ee2('0x5'));const format=require('string-template');const os=require('os');const mqtt=require(a18_0x4ee2('0x6'));const uuidv4=require(a18_0x4ee2('0x7'));const jwt=require(a18_0x4ee2('0x8'));class MqttService{constructor(_0x45fd23){this['syncPlaylistsService']=_0x45fd23;this[a18_0x4ee2('0x9')]=a18_0x4ee2('0xa');this[a18_0x4ee2('0xb')]=new HttpClientService_1[(a18_0x4ee2('0xc'))]();}[a18_0x4ee2('0xd')](){this['mqttInit_mosquitto']();}[a18_0x4ee2('0xe')](){console[a18_0x4ee2('0xf')]('mqttInit');const _0x35d7b9=a18_0x4ee2('0x10');const _0x1ed89a=a18_0x4ee2('0x11');const _0x38541a=a18_0x4ee2('0x12');const _0x29a174=a18_0x4ee2('0x13');const _0x4153d9='RS256';const _0xd2aa09='resources/keys/rsa_private.pem';const _0xfc7cce=a18_0x4ee2('0x14');const _0x3dc97a=0x1bb;const _0x50b140='events';const _0x3a6ca3=0x5;const _0x56ccd9=a18_0x4ee2('0x15')+_0x35d7b9+a18_0x4ee2('0x16')+_0x29a174+a18_0x4ee2('0x17')+_0x38541a+a18_0x4ee2('0x18')+_0x1ed89a;const _0x311c86={'host':_0xfc7cce,'port':_0x3dc97a,'clientId':_0x56ccd9,'username':'unused','password':this[a18_0x4ee2('0x19')](_0x35d7b9,_0xd2aa09,_0x4153d9),'protocol':a18_0x4ee2('0x1a'),'secureProtocol':'TLSv1_2_method'};const _0x448fda=Math[a18_0x4ee2('0x1b')](Date[a18_0x4ee2('0x1c')]()/0x3e8);const _0x4889f4=mqtt['connect'](_0x311c86);_0x4889f4[a18_0x4ee2('0x1d')](a18_0x4ee2('0x18')+_0x1ed89a+a18_0x4ee2('0x1e'),{'qos':0x1});_0x4889f4[a18_0x4ee2('0x1d')](a18_0x4ee2('0x18')+_0x1ed89a+a18_0x4ee2('0x1f'),{'qos':0x1});_0x4889f4[a18_0x4ee2('0x1d')](a18_0x4ee2('0x18')+_0x1ed89a+a18_0x4ee2('0x20'),{'qos':0x0});const _0x59eac3='/devices/'+_0x1ed89a+'/'+_0x50b140;_0x4889f4['on'](a18_0x4ee2('0x21'),_0x31b4a6=>{console[a18_0x4ee2('0xf')](a18_0x4ee2('0x21'));if(!_0x31b4a6){console[a18_0x4ee2('0xf')](a18_0x4ee2('0x22'));}else{const _0x59eac3=a18_0x4ee2('0x23');const _0x21e22f=_0x38541a+'/'+_0x1ed89a+a18_0x4ee2('0x24');_0x4889f4['publish'](_0x59eac3,_0x21e22f,{'qos':0x1},_0x3038c0=>{console[a18_0x4ee2('0xf')](a18_0x4ee2('0x25'));console[a18_0x4ee2('0xf')](_0x3038c0);if(!_0x3038c0){}});}});_0x4889f4['on'](a18_0x4ee2('0x26'),()=>{console[a18_0x4ee2('0xf')](a18_0x4ee2('0x26'));});_0x4889f4['on'](a18_0x4ee2('0x27'),_0x204826=>{console[a18_0x4ee2('0xf')]('error',_0x204826);});_0x4889f4['on'](a18_0x4ee2('0x28'),(_0x5ea4e8,_0x4d93dc)=>{let _0x3f0f65=a18_0x4ee2('0x29');console['log'](_0x5ea4e8);console['log'](_0x4d93dc+'');if(_0x5ea4e8===a18_0x4ee2('0x18')+_0x1ed89a+'/config'){_0x3f0f65='Config\x20message\x20received:\x20';}else if(_0x5ea4e8[a18_0x4ee2('0x2a')](a18_0x4ee2('0x18')+_0x1ed89a+a18_0x4ee2('0x2b'))){_0x3f0f65=a18_0x4ee2('0x2c');}_0x3f0f65+=Buffer[a18_0x4ee2('0x2d')](_0x4d93dc,'base64')[a18_0x4ee2('0x2e')]('ascii');console[a18_0x4ee2('0xf')](_0x3f0f65);});_0x4889f4['on'](a18_0x4ee2('0x2f'),()=>{});console['log'](_0x311c86);}['mqttInit_mosquitto'](){console['log']('mqttInit');this['clientId']=uuidv4();console[a18_0x4ee2('0xf')](a18_0x4ee2('0x30'));console[a18_0x4ee2('0xf')](this[a18_0x4ee2('0x31')]);const _0x34fd82={'clientId':this[a18_0x4ee2('0x31')],'username':a18_0x4ee2('0x32'),'password':a18_0x4ee2('0x33'),'clean':!![]};this[a18_0x4ee2('0x34')]=mqtt[a18_0x4ee2('0x21')](a18_0x4ee2('0x35'),_0x34fd82);this[a18_0x4ee2('0x34')]['on'](a18_0x4ee2('0x21'),this[a18_0x4ee2('0x36')][a18_0x4ee2('0x37')](this));this['mqttClient']['on'](a18_0x4ee2('0x28'),this[a18_0x4ee2('0x38')][a18_0x4ee2('0x37')](this));this[a18_0x4ee2('0x34')]['on'](a18_0x4ee2('0x26'),()=>{console[a18_0x4ee2('0xf')](a18_0x4ee2('0x26'));});process['on']('exit',this[a18_0x4ee2('0x39')][a18_0x4ee2('0x37')](this));process['on'](a18_0x4ee2('0x3a'),this[a18_0x4ee2('0x39')][a18_0x4ee2('0x37')](this));process['on']('uncaughtException',this[a18_0x4ee2('0x39')]['bind'](this));}[a18_0x4ee2('0x36')](){console[a18_0x4ee2('0xf')]('Connected\x20to\x20broker\x20client:'+this[a18_0x4ee2('0x31')]);this[a18_0x4ee2('0x34')]['subscribe']('player/open');this[a18_0x4ee2('0x34')][a18_0x4ee2('0x1d')](a18_0x4ee2('0x3b'));this[a18_0x4ee2('0x34')][a18_0x4ee2('0x1d')](a18_0x4ee2('0x3c'),{'qos':0x2});this['mqttClient'][a18_0x4ee2('0x1d')](a18_0x4ee2('0x3d'),{'qos':0x2});this[a18_0x4ee2('0x34')][a18_0x4ee2('0x1d')](a18_0x4ee2('0x3e'),{'qos':0x2});this[a18_0x4ee2('0x34')][a18_0x4ee2('0x1d')]('player/update',{'qos':0x2});this[a18_0x4ee2('0x34')][a18_0x4ee2('0x1d')](a18_0x4ee2('0x3f'),{'qos':0x2});this[a18_0x4ee2('0x34')][a18_0x4ee2('0x1d')](a18_0x4ee2('0x40'),{'qos':0x2});}[a18_0x4ee2('0x41')](){}['mqttClient_message'](_0x405b24,_0x376114){console[a18_0x4ee2('0xf')](a18_0x4ee2('0x42'),_0x405b24,_0x376114);switch(_0x405b24){case a18_0x4ee2('0x43'):return this[a18_0x4ee2('0x44')](_0x376114);case a18_0x4ee2('0x3b'):return this[a18_0x4ee2('0x45')](_0x376114);case a18_0x4ee2('0x3c'):return this[a18_0x4ee2('0x46')](_0x376114);case'player/reload_playlist':return this['handleReloadPlaylistRequest'](_0x376114);case'player/load_playlist':return this[a18_0x4ee2('0x47')](_0x376114);case a18_0x4ee2('0x48'):return this[a18_0x4ee2('0x49')](_0x376114);case a18_0x4ee2('0x3f'):return this[a18_0x4ee2('0x4a')](_0x376114);case a18_0x4ee2('0x40'):return this['handleRegisterRequest'](_0x376114);}}['handleRegisterRequest'](_0x3d296a){if(_0x3d296a=='all'||_0x3d296a==String(this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4c')])){this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4d')]();}}['handleIfconfigRequest'](_0x470379){if(_0x470379==a18_0x4ee2('0x4e')||_0x470379==String(this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4c')])){}}[a18_0x4ee2('0x49')](_0x26838d){console[a18_0x4ee2('0xf')](a18_0x4ee2('0x4f')+_0x26838d);if(_0x26838d==a18_0x4ee2('0x4e')||_0x26838d==String(this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4c')])){const _0x39f147=__dirname;const _0x444b9f=require('simple-git')(_0x39f147);console[a18_0x4ee2('0xf')](a18_0x4ee2('0x50'));_0x444b9f[a18_0x4ee2('0x51')]((_0x4bcac7,_0x575022)=>{if(_0x4bcac7){console[a18_0x4ee2('0xf')](a18_0x4ee2('0x52'));this[a18_0x4ee2('0x49')](_0x26838d);return;}else{}console[a18_0x4ee2('0xf')](a18_0x4ee2('0x53'));console[a18_0x4ee2('0xf')](_0x575022);if(_0x575022&&_0x575022[a18_0x4ee2('0x54')]['changes']){const _0x459605=spawn(a18_0x4ee2('0x55'),['-r',a18_0x4ee2('0x1c')]);}else{}});}}[a18_0x4ee2('0x47')](_0x157375){if(_0x157375==a18_0x4ee2('0x4e')||_0x157375==String(this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4c')])){this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x56')]();}}[a18_0x4ee2('0x57')](_0x1b166c){if(String(_0x1b166c)==a18_0x4ee2('0x4e')||String(_0x1b166c)==String(this['syncPlaylistsService'][a18_0x4ee2('0x4c')])){this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x58')]();}}['handleRebootRequest'](_0x304620){if(_0x304620=='all'||_0x304620==String(this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4c')])){console[a18_0x4ee2('0xf')](a18_0x4ee2('0x46'));try{const _0x20b3e6=spawn('reboot');}catch(_0x1cce6a){console[a18_0x4ee2('0xf')](_0x1cce6a);}}}[a18_0x4ee2('0x59')](){console['log'](a18_0x4ee2('0x5a'),this['state']);this[a18_0x4ee2('0x34')][a18_0x4ee2('0x5b')](a18_0x4ee2('0x5c'),this[a18_0x4ee2('0x4b')][a18_0x4ee2('0x4c')]+'-'+this[a18_0x4ee2('0x9')]);}[a18_0x4ee2('0x44')](_0x8bf5ad){if(this[a18_0x4ee2('0x9')]!==a18_0x4ee2('0x5d')&&this['state']!==a18_0x4ee2('0x5e')){console[a18_0x4ee2('0xf')]('opening\x20player\x20door');this[a18_0x4ee2('0x9')]=a18_0x4ee2('0x5e');this[a18_0x4ee2('0x59')]();setTimeout(()=>{this['state']='open';this['sendStateUpdate']();},0x1388);}}[a18_0x4ee2('0x45')](_0x3ca5a3){if(this[a18_0x4ee2('0x9')]!==a18_0x4ee2('0xa')&&this['state']!=='closing'){this[a18_0x4ee2('0x9')]=a18_0x4ee2('0x5f');this[a18_0x4ee2('0x59')]();setTimeout(()=>{this['state']='closed';this[a18_0x4ee2('0x59')]();},0x1388);}}[a18_0x4ee2('0x39')](_0x35fff2,_0xbff0b5){if(_0xbff0b5){console['log'](_0xbff0b5[a18_0x4ee2('0x60')]);}this[a18_0x4ee2('0x34')][a18_0x4ee2('0x5b')](a18_0x4ee2('0x61'),a18_0x4ee2('0x62'));}[a18_0x4ee2('0x19')](_0x192519,_0x55c38e,_0x33f8d7){const _0x36e263={'iat':Math[a18_0x4ee2('0x1b')](Date[a18_0x4ee2('0x1c')]()/0x3e8),'exp':Math[a18_0x4ee2('0x1b')](Date[a18_0x4ee2('0x1c')]()/0x3e8)+0x14*0x3c,'aud':_0x192519};const _0x2e8b13=fs[a18_0x4ee2('0x63')](_0x55c38e);return jwt[a18_0x4ee2('0x64')](_0x36e263,_0x2e8b13,{'algorithm':_0x33f8d7});}}exports[a18_0x4ee2('0x65')]=MqttService;