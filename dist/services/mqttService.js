var a18_0x477a=['__esModule','fs-extra','child_process','spawn','is-image','string-template','mqtt','uuid/v4','jsonwebtoken','syncPlaylistsService','state','closed','httpClientService','HttpClientService','mqttInit_mosquitto','mqttInit_google','log','mqttInit','velvety-glazing-252020','my-node-device','my-registry','us-central1','RS256','resources/keys/rsa_private.pem','mqtt.googleapis.com','projects/','/devices/','mqtts','TLSv1_2_method','round','now','connect','subscribe','/config','/state','/commands/#','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','publish\x20result:','close','error','Message\x20received:\x20','Config\x20message\x20received:\x20','/commands','Command\x20message\x20received:\x20','base64','toString','ascii','packetsend','clientId','this.clientId','lulo_mqtt','run.lulo_2018#.','mqttClient','bind','exit','handleAppExit','SIGINT','uncaughtException','mqttClient_connect','Connected\x20to\x20broker\x20client:','player/close','player/reboot','player/load_playlist','player/reload_playlist','player/update','player/register','player/update_settings','reportStatus','received\x20message\x20%s\x20%s','player/open','handleOpenRequest','handleRebootRequest','handleLoadPlaylistRequest','handleIfconfigRequest','handleRegisterRequest','handleUpdateSettingsRequest','handleTurnOnTVRequest','player/turn_off_tv','all','playerId','registerClient','handleUpdateRequest','handleUpdateRequest:\x20','simple-git','hard','reset\x20err:','clean','clean\x20result:','pull','Error\x20git\x20updated','summary','changes','reboot','Git\x20no\x20changes','reloadMediaList','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','updateSettings','handleTurnOffTVRequest:\x20','handleTurnOnTVRequest:\x20','turnOnTV','sendStateUpdate','sending\x20state\x20%s','player/state','open','opening','opening\x20player\x20door','closing','stack','player/connected','false','createJwt','readFileSync','sign','MqttService','defineProperty'];(function(_0x184acb,_0x15aff2){var _0x53da28=function(_0x25299e){while(--_0x25299e){_0x184acb['push'](_0x184acb['shift']());}};_0x53da28(++_0x15aff2);}(a18_0x477a,0xeb));var a18_0x2f23=function(_0xdf9bd1,_0x49ac01){_0xdf9bd1=_0xdf9bd1-0x0;var _0xf145c0=a18_0x477a[_0xdf9bd1];return _0xf145c0;};'use strict';Object[a18_0x2f23('0x0')](exports,a18_0x2f23('0x1'),{'value':!![]});const HttpClientService_1=require('./../infrastructure/HttpClientService');const fs=require('fs');const fsExtra=require(a18_0x2f23('0x2'));const request=require('request');const progress=require('request-progress');const spawn=require(a18_0x2f23('0x3'))[a18_0x2f23('0x4')];const exec=require(a18_0x2f23('0x3'))['exec'];const isImage=require(a18_0x2f23('0x5'));const format=require(a18_0x2f23('0x6'));const os=require('os');const mqtt=require(a18_0x2f23('0x7'));const uuidv4=require(a18_0x2f23('0x8'));const jwt=require(a18_0x2f23('0x9'));class MqttService{constructor(_0x40f587){this[a18_0x2f23('0xa')]=_0x40f587;this[a18_0x2f23('0xb')]=a18_0x2f23('0xc');this[a18_0x2f23('0xd')]=new HttpClientService_1[(a18_0x2f23('0xe'))]();}['init'](){this[a18_0x2f23('0xf')]();}[a18_0x2f23('0x10')](){console[a18_0x2f23('0x11')](a18_0x2f23('0x12'));const _0x50d731=a18_0x2f23('0x13');const _0x4d3b70=a18_0x2f23('0x14');const _0x285bff=a18_0x2f23('0x15');const _0x3ec17f=a18_0x2f23('0x16');const _0x3c5918=a18_0x2f23('0x17');const _0x55c55d=a18_0x2f23('0x18');const _0x539790=a18_0x2f23('0x19');const _0x54c09e=0x1bb;const _0x4148fa='events';const _0x43c977=0x5;const _0x5042f4=a18_0x2f23('0x1a')+_0x50d731+'/locations/'+_0x3ec17f+'/registries/'+_0x285bff+a18_0x2f23('0x1b')+_0x4d3b70;const _0x1d27e9={'host':_0x539790,'port':_0x54c09e,'clientId':_0x5042f4,'username':'unused','password':this['createJwt'](_0x50d731,_0x55c55d,_0x3c5918),'protocol':a18_0x2f23('0x1c'),'secureProtocol':a18_0x2f23('0x1d')};const _0x29ae1d=Math[a18_0x2f23('0x1e')](Date[a18_0x2f23('0x1f')]()/0x3e8);const _0x2ada58=mqtt[a18_0x2f23('0x20')](_0x1d27e9);_0x2ada58[a18_0x2f23('0x21')](a18_0x2f23('0x1b')+_0x4d3b70+a18_0x2f23('0x22'),{'qos':0x1});_0x2ada58[a18_0x2f23('0x21')](a18_0x2f23('0x1b')+_0x4d3b70+a18_0x2f23('0x23'),{'qos':0x1});_0x2ada58[a18_0x2f23('0x21')]('/devices/'+_0x4d3b70+a18_0x2f23('0x24'),{'qos':0x0});const _0x173c60=a18_0x2f23('0x1b')+_0x4d3b70+'/'+_0x4148fa;_0x2ada58['on'](a18_0x2f23('0x20'),_0x3abdc6=>{console[a18_0x2f23('0x11')](a18_0x2f23('0x20'));if(!_0x3abdc6){console[a18_0x2f23('0x11')](a18_0x2f23('0x25'));}else{const _0x173c60=a18_0x2f23('0x26');const _0x538102=_0x285bff+'/'+_0x4d3b70+a18_0x2f23('0x27');_0x2ada58[a18_0x2f23('0x28')](_0x173c60,_0x538102,{'qos':0x1},_0x50df31=>{console[a18_0x2f23('0x11')](a18_0x2f23('0x29'));console['log'](_0x50df31);if(!_0x50df31){}});}});_0x2ada58['on'](a18_0x2f23('0x2a'),()=>{console[a18_0x2f23('0x11')](a18_0x2f23('0x2a'));});_0x2ada58['on'](a18_0x2f23('0x2b'),_0x15a8ba=>{console[a18_0x2f23('0x11')](a18_0x2f23('0x2b'),_0x15a8ba);});_0x2ada58['on']('message',(_0x359b15,_0x1e9cda)=>{let _0x2ae2d1=a18_0x2f23('0x2c');console[a18_0x2f23('0x11')](_0x359b15);console['log'](_0x1e9cda+'');if(_0x359b15===a18_0x2f23('0x1b')+_0x4d3b70+a18_0x2f23('0x22')){_0x2ae2d1=a18_0x2f23('0x2d');}else if(_0x359b15['startsWith'](a18_0x2f23('0x1b')+_0x4d3b70+a18_0x2f23('0x2e'))){_0x2ae2d1=a18_0x2f23('0x2f');}_0x2ae2d1+=Buffer['from'](_0x1e9cda,a18_0x2f23('0x30'))[a18_0x2f23('0x31')](a18_0x2f23('0x32'));console[a18_0x2f23('0x11')](_0x2ae2d1);});_0x2ada58['on'](a18_0x2f23('0x33'),()=>{});console[a18_0x2f23('0x11')](_0x1d27e9);}['mqttInit_mosquitto'](){console['log'](a18_0x2f23('0x12'));this[a18_0x2f23('0x34')]=uuidv4();console['log'](a18_0x2f23('0x35'));console[a18_0x2f23('0x11')](this['clientId']);const _0x181e78={'clientId':this[a18_0x2f23('0x34')],'username':a18_0x2f23('0x36'),'password':a18_0x2f23('0x37'),'clean':!![]};this[a18_0x2f23('0x38')]=mqtt['connect']('mqtt://lulo.run',_0x181e78);this[a18_0x2f23('0x38')]['on'](a18_0x2f23('0x20'),this['mqttClient_connect'][a18_0x2f23('0x39')](this));this[a18_0x2f23('0x38')]['on']('message',this['mqttClient_message'][a18_0x2f23('0x39')](this));this['mqttClient']['on']('close',()=>{console[a18_0x2f23('0x11')](a18_0x2f23('0x2a'));});process['on'](a18_0x2f23('0x3a'),this[a18_0x2f23('0x3b')][a18_0x2f23('0x39')](this));process['on'](a18_0x2f23('0x3c'),this['handleAppExit'][a18_0x2f23('0x39')](this));process['on'](a18_0x2f23('0x3d'),this[a18_0x2f23('0x3b')][a18_0x2f23('0x39')](this));}[a18_0x2f23('0x3e')](){console[a18_0x2f23('0x11')](a18_0x2f23('0x3f')+this['clientId']);this['mqttClient'][a18_0x2f23('0x21')]('player/open');this[a18_0x2f23('0x38')][a18_0x2f23('0x21')](a18_0x2f23('0x40'));this[a18_0x2f23('0x38')][a18_0x2f23('0x21')](a18_0x2f23('0x41'),{'qos':0x2});this[a18_0x2f23('0x38')][a18_0x2f23('0x21')](a18_0x2f23('0x42'),{'qos':0x2});this['mqttClient'][a18_0x2f23('0x21')](a18_0x2f23('0x43'),{'qos':0x2});this['mqttClient']['subscribe'](a18_0x2f23('0x44'),{'qos':0x2});this['mqttClient'][a18_0x2f23('0x21')]('player/ifconfig',{'qos':0x2});this[a18_0x2f23('0x38')][a18_0x2f23('0x21')](a18_0x2f23('0x45'),{'qos':0x2});this[a18_0x2f23('0x38')][a18_0x2f23('0x21')](a18_0x2f23('0x46'),{'qos':0x2});}[a18_0x2f23('0x47')](){}['mqttClient_message'](_0x2b1221,_0x2f77e4){console['log'](a18_0x2f23('0x48'),_0x2b1221,_0x2f77e4);switch(_0x2b1221){case a18_0x2f23('0x49'):return this[a18_0x2f23('0x4a')](_0x2f77e4);case'player/close':return this['handleCloseRequest'](_0x2f77e4);case a18_0x2f23('0x41'):return this[a18_0x2f23('0x4b')](_0x2f77e4);case'player/reload_playlist':return this['handleReloadPlaylistRequest'](_0x2f77e4);case a18_0x2f23('0x42'):return this[a18_0x2f23('0x4c')](_0x2f77e4);case a18_0x2f23('0x44'):return this['handleUpdateRequest'](_0x2f77e4);case'player/ifconfig':return this[a18_0x2f23('0x4d')](_0x2f77e4);case a18_0x2f23('0x45'):return this[a18_0x2f23('0x4e')](_0x2f77e4);case a18_0x2f23('0x46'):return this[a18_0x2f23('0x4f')](_0x2f77e4);case'player/turn_on_tv':return this[a18_0x2f23('0x50')](_0x2f77e4);case a18_0x2f23('0x51'):return this['handleTurnOffTVRequest'](_0x2f77e4);}}['handleRegisterRequest'](_0x29b68f){if(_0x29b68f==a18_0x2f23('0x52')||_0x29b68f==String(this['syncPlaylistsService'][a18_0x2f23('0x53')])){this['syncPlaylistsService'][a18_0x2f23('0x54')]();}}[a18_0x2f23('0x4d')](_0xed7f34){if(_0xed7f34==a18_0x2f23('0x52')||_0xed7f34==String(this['syncPlaylistsService']['playerId'])){}}[a18_0x2f23('0x55')](_0x5d608c){console[a18_0x2f23('0x11')](a18_0x2f23('0x56')+_0x5d608c);if(_0x5d608c==a18_0x2f23('0x52')||_0x5d608c==String(this['syncPlaylistsService'][a18_0x2f23('0x53')])){const _0x2d20f8=__dirname;const _0x2d785b=require(a18_0x2f23('0x57'))(_0x2d20f8);console[a18_0x2f23('0x11')]('Git\x20updating');_0x2d785b['reset'](a18_0x2f23('0x58'),(_0x1463a6,_0x337627)=>{console[a18_0x2f23('0x11')](a18_0x2f23('0x59')+_0x1463a6);_0x2d785b[a18_0x2f23('0x5a')]('f',(_0x1463a6,_0x337627)=>{console['log'](a18_0x2f23('0x5b')+_0x1463a6);_0x2d785b[a18_0x2f23('0x5c')]((_0x1463a6,_0x4f2375)=>{if(_0x1463a6){console[a18_0x2f23('0x11')](a18_0x2f23('0x5d'));this[a18_0x2f23('0x55')](_0x5d608c);return;}else{}console[a18_0x2f23('0x11')]('Git\x20updated');console[a18_0x2f23('0x11')](_0x4f2375);if(_0x4f2375&&_0x4f2375[a18_0x2f23('0x5e')][a18_0x2f23('0x5f')]){this['syncPlaylistsService'][a18_0x2f23('0x60')]();}else{console[a18_0x2f23('0x11')](a18_0x2f23('0x61'));}});});});}}[a18_0x2f23('0x4c')](_0x3af145){if(_0x3af145=='all'||_0x3af145==String(this['syncPlaylistsService']['playerId'])){this[a18_0x2f23('0xa')]['loadMediaList']();}}['handleReloadPlaylistRequest'](_0x2cb952){if(String(_0x2cb952)==a18_0x2f23('0x52')||String(_0x2cb952)==String(this[a18_0x2f23('0xa')][a18_0x2f23('0x53')])){this[a18_0x2f23('0xa')][a18_0x2f23('0x62')]();}}[a18_0x2f23('0x4b')](_0x554682){if(_0x554682==a18_0x2f23('0x52')||_0x554682==String(this[a18_0x2f23('0xa')][a18_0x2f23('0x53')])){console[a18_0x2f23('0x11')](a18_0x2f23('0x63'));try{this[a18_0x2f23('0xa')]['reboot']();}catch(_0x50b877){console[a18_0x2f23('0x11')](_0x50b877);}}}[a18_0x2f23('0x4f')](_0xd87237){if(_0xd87237==a18_0x2f23('0x52')||_0xd87237==String(this[a18_0x2f23('0xa')]['playerId'])){console[a18_0x2f23('0x11')]('handleUpdateSettingsRequest:\x20');try{this[a18_0x2f23('0xa')][a18_0x2f23('0x64')]();}catch(_0x5ec4d7){console[a18_0x2f23('0x11')](_0x5ec4d7);}}}['handleTurnOffTVRequest'](_0x2b6175){if(_0x2b6175==a18_0x2f23('0x52')||_0x2b6175==String(this[a18_0x2f23('0xa')]['playerId'])){console[a18_0x2f23('0x11')](a18_0x2f23('0x65'));try{this['syncPlaylistsService']['turnOffTV']();}catch(_0x2d7023){console[a18_0x2f23('0x11')](_0x2d7023);}}}[a18_0x2f23('0x50')](_0x1147a8){if(_0x1147a8==a18_0x2f23('0x52')||_0x1147a8==String(this[a18_0x2f23('0xa')][a18_0x2f23('0x53')])){console[a18_0x2f23('0x11')](a18_0x2f23('0x66'));try{this[a18_0x2f23('0xa')][a18_0x2f23('0x67')]();}catch(_0x39b0d8){console[a18_0x2f23('0x11')](_0x39b0d8);}}}[a18_0x2f23('0x68')](){console['log'](a18_0x2f23('0x69'),this['state']);this[a18_0x2f23('0x38')][a18_0x2f23('0x28')](a18_0x2f23('0x6a'),this[a18_0x2f23('0xa')][a18_0x2f23('0x53')]+'-'+this['state']);}[a18_0x2f23('0x4a')](_0x5d37a4){if(this[a18_0x2f23('0xb')]!==a18_0x2f23('0x6b')&&this[a18_0x2f23('0xb')]!==a18_0x2f23('0x6c')){console[a18_0x2f23('0x11')](a18_0x2f23('0x6d'));this[a18_0x2f23('0xb')]=a18_0x2f23('0x6c');this[a18_0x2f23('0x68')]();setTimeout(()=>{this[a18_0x2f23('0xb')]=a18_0x2f23('0x6b');this[a18_0x2f23('0x68')]();},0x1388);}}['handleCloseRequest'](_0x49b30b){if(this[a18_0x2f23('0xb')]!==a18_0x2f23('0xc')&&this[a18_0x2f23('0xb')]!==a18_0x2f23('0x6e')){this[a18_0x2f23('0xb')]=a18_0x2f23('0x6e');this[a18_0x2f23('0x68')]();setTimeout(()=>{this[a18_0x2f23('0xb')]=a18_0x2f23('0xc');this[a18_0x2f23('0x68')]();},0x1388);}}[a18_0x2f23('0x3b')](_0x5b4921,_0x2a171d){if(_0x2a171d){console['log'](_0x2a171d[a18_0x2f23('0x6f')]);}this[a18_0x2f23('0x38')][a18_0x2f23('0x28')](a18_0x2f23('0x70'),a18_0x2f23('0x71'));}[a18_0x2f23('0x72')](_0x3e6b33,_0x117072,_0x51d850){const _0x53ad4b={'iat':Math[a18_0x2f23('0x1e')](Date['now']()/0x3e8),'exp':Math[a18_0x2f23('0x1e')](Date[a18_0x2f23('0x1f')]()/0x3e8)+0x14*0x3c,'aud':_0x3e6b33};const _0x57a68f=fs[a18_0x2f23('0x73')](_0x117072);return jwt[a18_0x2f23('0x74')](_0x53ad4b,_0x57a68f,{'algorithm':_0x51d850});}}exports[a18_0x2f23('0x75')]=MqttService;