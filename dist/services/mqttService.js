var a18_0x4e66=['all','playerId','registerClient','handleUpdateRequest:\x20','simple-git','reset','hard','reset\x20err:','pull','Error\x20git\x20updated','Git\x20updated','summary','changes','reloadMediaList','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','handleUpdateSettingsRequest:\x20','updateSettings','handleTurnOffTVRequest:\x20','turnOffTV','handleTurnOnTVRequest','handleTurnOnTVRequest:\x20','turnOnTV','sendStateUpdate','sending\x20state\x20%s','player/state','open','opening','closing','stack','now','readFileSync','sign','MqttService','defineProperty','__esModule','./../infrastructure/HttpClientService','request','request-progress','child_process','spawn','exec','is-image','string-template','uuid/v4','jsonwebtoken','syncPlaylistsService','state','closed','httpClientService','HttpClientService','mqttInit_mosquitto','mqttInit_google','mqttInit','velvety-glazing-252020','my-node-device','my-registry','events','projects/','/locations/','TLSv1_2_method','round','connect','subscribe','/state','/devices/','/commands/#','log','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','-payload-0','publish','publish\x20result:','close','error','message','Config\x20message\x20received:\x20','/commands','Command\x20message\x20received:\x20','from','toString','packetsend','clientId','this.clientId','run.lulo_2018#.','mqttClient','mqtt://lulo.run','mqttClient_connect','bind','mqttClient_message','SIGINT','handleAppExit','uncaughtException','Connected\x20to\x20broker\x20client:','player/load_playlist','player/ifconfig','player/register','player/update_settings','player/open','handleCloseRequest','player/reboot','handleRebootRequest','player/reload_playlist','handleReloadPlaylistRequest','handleLoadPlaylistRequest','player/update','handleUpdateRequest','handleIfconfigRequest','handleRegisterRequest','handleUpdateSettingsRequest','player/turn_on_tv','player/turn_off_tv','handleTurnOffTVRequest'];(function(_0x217ae6,_0x2880fc){var _0x5da6f8=function(_0x386a90){while(--_0x386a90){_0x217ae6['push'](_0x217ae6['shift']());}};_0x5da6f8(++_0x2880fc);}(a18_0x4e66,0x171));var a18_0x3ab7=function(_0x50bdd5,_0x4302e0){_0x50bdd5=_0x50bdd5-0x0;var _0x655730=a18_0x4e66[_0x50bdd5];return _0x655730;};'use strict';Object[a18_0x3ab7('0x0')](exports,a18_0x3ab7('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x3ab7('0x2'));const fs=require('fs');const fsExtra=require('fs-extra');const request=require(a18_0x3ab7('0x3'));const progress=require(a18_0x3ab7('0x4'));const spawn=require(a18_0x3ab7('0x5'))[a18_0x3ab7('0x6')];const exec=require('child_process')[a18_0x3ab7('0x7')];const isImage=require(a18_0x3ab7('0x8'));const format=require(a18_0x3ab7('0x9'));const os=require('os');const mqtt=require('mqtt');const uuidv4=require(a18_0x3ab7('0xa'));const jwt=require(a18_0x3ab7('0xb'));class MqttService{constructor(_0x39db23){this[a18_0x3ab7('0xc')]=_0x39db23;this[a18_0x3ab7('0xd')]=a18_0x3ab7('0xe');this[a18_0x3ab7('0xf')]=new HttpClientService_1[(a18_0x3ab7('0x10'))]();}['init'](){this[a18_0x3ab7('0x11')]();}[a18_0x3ab7('0x12')](){console['log'](a18_0x3ab7('0x13'));const _0x19e4ac=a18_0x3ab7('0x14');const _0x359fab=a18_0x3ab7('0x15');const _0x3d050=a18_0x3ab7('0x16');const _0x1c4053='us-central1';const _0x5d25c9='RS256';const _0x4f6810='resources/keys/rsa_private.pem';const _0x48d44e='mqtt.googleapis.com';const _0x495904=0x1bb;const _0x3ed84f=a18_0x3ab7('0x17');const _0xf6f3a3=0x5;const _0xd23bfb=a18_0x3ab7('0x18')+_0x19e4ac+a18_0x3ab7('0x19')+_0x1c4053+'/registries/'+_0x3d050+'/devices/'+_0x359fab;const _0x5458e8={'host':_0x48d44e,'port':_0x495904,'clientId':_0xd23bfb,'username':'unused','password':this['createJwt'](_0x19e4ac,_0x4f6810,_0x5d25c9),'protocol':'mqtts','secureProtocol':a18_0x3ab7('0x1a')};const _0xd4eeec=Math[a18_0x3ab7('0x1b')](Date['now']()/0x3e8);const _0x46ed2e=mqtt[a18_0x3ab7('0x1c')](_0x5458e8);_0x46ed2e[a18_0x3ab7('0x1d')]('/devices/'+_0x359fab+'/config',{'qos':0x1});_0x46ed2e['subscribe']('/devices/'+_0x359fab+a18_0x3ab7('0x1e'),{'qos':0x1});_0x46ed2e[a18_0x3ab7('0x1d')](a18_0x3ab7('0x1f')+_0x359fab+a18_0x3ab7('0x20'),{'qos':0x0});const _0x3ed19f=a18_0x3ab7('0x1f')+_0x359fab+'/'+_0x3ed84f;_0x46ed2e['on'](a18_0x3ab7('0x1c'),_0xc194ed=>{console[a18_0x3ab7('0x21')](a18_0x3ab7('0x1c'));if(!_0xc194ed){console[a18_0x3ab7('0x21')](a18_0x3ab7('0x22'));}else{const _0x3ed19f=a18_0x3ab7('0x23');const _0x3e6e20=_0x3d050+'/'+_0x359fab+a18_0x3ab7('0x24');_0x46ed2e[a18_0x3ab7('0x25')](_0x3ed19f,_0x3e6e20,{'qos':0x1},_0x49f04e=>{console[a18_0x3ab7('0x21')](a18_0x3ab7('0x26'));console[a18_0x3ab7('0x21')](_0x49f04e);if(!_0x49f04e){}});}});_0x46ed2e['on'](a18_0x3ab7('0x27'),()=>{console['log'](a18_0x3ab7('0x27'));});_0x46ed2e['on'](a18_0x3ab7('0x28'),_0x44b77f=>{console[a18_0x3ab7('0x21')]('error',_0x44b77f);});_0x46ed2e['on'](a18_0x3ab7('0x29'),(_0x59d66d,_0x1b373b)=>{let _0x1cd419='Message\x20received:\x20';console[a18_0x3ab7('0x21')](_0x59d66d);console['log'](_0x1b373b+'');if(_0x59d66d===a18_0x3ab7('0x1f')+_0x359fab+'/config'){_0x1cd419=a18_0x3ab7('0x2a');}else if(_0x59d66d['startsWith'](a18_0x3ab7('0x1f')+_0x359fab+a18_0x3ab7('0x2b'))){_0x1cd419=a18_0x3ab7('0x2c');}_0x1cd419+=Buffer[a18_0x3ab7('0x2d')](_0x1b373b,'base64')[a18_0x3ab7('0x2e')]('ascii');console[a18_0x3ab7('0x21')](_0x1cd419);});_0x46ed2e['on'](a18_0x3ab7('0x2f'),()=>{});console[a18_0x3ab7('0x21')](_0x5458e8);}[a18_0x3ab7('0x11')](){console['log'](a18_0x3ab7('0x13'));this[a18_0x3ab7('0x30')]=uuidv4();console[a18_0x3ab7('0x21')](a18_0x3ab7('0x31'));console['log'](this[a18_0x3ab7('0x30')]);const _0x270d6f={'clientId':this['clientId'],'username':'lulo_mqtt','password':a18_0x3ab7('0x32'),'clean':!![]};this[a18_0x3ab7('0x33')]=mqtt[a18_0x3ab7('0x1c')](a18_0x3ab7('0x34'),_0x270d6f);this['mqttClient']['on'](a18_0x3ab7('0x1c'),this[a18_0x3ab7('0x35')][a18_0x3ab7('0x36')](this));this['mqttClient']['on'](a18_0x3ab7('0x29'),this[a18_0x3ab7('0x37')][a18_0x3ab7('0x36')](this));this['mqttClient']['on'](a18_0x3ab7('0x27'),()=>{console[a18_0x3ab7('0x21')](a18_0x3ab7('0x27'));});process['on']('exit',this['handleAppExit'][a18_0x3ab7('0x36')](this));process['on'](a18_0x3ab7('0x38'),this[a18_0x3ab7('0x39')][a18_0x3ab7('0x36')](this));process['on'](a18_0x3ab7('0x3a'),this[a18_0x3ab7('0x39')]['bind'](this));}[a18_0x3ab7('0x35')](){console[a18_0x3ab7('0x21')](a18_0x3ab7('0x3b')+this[a18_0x3ab7('0x30')]);this[a18_0x3ab7('0x33')][a18_0x3ab7('0x1d')]('player/open');this[a18_0x3ab7('0x33')]['subscribe']('player/close');this['mqttClient'][a18_0x3ab7('0x1d')]('player/reboot',{'qos':0x2});this['mqttClient'][a18_0x3ab7('0x1d')](a18_0x3ab7('0x3c'),{'qos':0x2});this[a18_0x3ab7('0x33')][a18_0x3ab7('0x1d')]('player/reload_playlist',{'qos':0x2});this[a18_0x3ab7('0x33')]['subscribe']('player/update',{'qos':0x2});this[a18_0x3ab7('0x33')][a18_0x3ab7('0x1d')](a18_0x3ab7('0x3d'),{'qos':0x2});this['mqttClient'][a18_0x3ab7('0x1d')](a18_0x3ab7('0x3e'),{'qos':0x2});this[a18_0x3ab7('0x33')][a18_0x3ab7('0x1d')](a18_0x3ab7('0x3f'),{'qos':0x2});}['reportStatus'](){}[a18_0x3ab7('0x37')](_0x163c92,_0x39244a){console[a18_0x3ab7('0x21')]('received\x20message\x20%s\x20%s',_0x163c92,_0x39244a);switch(_0x163c92){case a18_0x3ab7('0x40'):return this['handleOpenRequest'](_0x39244a);case'player/close':return this[a18_0x3ab7('0x41')](_0x39244a);case a18_0x3ab7('0x42'):return this[a18_0x3ab7('0x43')](_0x39244a);case a18_0x3ab7('0x44'):return this[a18_0x3ab7('0x45')](_0x39244a);case a18_0x3ab7('0x3c'):return this[a18_0x3ab7('0x46')](_0x39244a);case a18_0x3ab7('0x47'):return this[a18_0x3ab7('0x48')](_0x39244a);case a18_0x3ab7('0x3d'):return this[a18_0x3ab7('0x49')](_0x39244a);case a18_0x3ab7('0x3e'):return this[a18_0x3ab7('0x4a')](_0x39244a);case a18_0x3ab7('0x3f'):return this[a18_0x3ab7('0x4b')](_0x39244a);case a18_0x3ab7('0x4c'):return this['handleTurnOnTVRequest'](_0x39244a);case a18_0x3ab7('0x4d'):return this[a18_0x3ab7('0x4e')](_0x39244a);}}['handleRegisterRequest'](_0x20b126){if(_0x20b126==a18_0x3ab7('0x4f')||_0x20b126==String(this['syncPlaylistsService'][a18_0x3ab7('0x50')])){this[a18_0x3ab7('0xc')][a18_0x3ab7('0x51')]();}}['handleIfconfigRequest'](_0x21f1d0){if(_0x21f1d0==a18_0x3ab7('0x4f')||_0x21f1d0==String(this[a18_0x3ab7('0xc')][a18_0x3ab7('0x50')])){}}['handleUpdateRequest'](_0x34f7da){console[a18_0x3ab7('0x21')](a18_0x3ab7('0x52')+_0x34f7da);if(_0x34f7da=='all'||_0x34f7da==String(this['syncPlaylistsService']['playerId'])){const _0x37866a=__dirname;const _0x55599a=require(a18_0x3ab7('0x53'))(_0x37866a);console[a18_0x3ab7('0x21')]('Git\x20updating');_0x55599a[a18_0x3ab7('0x54')](a18_0x3ab7('0x55'),(_0x470838,_0x55f746)=>{console['log'](a18_0x3ab7('0x56')+_0x470838);_0x55599a['clean']('f',(_0x470838,_0x55f746)=>{console[a18_0x3ab7('0x21')]('clean\x20result:'+_0x470838);_0x55599a[a18_0x3ab7('0x57')]((_0x470838,_0x26aafc)=>{if(_0x470838){console['log'](a18_0x3ab7('0x58'));this[a18_0x3ab7('0x48')](_0x34f7da);return;}else{}console['log'](a18_0x3ab7('0x59'));console[a18_0x3ab7('0x21')](_0x26aafc);if(_0x26aafc&&_0x26aafc[a18_0x3ab7('0x5a')][a18_0x3ab7('0x5b')]){this[a18_0x3ab7('0xc')]['reboot']();}else{console['log']('Git\x20no\x20changes');}});});});}}[a18_0x3ab7('0x46')](_0x3f63f3){if(_0x3f63f3==a18_0x3ab7('0x4f')||_0x3f63f3==String(this[a18_0x3ab7('0xc')]['playerId'])){this[a18_0x3ab7('0xc')]['loadMediaList']();}}['handleReloadPlaylistRequest'](_0x5bad3f){if(String(_0x5bad3f)==a18_0x3ab7('0x4f')||String(_0x5bad3f)==String(this[a18_0x3ab7('0xc')][a18_0x3ab7('0x50')])){this[a18_0x3ab7('0xc')][a18_0x3ab7('0x5c')]();}}[a18_0x3ab7('0x43')](_0x4968ab){if(_0x4968ab==a18_0x3ab7('0x4f')||_0x4968ab==String(this[a18_0x3ab7('0xc')][a18_0x3ab7('0x50')])){console[a18_0x3ab7('0x21')](a18_0x3ab7('0x5d'));try{this[a18_0x3ab7('0xc')]['reboot']();}catch(_0x3e12d9){console[a18_0x3ab7('0x21')](_0x3e12d9);}}}['handleUpdateSettingsRequest'](_0xe1c687){if(_0xe1c687=='all'||_0xe1c687==String(this['syncPlaylistsService'][a18_0x3ab7('0x50')])){console['log'](a18_0x3ab7('0x5e'));try{this[a18_0x3ab7('0xc')][a18_0x3ab7('0x5f')]();}catch(_0xde8ee0){console[a18_0x3ab7('0x21')](_0xde8ee0);}}}[a18_0x3ab7('0x4e')](_0x18750b){if(_0x18750b==a18_0x3ab7('0x4f')||_0x18750b==String(this[a18_0x3ab7('0xc')][a18_0x3ab7('0x50')])){console[a18_0x3ab7('0x21')](a18_0x3ab7('0x60'));try{this[a18_0x3ab7('0xc')][a18_0x3ab7('0x61')]();}catch(_0x5ba8cf){console[a18_0x3ab7('0x21')](_0x5ba8cf);}}}[a18_0x3ab7('0x62')](_0x5bdfc8){if(_0x5bdfc8==a18_0x3ab7('0x4f')||_0x5bdfc8==String(this['syncPlaylistsService']['playerId'])){console['log'](a18_0x3ab7('0x63'));try{this[a18_0x3ab7('0xc')][a18_0x3ab7('0x64')]();}catch(_0x23b71b){console[a18_0x3ab7('0x21')](_0x23b71b);}}}[a18_0x3ab7('0x65')](){console[a18_0x3ab7('0x21')](a18_0x3ab7('0x66'),this[a18_0x3ab7('0xd')]);this[a18_0x3ab7('0x33')][a18_0x3ab7('0x25')](a18_0x3ab7('0x67'),this[a18_0x3ab7('0xc')][a18_0x3ab7('0x50')]+'-'+this[a18_0x3ab7('0xd')]);}['handleOpenRequest'](_0x1e32d6){if(this[a18_0x3ab7('0xd')]!==a18_0x3ab7('0x68')&&this[a18_0x3ab7('0xd')]!==a18_0x3ab7('0x69')){console[a18_0x3ab7('0x21')]('opening\x20player\x20door');this[a18_0x3ab7('0xd')]=a18_0x3ab7('0x69');this['sendStateUpdate']();setTimeout(()=>{this[a18_0x3ab7('0xd')]=a18_0x3ab7('0x68');this[a18_0x3ab7('0x65')]();},0x1388);}}[a18_0x3ab7('0x41')](_0x3ddf97){if(this[a18_0x3ab7('0xd')]!==a18_0x3ab7('0xe')&&this[a18_0x3ab7('0xd')]!==a18_0x3ab7('0x6a')){this[a18_0x3ab7('0xd')]='closing';this[a18_0x3ab7('0x65')]();setTimeout(()=>{this[a18_0x3ab7('0xd')]=a18_0x3ab7('0xe');this[a18_0x3ab7('0x65')]();},0x1388);}}[a18_0x3ab7('0x39')](_0x2c9eb0,_0x57aa2a){if(_0x57aa2a){console[a18_0x3ab7('0x21')](_0x57aa2a[a18_0x3ab7('0x6b')]);}this['mqttClient']['publish']('player/connected','false');}['createJwt'](_0x21c413,_0x5780f3,_0x167d72){const _0x1d63e={'iat':Math[a18_0x3ab7('0x1b')](Date['now']()/0x3e8),'exp':Math[a18_0x3ab7('0x1b')](Date[a18_0x3ab7('0x6c')]()/0x3e8)+0x14*0x3c,'aud':_0x21c413};const _0x3a9d99=fs[a18_0x3ab7('0x6d')](_0x5780f3);return jwt[a18_0x3ab7('0x6e')](_0x1d63e,_0x3a9d99,{'algorithm':_0x167d72});}}exports[a18_0x3ab7('0x6f')]=MqttService;