var a18_0x128e=['/registries/','/devices/','unused','now','connect','subscribe','/config','/commands/#','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','publish','publish\x20result:','close','error','Message\x20received:\x20','startsWith','/commands','Command\x20message\x20received:\x20','from','base64','toString','packetsend','this.clientId','clientId','lulo_mqtt','run.lulo_2018#.','mqttClient_connect','bind','mqttClient','message','mqttClient_message','exit','handleAppExit','uncaughtException','Connected\x20to\x20broker\x20client:','player/open','player/close','player/reboot','player/load_playlist','player/update','player/ifconfig','player/register','player/update_settings','player/turn_off_tv','player/turn_on_tv','handleOpenRequest','handleRebootRequest','player/reload_playlist','handleReloadPlaylistRequest','handleLoadPlaylistRequest','handleIfconfigRequest','handleRegisterRequest','handleUpdateSettingsRequest','handleTurnOnTVRequest','all','playerId','handleUpdateRequest:\x20','Git\x20updating','handleUpdateRequest','summary','changes','reboot','loadMediaList','reloadMediaList','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','updateSettings','handleTurnOnTVRequest:\x20','handleTurnOffTVRequest','handleTurnOffTVRequest:\x20','sendStateUpdate','sending\x20state\x20%s','player/state','state','open','opening\x20player\x20door','opening','closed','stack','player/connected','createJwt','round','sign','MqttService','defineProperty','__esModule','./../infrastructure/HttpClientService','fs-extra','request','spawn','child_process','exec','string-template','mqtt','uuid/v4','syncPlaylistsService','mqttInit_mosquitto','mqttInit_google','log','mqttInit','velvety-glazing-252020','my-node-device','us-central1','RS256','resources/keys/rsa_private.pem','mqtt.googleapis.com','projects/','/locations/'];(function(_0x4b5383,_0x4a630d){var _0x195d98=function(_0xd6f591){while(--_0xd6f591){_0x4b5383['push'](_0x4b5383['shift']());}};_0x195d98(++_0x4a630d);}(a18_0x128e,0xbe));var a18_0x2894=function(_0x6616fa,_0x46a183){_0x6616fa=_0x6616fa-0x0;var _0x275a92=a18_0x128e[_0x6616fa];return _0x275a92;};'use strict';Object[a18_0x2894('0x0')](exports,a18_0x2894('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x2894('0x2'));const fs=require('fs');const fsExtra=require(a18_0x2894('0x3'));const request=require(a18_0x2894('0x4'));const progress=require('request-progress');const spawn=require('child_process')[a18_0x2894('0x5')];const exec=require(a18_0x2894('0x6'))[a18_0x2894('0x7')];const isImage=require('is-image');const format=require(a18_0x2894('0x8'));const os=require('os');const mqtt=require(a18_0x2894('0x9'));const uuidv4=require(a18_0x2894('0xa'));const jwt=require('jsonwebtoken');class MqttService{constructor(_0x37afee){this[a18_0x2894('0xb')]=_0x37afee;this['state']='closed';this['httpClientService']=new HttpClientService_1['HttpClientService']();}['init'](){this[a18_0x2894('0xc')]();}[a18_0x2894('0xd')](){console[a18_0x2894('0xe')](a18_0x2894('0xf'));const _0x419ae2=a18_0x2894('0x10');const _0xb65d76=a18_0x2894('0x11');const _0x166283='my-registry';const _0xd5ab2=a18_0x2894('0x12');const _0x340c7b=a18_0x2894('0x13');const _0x31eaa2=a18_0x2894('0x14');const _0x39d4fa=a18_0x2894('0x15');const _0x5b3fd9=0x1bb;const _0xf1558b='events';const _0x438bc6=0x5;const _0x32a7c2=a18_0x2894('0x16')+_0x419ae2+a18_0x2894('0x17')+_0xd5ab2+a18_0x2894('0x18')+_0x166283+a18_0x2894('0x19')+_0xb65d76;const _0x4a0220={'host':_0x39d4fa,'port':_0x5b3fd9,'clientId':_0x32a7c2,'username':a18_0x2894('0x1a'),'password':this['createJwt'](_0x419ae2,_0x31eaa2,_0x340c7b),'protocol':'mqtts','secureProtocol':'TLSv1_2_method'};const _0x5c602f=Math['round'](Date[a18_0x2894('0x1b')]()/0x3e8);const _0x5b9d5a=mqtt[a18_0x2894('0x1c')](_0x4a0220);_0x5b9d5a[a18_0x2894('0x1d')](a18_0x2894('0x19')+_0xb65d76+a18_0x2894('0x1e'),{'qos':0x1});_0x5b9d5a['subscribe'](a18_0x2894('0x19')+_0xb65d76+'/state',{'qos':0x1});_0x5b9d5a[a18_0x2894('0x1d')]('/devices/'+_0xb65d76+a18_0x2894('0x1f'),{'qos':0x0});const _0x7ccb6a=a18_0x2894('0x19')+_0xb65d76+'/'+_0xf1558b;_0x5b9d5a['on'](a18_0x2894('0x1c'),_0x2554be=>{console[a18_0x2894('0xe')]('connect');if(!_0x2554be){console[a18_0x2894('0xe')](a18_0x2894('0x20'));}else{const _0x7ccb6a=a18_0x2894('0x21');const _0x4ca36a=_0x166283+'/'+_0xb65d76+'-payload-0';_0x5b9d5a[a18_0x2894('0x22')](_0x7ccb6a,_0x4ca36a,{'qos':0x1},_0x165e78=>{console[a18_0x2894('0xe')](a18_0x2894('0x23'));console[a18_0x2894('0xe')](_0x165e78);if(!_0x165e78){}});}});_0x5b9d5a['on']('close',()=>{console[a18_0x2894('0xe')](a18_0x2894('0x24'));});_0x5b9d5a['on'](a18_0x2894('0x25'),_0x29fe63=>{console[a18_0x2894('0xe')](a18_0x2894('0x25'),_0x29fe63);});_0x5b9d5a['on']('message',(_0x3bd60e,_0x116f8a)=>{let _0x5be9bb=a18_0x2894('0x26');console['log'](_0x3bd60e);console['log'](_0x116f8a+'');if(_0x3bd60e===a18_0x2894('0x19')+_0xb65d76+a18_0x2894('0x1e')){_0x5be9bb='Config\x20message\x20received:\x20';}else if(_0x3bd60e[a18_0x2894('0x27')](a18_0x2894('0x19')+_0xb65d76+a18_0x2894('0x28'))){_0x5be9bb=a18_0x2894('0x29');}_0x5be9bb+=Buffer[a18_0x2894('0x2a')](_0x116f8a,a18_0x2894('0x2b'))[a18_0x2894('0x2c')]('ascii');console[a18_0x2894('0xe')](_0x5be9bb);});_0x5b9d5a['on'](a18_0x2894('0x2d'),()=>{});console['log'](_0x4a0220);}['mqttInit_mosquitto'](){console['log']('mqttInit');this['clientId']=uuidv4();console[a18_0x2894('0xe')](a18_0x2894('0x2e'));console[a18_0x2894('0xe')](this[a18_0x2894('0x2f')]);const _0xadcda4={'clientId':this[a18_0x2894('0x2f')],'username':a18_0x2894('0x30'),'password':a18_0x2894('0x31'),'clean':!![]};this['mqttClient']=mqtt[a18_0x2894('0x1c')]('mqtt://lulo.run',_0xadcda4);this['mqttClient']['on'](a18_0x2894('0x1c'),this[a18_0x2894('0x32')][a18_0x2894('0x33')](this));this[a18_0x2894('0x34')]['on'](a18_0x2894('0x35'),this[a18_0x2894('0x36')][a18_0x2894('0x33')](this));this['mqttClient']['on'](a18_0x2894('0x24'),()=>{console['log'](a18_0x2894('0x24'));});process['on'](a18_0x2894('0x37'),this[a18_0x2894('0x38')][a18_0x2894('0x33')](this));process['on']('SIGINT',this[a18_0x2894('0x38')]['bind'](this));process['on'](a18_0x2894('0x39'),this[a18_0x2894('0x38')][a18_0x2894('0x33')](this));}[a18_0x2894('0x32')](){console[a18_0x2894('0xe')](a18_0x2894('0x3a')+this[a18_0x2894('0x2f')]);this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x3b'));this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x3c'));this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x3d'),{'qos':0x2});this['mqttClient']['subscribe'](a18_0x2894('0x3e'),{'qos':0x2});this[a18_0x2894('0x34')][a18_0x2894('0x1d')]('player/reload_playlist',{'qos':0x2});this['mqttClient'][a18_0x2894('0x1d')](a18_0x2894('0x3f'),{'qos':0x2});this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x40'),{'qos':0x2});this[a18_0x2894('0x34')]['subscribe'](a18_0x2894('0x41'),{'qos':0x2});this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x42'),{'qos':0x2});this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x43'),{'qos':0x2});this[a18_0x2894('0x34')][a18_0x2894('0x1d')](a18_0x2894('0x44'),{'qos':0x2});}['reportStatus'](){}[a18_0x2894('0x36')](_0x2dbdc2,_0x2f56bd){console[a18_0x2894('0xe')]('received\x20message\x20%s\x20%s',_0x2dbdc2,_0x2f56bd);switch(_0x2dbdc2){case'player/open':return this[a18_0x2894('0x45')](_0x2f56bd);case a18_0x2894('0x3c'):return this['handleCloseRequest'](_0x2f56bd);case a18_0x2894('0x3d'):return this[a18_0x2894('0x46')](_0x2f56bd);case a18_0x2894('0x47'):return this[a18_0x2894('0x48')](_0x2f56bd);case a18_0x2894('0x3e'):return this[a18_0x2894('0x49')](_0x2f56bd);case a18_0x2894('0x3f'):return this['handleUpdateRequest'](_0x2f56bd);case a18_0x2894('0x40'):return this[a18_0x2894('0x4a')](_0x2f56bd);case'player/register':return this[a18_0x2894('0x4b')](_0x2f56bd);case a18_0x2894('0x42'):return this[a18_0x2894('0x4c')](_0x2f56bd);case'player/turn_off_tv':return this['handleTurnOffTVRequest'](_0x2f56bd);case'player/turn_on_tv':return this[a18_0x2894('0x4d')](_0x2f56bd);}}[a18_0x2894('0x4b')](_0xb49d75){if(_0xb49d75==a18_0x2894('0x4e')||_0xb49d75==String(this['syncPlaylistsService']['playerId'])){this[a18_0x2894('0xb')]['registerClient']();}}[a18_0x2894('0x4a')](_0x893f3d){if(_0x893f3d=='all'||_0x893f3d==String(this['syncPlaylistsService'][a18_0x2894('0x4f')])){}}['handleUpdateRequest'](_0x4abd94){console[a18_0x2894('0xe')](a18_0x2894('0x50')+_0x4abd94);if(_0x4abd94==a18_0x2894('0x4e')||_0x4abd94==String(this[a18_0x2894('0xb')][a18_0x2894('0x4f')])){const _0x52063c=__dirname;const _0x5c99be=require('simple-git')(_0x52063c);console[a18_0x2894('0xe')](a18_0x2894('0x51'));_0x5c99be['pull']((_0x2512b7,_0x289aa2)=>{if(_0x2512b7){console[a18_0x2894('0xe')]('Error\x20git\x20updated');this[a18_0x2894('0x52')](_0x4abd94);return;}else{}console['log']('Git\x20updated');console[a18_0x2894('0xe')](_0x289aa2);if(_0x289aa2&&_0x289aa2[a18_0x2894('0x53')][a18_0x2894('0x54')]){this[a18_0x2894('0xb')][a18_0x2894('0x55')]();}else{}});}}['handleLoadPlaylistRequest'](_0x4a30bd){if(_0x4a30bd==a18_0x2894('0x4e')||_0x4a30bd==String(this[a18_0x2894('0xb')]['playerId'])){this[a18_0x2894('0xb')][a18_0x2894('0x56')]();}}[a18_0x2894('0x48')](_0x35ce0e){if(String(_0x35ce0e)==a18_0x2894('0x4e')||String(_0x35ce0e)==String(this[a18_0x2894('0xb')][a18_0x2894('0x4f')])){this['syncPlaylistsService'][a18_0x2894('0x57')]();}}[a18_0x2894('0x46')](_0x1bbc62){if(_0x1bbc62==a18_0x2894('0x4e')||_0x1bbc62==String(this['syncPlaylistsService']['playerId'])){console['log'](a18_0x2894('0x58'));try{this['syncPlaylistsService']['reboot']();}catch(_0x2a5e65){console[a18_0x2894('0xe')](_0x2a5e65);}}}['handleUpdateSettingsRequest'](_0x2f7aa1){if(_0x2f7aa1==a18_0x2894('0x4e')||_0x2f7aa1==String(this[a18_0x2894('0xb')][a18_0x2894('0x4f')])){console[a18_0x2894('0xe')]('handleUpdateSettingsRequest:\x20');try{this[a18_0x2894('0xb')][a18_0x2894('0x59')]();}catch(_0x21bb40){console[a18_0x2894('0xe')](_0x21bb40);}}}[a18_0x2894('0x4d')](_0x28c52d){if(_0x28c52d==a18_0x2894('0x4e')||_0x28c52d==String(this['syncPlaylistsService'][a18_0x2894('0x4f')])){console[a18_0x2894('0xe')](a18_0x2894('0x5a'));try{this[a18_0x2894('0xb')]['turnOnTV']();}catch(_0x44c882){console[a18_0x2894('0xe')](_0x44c882);}}}[a18_0x2894('0x5b')](_0x9ee94b){if(_0x9ee94b=='all'||_0x9ee94b==String(this['syncPlaylistsService'][a18_0x2894('0x4f')])){console[a18_0x2894('0xe')](a18_0x2894('0x5c'));try{this['syncPlaylistsService']['turnOffTV']();}catch(_0x3ff190){console[a18_0x2894('0xe')](_0x3ff190);}}}[a18_0x2894('0x5d')](){console['log'](a18_0x2894('0x5e'),this['state']);this[a18_0x2894('0x34')][a18_0x2894('0x22')](a18_0x2894('0x5f'),this[a18_0x2894('0xb')]['playerId']+'-'+this[a18_0x2894('0x60')]);}[a18_0x2894('0x45')](_0x538fe8){if(this[a18_0x2894('0x60')]!==a18_0x2894('0x61')&&this[a18_0x2894('0x60')]!=='opening'){console['log'](a18_0x2894('0x62'));this[a18_0x2894('0x60')]=a18_0x2894('0x63');this[a18_0x2894('0x5d')]();setTimeout(()=>{this[a18_0x2894('0x60')]='open';this[a18_0x2894('0x5d')]();},0x1388);}}['handleCloseRequest'](_0x322d6f){if(this['state']!==a18_0x2894('0x64')&&this['state']!=='closing'){this[a18_0x2894('0x60')]='closing';this[a18_0x2894('0x5d')]();setTimeout(()=>{this[a18_0x2894('0x60')]=a18_0x2894('0x64');this[a18_0x2894('0x5d')]();},0x1388);}}[a18_0x2894('0x38')](_0x2d625c,_0x5b3023){if(_0x5b3023){console[a18_0x2894('0xe')](_0x5b3023[a18_0x2894('0x65')]);}this[a18_0x2894('0x34')][a18_0x2894('0x22')](a18_0x2894('0x66'),'false');}[a18_0x2894('0x67')](_0x419fa1,_0xaaa14c,_0x5a0fb1){const _0x3f0f33={'iat':Math[a18_0x2894('0x68')](Date['now']()/0x3e8),'exp':Math['round'](Date['now']()/0x3e8)+0x14*0x3c,'aud':_0x419fa1};const _0x58fa81=fs['readFileSync'](_0xaaa14c);return jwt[a18_0x2894('0x69')](_0x3f0f33,_0x58fa81,{'algorithm':_0x5a0fb1});}}exports[a18_0x2894('0x6a')]=MqttService;