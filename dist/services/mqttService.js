var a18_0x54fd=['state','handleOpenRequest','open','opening','closed','closing','sendStateUpdate','false','sign','MqttService','defineProperty','__esModule','./../infrastructure/HttpClientService','fs-extra','request','request-progress','child_process','spawn','is-image','string-template','mqtt','jsonwebtoken','syncPlaylistsService','httpClientService','init','mqttInit_mosquitto','mqttInit_google','log','mqttInit','velvety-glazing-252020','RS256','resources/keys/rsa_private.pem','events','projects/','/locations/','/devices/','unused','createJwt','TLSv1_2_method','round','now','connect','subscribe','/commands/#','Client\x20not\x20connected...','/projects/velvety-glazing-252020/topics/my-topic','publish','publish\x20result:','close','error','message','/config','Config\x20message\x20received:\x20','/commands','Command\x20message\x20received:\x20','from','base64','toString','packetsend','clientId','this.clientId','lulo_mqtt','mqttClient','bind','mqttClient_message','exit','SIGINT','uncaughtException','handleAppExit','mqttClient_connect','Connected\x20to\x20broker\x20client:','player/reboot','player/load_playlist','player/ifconfig','player/register','player/turn_on_tv','player/open','handleLoadPlaylistRequest','handleUpdateRequest','handleRegisterRequest','player/update_settings','player/turn_off_tv','handleTurnOffTVRequest','handleTurnOnTVRequest','all','playerId','handleUpdateRequest:\x20','Git\x20updating','pull','Git\x20updated','summary','reboot','loadMediaList','reloadMediaList','handleRebootRequest','handleRebootRequest\x20shutdown\x20-r\x20now:\x20','handleUpdateSettingsRequest','updateSettings','turnOnTV','sending\x20state\x20%s','player/state'];(function(_0x49354a,_0x532240){var _0x5c2156=function(_0x3dfa21){while(--_0x3dfa21){_0x49354a['push'](_0x49354a['shift']());}};_0x5c2156(++_0x532240);}(a18_0x54fd,0xd4));var a18_0x957f=function(_0x8d7bc5,_0xe3094f){_0x8d7bc5=_0x8d7bc5-0x0;var _0x3f06b7=a18_0x54fd[_0x8d7bc5];return _0x3f06b7;};'use strict';Object[a18_0x957f('0x0')](exports,a18_0x957f('0x1'),{'value':!![]});const HttpClientService_1=require(a18_0x957f('0x2'));const fs=require('fs');const fsExtra=require(a18_0x957f('0x3'));const request=require(a18_0x957f('0x4'));const progress=require(a18_0x957f('0x5'));const spawn=require(a18_0x957f('0x6'))[a18_0x957f('0x7')];const exec=require(a18_0x957f('0x6'))['exec'];const isImage=require(a18_0x957f('0x8'));const format=require(a18_0x957f('0x9'));const os=require('os');const mqtt=require(a18_0x957f('0xa'));const uuidv4=require('uuid/v4');const jwt=require(a18_0x957f('0xb'));class MqttService{constructor(_0xe176ec){this[a18_0x957f('0xc')]=_0xe176ec;this['state']='closed';this[a18_0x957f('0xd')]=new HttpClientService_1['HttpClientService']();}[a18_0x957f('0xe')](){this[a18_0x957f('0xf')]();}[a18_0x957f('0x10')](){console[a18_0x957f('0x11')](a18_0x957f('0x12'));const _0x4c29a4=a18_0x957f('0x13');const _0x32bc06='my-node-device';const _0x5bfc54='my-registry';const _0x22404f='us-central1';const _0x2f7958=a18_0x957f('0x14');const _0x5f0e6c=a18_0x957f('0x15');const _0x1a77f3='mqtt.googleapis.com';const _0x2dd628=0x1bb;const _0x22838e=a18_0x957f('0x16');const _0xdc8635=0x5;const _0x175307=a18_0x957f('0x17')+_0x4c29a4+a18_0x957f('0x18')+_0x22404f+'/registries/'+_0x5bfc54+a18_0x957f('0x19')+_0x32bc06;const _0x3eba88={'host':_0x1a77f3,'port':_0x2dd628,'clientId':_0x175307,'username':a18_0x957f('0x1a'),'password':this[a18_0x957f('0x1b')](_0x4c29a4,_0x5f0e6c,_0x2f7958),'protocol':'mqtts','secureProtocol':a18_0x957f('0x1c')};const _0x36244f=Math[a18_0x957f('0x1d')](Date[a18_0x957f('0x1e')]()/0x3e8);const _0x4115af=mqtt[a18_0x957f('0x1f')](_0x3eba88);_0x4115af['subscribe'](a18_0x957f('0x19')+_0x32bc06+'/config',{'qos':0x1});_0x4115af[a18_0x957f('0x20')](a18_0x957f('0x19')+_0x32bc06+'/state',{'qos':0x1});_0x4115af[a18_0x957f('0x20')]('/devices/'+_0x32bc06+a18_0x957f('0x21'),{'qos':0x0});const _0x2d58d6=a18_0x957f('0x19')+_0x32bc06+'/'+_0x22838e;_0x4115af['on']('connect',_0x51b595=>{console[a18_0x957f('0x11')](a18_0x957f('0x1f'));if(!_0x51b595){console['log'](a18_0x957f('0x22'));}else{const _0x2d58d6=a18_0x957f('0x23');const _0x44ba36=_0x5bfc54+'/'+_0x32bc06+'-payload-0';_0x4115af[a18_0x957f('0x24')](_0x2d58d6,_0x44ba36,{'qos':0x1},_0x30f62d=>{console['log'](a18_0x957f('0x25'));console[a18_0x957f('0x11')](_0x30f62d);if(!_0x30f62d){}});}});_0x4115af['on'](a18_0x957f('0x26'),()=>{console[a18_0x957f('0x11')]('close');});_0x4115af['on'](a18_0x957f('0x27'),_0x5b32cb=>{console[a18_0x957f('0x11')](a18_0x957f('0x27'),_0x5b32cb);});_0x4115af['on'](a18_0x957f('0x28'),(_0x2a4a15,_0x80703c)=>{let _0x5b827b='Message\x20received:\x20';console['log'](_0x2a4a15);console[a18_0x957f('0x11')](_0x80703c+'');if(_0x2a4a15===a18_0x957f('0x19')+_0x32bc06+a18_0x957f('0x29')){_0x5b827b=a18_0x957f('0x2a');}else if(_0x2a4a15['startsWith'](a18_0x957f('0x19')+_0x32bc06+a18_0x957f('0x2b'))){_0x5b827b=a18_0x957f('0x2c');}_0x5b827b+=Buffer[a18_0x957f('0x2d')](_0x80703c,a18_0x957f('0x2e'))[a18_0x957f('0x2f')]('ascii');console[a18_0x957f('0x11')](_0x5b827b);});_0x4115af['on'](a18_0x957f('0x30'),()=>{});console['log'](_0x3eba88);}['mqttInit_mosquitto'](){console[a18_0x957f('0x11')](a18_0x957f('0x12'));this[a18_0x957f('0x31')]=uuidv4();console[a18_0x957f('0x11')](a18_0x957f('0x32'));console[a18_0x957f('0x11')](this[a18_0x957f('0x31')]);const _0x3820b2={'clientId':this[a18_0x957f('0x31')],'username':a18_0x957f('0x33'),'password':'run.lulo_2018#.','clean':!![]};this[a18_0x957f('0x34')]=mqtt[a18_0x957f('0x1f')]('mqtt://lulo.run',_0x3820b2);this['mqttClient']['on'](a18_0x957f('0x1f'),this['mqttClient_connect'][a18_0x957f('0x35')](this));this[a18_0x957f('0x34')]['on']('message',this[a18_0x957f('0x36')]['bind'](this));this[a18_0x957f('0x34')]['on'](a18_0x957f('0x26'),()=>{console[a18_0x957f('0x11')](a18_0x957f('0x26'));});process['on'](a18_0x957f('0x37'),this['handleAppExit'][a18_0x957f('0x35')](this));process['on'](a18_0x957f('0x38'),this['handleAppExit']['bind'](this));process['on'](a18_0x957f('0x39'),this[a18_0x957f('0x3a')][a18_0x957f('0x35')](this));}[a18_0x957f('0x3b')](){console['log'](a18_0x957f('0x3c')+this['clientId']);this[a18_0x957f('0x34')]['subscribe']('player/open');this[a18_0x957f('0x34')][a18_0x957f('0x20')]('player/close');this[a18_0x957f('0x34')][a18_0x957f('0x20')](a18_0x957f('0x3d'),{'qos':0x2});this[a18_0x957f('0x34')]['subscribe'](a18_0x957f('0x3e'),{'qos':0x2});this[a18_0x957f('0x34')][a18_0x957f('0x20')]('player/reload_playlist',{'qos':0x2});this[a18_0x957f('0x34')][a18_0x957f('0x20')]('player/update',{'qos':0x2});this[a18_0x957f('0x34')]['subscribe'](a18_0x957f('0x3f'),{'qos':0x2});this[a18_0x957f('0x34')]['subscribe'](a18_0x957f('0x40'),{'qos':0x2});this[a18_0x957f('0x34')][a18_0x957f('0x20')]('player/update_settings',{'qos':0x2});this[a18_0x957f('0x34')]['subscribe']('player/turn_off_tv',{'qos':0x2});this[a18_0x957f('0x34')][a18_0x957f('0x20')](a18_0x957f('0x41'),{'qos':0x2});}['reportStatus'](){}['mqttClient_message'](_0x29cdbb,_0x50ddc5){console[a18_0x957f('0x11')]('received\x20message\x20%s\x20%s',_0x29cdbb,_0x50ddc5);switch(_0x29cdbb){case a18_0x957f('0x42'):return this['handleOpenRequest'](_0x50ddc5);case'player/close':return this['handleCloseRequest'](_0x50ddc5);case a18_0x957f('0x3d'):return this['handleRebootRequest'](_0x50ddc5);case'player/reload_playlist':return this['handleReloadPlaylistRequest'](_0x50ddc5);case a18_0x957f('0x3e'):return this[a18_0x957f('0x43')](_0x50ddc5);case'player/update':return this[a18_0x957f('0x44')](_0x50ddc5);case a18_0x957f('0x3f'):return this['handleIfconfigRequest'](_0x50ddc5);case a18_0x957f('0x40'):return this[a18_0x957f('0x45')](_0x50ddc5);case a18_0x957f('0x46'):return this['handleUpdateSettingsRequest'](_0x50ddc5);case a18_0x957f('0x47'):return this[a18_0x957f('0x48')](_0x50ddc5);case'player/turn_on_tv':return this[a18_0x957f('0x49')](_0x50ddc5);}}[a18_0x957f('0x45')](_0x1a5c7d){if(_0x1a5c7d==a18_0x957f('0x4a')||_0x1a5c7d==String(this[a18_0x957f('0xc')][a18_0x957f('0x4b')])){this[a18_0x957f('0xc')]['registerClient']();}}['handleIfconfigRequest'](_0x4a136a){if(_0x4a136a==a18_0x957f('0x4a')||_0x4a136a==String(this[a18_0x957f('0xc')]['playerId'])){}}['handleUpdateRequest'](_0x398753){console[a18_0x957f('0x11')](a18_0x957f('0x4c')+_0x398753);if(_0x398753==a18_0x957f('0x4a')||_0x398753==String(this[a18_0x957f('0xc')][a18_0x957f('0x4b')])){const _0x41e67f=__dirname;const _0x246662=require('simple-git')(_0x41e67f);console[a18_0x957f('0x11')](a18_0x957f('0x4d'));_0x246662[a18_0x957f('0x4e')]((_0x3fb34b,_0x314580)=>{if(_0x3fb34b){console[a18_0x957f('0x11')]('Error\x20git\x20updated');this[a18_0x957f('0x44')](_0x398753);return;}else{}console[a18_0x957f('0x11')](a18_0x957f('0x4f'));console[a18_0x957f('0x11')](_0x314580);if(_0x314580&&_0x314580[a18_0x957f('0x50')]['changes']){this[a18_0x957f('0xc')][a18_0x957f('0x51')]();}else{}});}}[a18_0x957f('0x43')](_0x543f89){if(_0x543f89==a18_0x957f('0x4a')||_0x543f89==String(this[a18_0x957f('0xc')]['playerId'])){this[a18_0x957f('0xc')][a18_0x957f('0x52')]();}}['handleReloadPlaylistRequest'](_0x54414f){if(String(_0x54414f)=='all'||String(_0x54414f)==String(this[a18_0x957f('0xc')][a18_0x957f('0x4b')])){this[a18_0x957f('0xc')][a18_0x957f('0x53')]();}}[a18_0x957f('0x54')](_0x23b7f2){if(_0x23b7f2==a18_0x957f('0x4a')||_0x23b7f2==String(this['syncPlaylistsService'][a18_0x957f('0x4b')])){console[a18_0x957f('0x11')](a18_0x957f('0x55'));try{this[a18_0x957f('0xc')][a18_0x957f('0x51')]();}catch(_0x295475){console[a18_0x957f('0x11')](_0x295475);}}}[a18_0x957f('0x56')](_0x54d07a){if(_0x54d07a==a18_0x957f('0x4a')||_0x54d07a==String(this[a18_0x957f('0xc')][a18_0x957f('0x4b')])){console[a18_0x957f('0x11')]('handleUpdateSettingsRequest:\x20');try{this[a18_0x957f('0xc')][a18_0x957f('0x57')]();}catch(_0x40fb32){console[a18_0x957f('0x11')](_0x40fb32);}}}['handleTurnOnTVRequest'](_0x415154){if(_0x415154==a18_0x957f('0x4a')||_0x415154==String(this[a18_0x957f('0xc')]['playerId'])){console[a18_0x957f('0x11')]('handleTurnOnTVRequest:\x20');try{this[a18_0x957f('0xc')][a18_0x957f('0x58')]();}catch(_0x24d016){console[a18_0x957f('0x11')](_0x24d016);}}}[a18_0x957f('0x48')](_0x3db6a6){if(_0x3db6a6==a18_0x957f('0x4a')||_0x3db6a6==String(this[a18_0x957f('0xc')][a18_0x957f('0x4b')])){console[a18_0x957f('0x11')]('handleTurnOffTVRequest:\x20');try{this[a18_0x957f('0xc')]['turnOffTV']();}catch(_0x31ec27){console[a18_0x957f('0x11')](_0x31ec27);}}}['sendStateUpdate'](){console[a18_0x957f('0x11')](a18_0x957f('0x59'),this['state']);this[a18_0x957f('0x34')]['publish'](a18_0x957f('0x5a'),this[a18_0x957f('0xc')][a18_0x957f('0x4b')]+'-'+this[a18_0x957f('0x5b')]);}[a18_0x957f('0x5c')](_0x2f656a){if(this[a18_0x957f('0x5b')]!==a18_0x957f('0x5d')&&this[a18_0x957f('0x5b')]!=='opening'){console['log']('opening\x20player\x20door');this[a18_0x957f('0x5b')]=a18_0x957f('0x5e');this['sendStateUpdate']();setTimeout(()=>{this[a18_0x957f('0x5b')]=a18_0x957f('0x5d');this['sendStateUpdate']();},0x1388);}}['handleCloseRequest'](_0x7f5509){if(this[a18_0x957f('0x5b')]!==a18_0x957f('0x5f')&&this['state']!==a18_0x957f('0x60')){this['state']=a18_0x957f('0x60');this[a18_0x957f('0x61')]();setTimeout(()=>{this['state']=a18_0x957f('0x5f');this[a18_0x957f('0x61')]();},0x1388);}}[a18_0x957f('0x3a')](_0x198cc3,_0x25246b){if(_0x25246b){console['log'](_0x25246b['stack']);}this[a18_0x957f('0x34')][a18_0x957f('0x24')]('player/connected',a18_0x957f('0x62'));}[a18_0x957f('0x1b')](_0x2e517e,_0x31df89,_0x466b75){const _0x5e9cbd={'iat':Math[a18_0x957f('0x1d')](Date[a18_0x957f('0x1e')]()/0x3e8),'exp':Math[a18_0x957f('0x1d')](Date[a18_0x957f('0x1e')]()/0x3e8)+0x14*0x3c,'aud':_0x2e517e};const _0x53c28a=fs['readFileSync'](_0x31df89);return jwt[a18_0x957f('0x63')](_0x5e9cbd,_0x53c28a,{'algorithm':_0x466b75});}}exports[a18_0x957f('0x64')]=MqttService;