var a20_0x2436=['eventFileFolder','stringify','.gz','createWriteStream','pipe','existsSync','unlink','successfully\x20deleted\x20','successfully\x20created\x20','.txt','data','default','current_driver.jpg','ensureDirSync','latitude','replace','base64Sync','parse','writeFile','Event\x20saved','EventsService','__importDefault','__esModule','defineProperty','../infrastructure/stationSettings','./gpsService','./sensorsService','./CountingWebsocketService','../infrastructure/crypt-utils','base64-img','uuid/v4','startDateParts','folder','env','FILES_FOLDER','vehicleId','VEHICLE_ID','log','init\x20EventsService','gpsService','GPSService','getInstance','sensorsService','SensorsService','countingWebSocketService','CountingWebSocketService','createEvent','bind','startDate','getDateParts','instance','eventDate','DateUtils','createJson','createFile','1-71767930-','eventDateParts','year','month','day','hour','second','-00001','StationContext','settings','driverDocument','routeCode','routeName','nit','plate','minute','locationParts','hdop','longitude','speed','doorStatus','CountingInfo','Out','zlib'];(function(_0x516d65,_0x59cc06){var _0x5a731e=function(_0x3d9273){while(--_0x3d9273){_0x516d65['push'](_0x516d65['shift']());}};_0x5a731e(++_0x59cc06);}(a20_0x2436,0xb3));var a20_0x1077=function(_0x5af139,_0x2d3fd3){_0x5af139=_0x5af139-0x0;var _0x50e7fe=a20_0x2436[_0x5af139];return _0x50e7fe;};'use strict';var __importDefault=this&&this[a20_0x1077('0x0')]||function(_0x1d45a1){return _0x1d45a1&&_0x1d45a1[a20_0x1077('0x1')]?_0x1d45a1:{'default':_0x1d45a1};};Object[a20_0x1077('0x2')](exports,a20_0x1077('0x1'),{'value':!![]});const stationSettings_1=require(a20_0x1077('0x3'));const dateUtils_1=require('../infrastructure/utils/dateUtils');const gpsService_1=require(a20_0x1077('0x4'));const sensorsService_1=require(a20_0x1077('0x5'));const CountingWebsocketService_1=require(a20_0x1077('0x6'));const crypt_utils_1=__importDefault(require(a20_0x1077('0x7')));const fsExtra=require('fs-extra');const base64Img=require(a20_0x1077('0x8'));const request=require('request');const uuidv4=require(a20_0x1077('0x9'));class EventsService{constructor(){this['eventDateParts']={'day':'','month':'','year':'','hour':'','minute':'','second':''};this[a20_0x1077('0xa')]={'day':'','month':'','year':'','hour':'','minute':'','second':''};this[a20_0x1077('0xb')]=process[a20_0x1077('0xc')][a20_0x1077('0xd')];this[a20_0x1077('0xe')]=process[a20_0x1077('0xc')][a20_0x1077('0xf')];console[a20_0x1077('0x10')](a20_0x1077('0x11'));this[a20_0x1077('0x12')]=gpsService_1[a20_0x1077('0x13')][a20_0x1077('0x14')]();this[a20_0x1077('0x15')]=sensorsService_1[a20_0x1077('0x16')][a20_0x1077('0x14')]();this[a20_0x1077('0x17')]=CountingWebsocketService_1[a20_0x1077('0x18')][a20_0x1077('0x14')]();this[a20_0x1077('0x12')][a20_0x1077('0x19')]=this[a20_0x1077('0x19')][a20_0x1077('0x1a')](this);this[a20_0x1077('0x15')][a20_0x1077('0x19')]=this['createEvent']['bind'](this);this[a20_0x1077('0x17')][a20_0x1077('0x19')]=this[a20_0x1077('0x19')][a20_0x1077('0x1a')](this);this[a20_0x1077('0x1b')]=new Date();this[a20_0x1077('0xa')]=dateUtils_1['DateUtils'][a20_0x1077('0x1c')](this['startDate']);}static[a20_0x1077('0x14')](){if(!EventsService['instance']){EventsService[a20_0x1077('0x1d')]=new EventsService();}return EventsService[a20_0x1077('0x1d')];}['createEvent'](_0x3ed26b){try{this[a20_0x1077('0x1e')]=new Date();this['eventDateParts']=dateUtils_1[a20_0x1077('0x1f')][a20_0x1077('0x1c')](this[a20_0x1077('0x1e')]);const _0x543707=this[a20_0x1077('0x20')](_0x3ed26b);const _0x1a2abe=this[a20_0x1077('0x21')](_0x543707);}catch(_0x5319fa){console[a20_0x1077('0x10')](_0x5319fa);}}[a20_0x1077('0x20')](_0x4a6a16){const _0x230584={'idViaje':a20_0x1077('0x22')+this[a20_0x1077('0x23')][a20_0x1077('0x24')]+this[a20_0x1077('0x23')][a20_0x1077('0x25')]+this[a20_0x1077('0x23')][a20_0x1077('0x26')]+'-'+this[a20_0x1077('0x23')][a20_0x1077('0x27')]+this[a20_0x1077('0x23')]['minute']+this[a20_0x1077('0x23')][a20_0x1077('0x28')]+a20_0x1077('0x29'),'cedula':stationSettings_1[a20_0x1077('0x2a')][a20_0x1077('0x2b')][a20_0x1077('0x2c')],'codigoRuta':stationSettings_1['StationContext'][a20_0x1077('0x2b')][a20_0x1077('0x2d')],'ruta':stationSettings_1['StationContext'][a20_0x1077('0x2b')][a20_0x1077('0x2e')],'nit':stationSettings_1[a20_0x1077('0x2a')]['settings'][a20_0x1077('0x2f')],'placa':stationSettings_1[a20_0x1077('0x2a')][a20_0x1077('0x2b')][a20_0x1077('0x30')],'inicio_viaje':this[a20_0x1077('0x23')][a20_0x1077('0x26')]+'/'+this[a20_0x1077('0x23')][a20_0x1077('0x25')]+'/'+this['eventDateParts'][a20_0x1077('0x24')]+'\x20'+this[a20_0x1077('0x23')][a20_0x1077('0x27')]+':'+this[a20_0x1077('0x23')][a20_0x1077('0x31')]+':'+this[a20_0x1077('0x23')][a20_0x1077('0x28')],'fin_viaje':'','estado':'0','eventos':[{'archivo_enviado':![],'fecha':this[a20_0x1077('0x23')]['year']+this['eventDateParts']['month']+this['eventDateParts'][a20_0x1077('0x26')],'hora':this['eventDateParts'][a20_0x1077('0x27')]+this[a20_0x1077('0x23')][a20_0x1077('0x31')]+this[a20_0x1077('0x23')][a20_0x1077('0x28')],'dop':this[a20_0x1077('0x12')][a20_0x1077('0x32')][a20_0x1077('0x33')],'longitud':this['gpsService'][a20_0x1077('0x32')][a20_0x1077('0x34')],'latitud':this['gpsService']['locationParts']['latitude'],'velocidad':this[a20_0x1077('0x12')]['locationParts'][a20_0x1077('0x35')],'puerta':[{'estado':this[a20_0x1077('0x15')][a20_0x1077('0x36')],'idPuerta':0x0,'ingresos':_0x4a6a16!=null?_0x4a6a16[a20_0x1077('0x37')][0x0]['In']:0x0,'salidas':_0x4a6a16!=null?_0x4a6a16['CountingInfo'][0x0][a20_0x1077('0x38')]:0x0},{'estado':0x0,'idPuerta':0x1,'ingresos':0x0,'salidas':0x0}]}]};return _0x230584;}[a20_0x1077('0x21')](_0x2ab3d0){const _0x458dff=require('fs');const _0x3f91d5=require(a20_0x1077('0x39'));const _0x3c7c81=stationSettings_1['StationContext']['settings'][a20_0x1077('0x2f')]+stationSettings_1['StationContext'][a20_0x1077('0x2b')][a20_0x1077('0x30')]+this[a20_0x1077('0x23')][a20_0x1077('0x26')]+this['eventDateParts'][a20_0x1077('0x25')]+this[a20_0x1077('0x23')][a20_0x1077('0x24')]+this[a20_0x1077('0x23')][a20_0x1077('0x27')]+this[a20_0x1077('0x23')]['minute']+this[a20_0x1077('0x23')][a20_0x1077('0x28')];const _0x32be25=stationSettings_1['StationContext'][a20_0x1077('0x2b')][a20_0x1077('0x3a')]+_0x3c7c81;const _0x55260f=JSON[a20_0x1077('0x3b')](_0x2ab3d0);_0x458dff['writeFile'](_0x32be25,_0x55260f,_0x3d0254=>{if(_0x3d0254)return console['error'](_0x3d0254);const _0x3d2f25=_0x32be25+a20_0x1077('0x3c');const _0x525504=_0x3f91d5['createGzip']();const _0x5c302e=_0x458dff['createReadStream'](_0x32be25);const _0x1eb8d6=_0x458dff[a20_0x1077('0x3d')](_0x3d2f25);_0x5c302e['pipe'](_0x525504)[a20_0x1077('0x3e')](_0x1eb8d6)['on']('finish',_0x3d0254=>{if(_0x3d0254)return console['error'](_0x3d0254);else{if(_0x458dff[a20_0x1077('0x3f')](_0x32be25)){_0x458dff[a20_0x1077('0x40')](_0x32be25,_0x3d0254=>{if(_0x3d0254)throw _0x3d0254;console[a20_0x1077('0x10')](a20_0x1077('0x41')+_0x32be25);});}console[a20_0x1077('0x10')](a20_0x1077('0x42')+_0x3d2f25);return _0x3d2f25;}});});}['saveEvent'](_0x2e5619){const _0x1eca8=this[a20_0x1077('0xb')]+stationSettings_1[a20_0x1077('0x2a')]['settings']['eventFileFolder'];const _0x518751=_0x1eca8+uuidv4()+a20_0x1077('0x43');const _0x3a1617=this[a20_0x1077('0x12')]?this[a20_0x1077('0x12')][a20_0x1077('0x32')]:{};const _0x2bbbd0=_0x2e5619[a20_0x1077('0x44')];const _0x2838d2=crypt_utils_1[a20_0x1077('0x45')]['encrypt'](String(_0x2bbbd0));const _0x4e569e=this[a20_0x1077('0xb')]+a20_0x1077('0x46');let _0x14c251=null;fsExtra[a20_0x1077('0x47')](_0x1eca8);const _0x593bda={'event_type_id':_0x2838d2,'vehicle_id':this['vehicleId'],'latitude':_0x3a1617[a20_0x1077('0x48')]?_0x3a1617[a20_0x1077('0x48')][a20_0x1077('0x49')](',','.'):0x0,'longitude':_0x3a1617[a20_0x1077('0x34')]?_0x3a1617[a20_0x1077('0x34')][a20_0x1077('0x49')](',','.'):0x0,'speed':_0x3a1617['speed']?_0x3a1617[a20_0x1077('0x35')]:0x0,'reported_at':new Date(),'image_data':_0x14c251};if(fsExtra[a20_0x1077('0x3f')](_0x4e569e)){_0x14c251=base64Img[a20_0x1077('0x4a')](_0x4e569e);_0x14c251=JSON[a20_0x1077('0x4b')](JSON[a20_0x1077('0x3b')](_0x14c251));_0x593bda['image_data']=_0x14c251;}const _0x33fffc=JSON[a20_0x1077('0x3b')](_0x593bda);fsExtra[a20_0x1077('0x4c')](_0x518751,_0x33fffc,_0x108a39=>{if(_0x108a39)return console['error'](_0x108a39);console['log'](a20_0x1077('0x4d'));});}}exports[a20_0x1077('0x4e')]=EventsService;