var a20_0x5e6d=['ensureDirSync','vehicleId','replace','base64Sync','parse','image_data','Event\x20saved','EventsService','defineProperty','__esModule','./gpsService','./sensorsService','./CountingWebsocketService','fs-extra','base64-img','uuid/v4','startDateParts','folder','env','FILES_FOLDER','VEHICLE_ID','log','init\x20EventsService','GPSService','getInstance','CountingWebSocketService','createEvent','bind','countingWebSocketService','startDate','instance','eventDate','eventDateParts','DateUtils','getDateParts','createJson','createFile','1-71767930-','year','month','day','hour','-00001','StationContext','settings','routeCode','routeName','nit','minute','second','gpsService','locationParts','hdop','longitude','latitude','speed','doorStatus','CountingInfo','zlib','plate','stringify','writeFile','error','createReadStream','createWriteStream','pipe','finish','existsSync','unlink','successfully\x20deleted\x20','successfully\x20created\x20','saveEvent','eventFileFolder','.txt','data','default','encrypt','current_driver.jpg'];(function(_0x1c335e,_0x483841){var _0x1e8275=function(_0x197a74){while(--_0x197a74){_0x1c335e['push'](_0x1c335e['shift']());}};_0x1e8275(++_0x483841);}(a20_0x5e6d,0xa4));var a20_0x50cd=function(_0x148e1d,_0xec8fe0){_0x148e1d=_0x148e1d-0x0;var _0x515040=a20_0x5e6d[_0x148e1d];return _0x515040;};'use strict';var __importDefault=this&&this['__importDefault']||function(_0x2003c9){return _0x2003c9&&_0x2003c9['__esModule']?_0x2003c9:{'default':_0x2003c9};};Object[a20_0x50cd('0x0')](exports,a20_0x50cd('0x1'),{'value':!![]});const stationSettings_1=require('../infrastructure/stationSettings');const dateUtils_1=require('../infrastructure/utils/dateUtils');const gpsService_1=require(a20_0x50cd('0x2'));const sensorsService_1=require(a20_0x50cd('0x3'));const CountingWebsocketService_1=require(a20_0x50cd('0x4'));const crypt_utils_1=__importDefault(require('../infrastructure/crypt-utils'));const fsExtra=require(a20_0x50cd('0x5'));const base64Img=require(a20_0x50cd('0x6'));const request=require('request');const uuidv4=require(a20_0x50cd('0x7'));class EventsService{constructor(){this['eventDateParts']={'day':'','month':'','year':'','hour':'','minute':'','second':''};this[a20_0x50cd('0x8')]={'day':'','month':'','year':'','hour':'','minute':'','second':''};this[a20_0x50cd('0x9')]=process[a20_0x50cd('0xa')][a20_0x50cd('0xb')];this['vehicleId']=process[a20_0x50cd('0xa')][a20_0x50cd('0xc')];console[a20_0x50cd('0xd')](a20_0x50cd('0xe'));this['gpsService']=gpsService_1[a20_0x50cd('0xf')]['getInstance']();this['sensorsService']=sensorsService_1['SensorsService'][a20_0x50cd('0x10')]();this['countingWebSocketService']=CountingWebsocketService_1[a20_0x50cd('0x11')][a20_0x50cd('0x10')]();this['gpsService'][a20_0x50cd('0x12')]=this[a20_0x50cd('0x12')][a20_0x50cd('0x13')](this);this['sensorsService'][a20_0x50cd('0x12')]=this[a20_0x50cd('0x12')][a20_0x50cd('0x13')](this);this[a20_0x50cd('0x14')][a20_0x50cd('0x12')]=this[a20_0x50cd('0x12')]['bind'](this);this[a20_0x50cd('0x15')]=new Date();this[a20_0x50cd('0x8')]=dateUtils_1['DateUtils']['getDateParts'](this[a20_0x50cd('0x15')]);}static[a20_0x50cd('0x10')](){if(!EventsService[a20_0x50cd('0x16')]){EventsService[a20_0x50cd('0x16')]=new EventsService();}return EventsService['instance'];}[a20_0x50cd('0x12')](_0x5173b8){try{this[a20_0x50cd('0x17')]=new Date();this[a20_0x50cd('0x18')]=dateUtils_1[a20_0x50cd('0x19')][a20_0x50cd('0x1a')](this[a20_0x50cd('0x17')]);const _0x3a2d92=this[a20_0x50cd('0x1b')](_0x5173b8);const _0x2bc1b4=this[a20_0x50cd('0x1c')](_0x3a2d92);}catch(_0x1618a6){console[a20_0x50cd('0xd')](_0x1618a6);}}[a20_0x50cd('0x1b')](_0x1ce5e9){const _0x33995c={'idViaje':a20_0x50cd('0x1d')+this['eventDateParts'][a20_0x50cd('0x1e')]+this[a20_0x50cd('0x18')][a20_0x50cd('0x1f')]+this[a20_0x50cd('0x18')][a20_0x50cd('0x20')]+'-'+this['eventDateParts'][a20_0x50cd('0x21')]+this[a20_0x50cd('0x18')]['minute']+this[a20_0x50cd('0x18')]['second']+a20_0x50cd('0x22'),'cedula':stationSettings_1[a20_0x50cd('0x23')][a20_0x50cd('0x24')]['driverDocument'],'codigoRuta':stationSettings_1[a20_0x50cd('0x23')][a20_0x50cd('0x24')][a20_0x50cd('0x25')],'ruta':stationSettings_1[a20_0x50cd('0x23')][a20_0x50cd('0x24')][a20_0x50cd('0x26')],'nit':stationSettings_1[a20_0x50cd('0x23')]['settings'][a20_0x50cd('0x27')],'placa':stationSettings_1[a20_0x50cd('0x23')][a20_0x50cd('0x24')]['plate'],'inicio_viaje':this[a20_0x50cd('0x18')][a20_0x50cd('0x20')]+'/'+this[a20_0x50cd('0x18')]['month']+'/'+this['eventDateParts']['year']+'\x20'+this[a20_0x50cd('0x18')][a20_0x50cd('0x21')]+':'+this['eventDateParts'][a20_0x50cd('0x28')]+':'+this[a20_0x50cd('0x18')]['second'],'fin_viaje':'','estado':'0','eventos':[{'archivo_enviado':![],'fecha':this[a20_0x50cd('0x18')][a20_0x50cd('0x1e')]+this[a20_0x50cd('0x18')][a20_0x50cd('0x1f')]+this['eventDateParts']['day'],'hora':this[a20_0x50cd('0x18')][a20_0x50cd('0x21')]+this[a20_0x50cd('0x18')][a20_0x50cd('0x28')]+this['eventDateParts'][a20_0x50cd('0x29')],'dop':this[a20_0x50cd('0x2a')][a20_0x50cd('0x2b')][a20_0x50cd('0x2c')],'longitud':this[a20_0x50cd('0x2a')]['locationParts'][a20_0x50cd('0x2d')],'latitud':this[a20_0x50cd('0x2a')][a20_0x50cd('0x2b')][a20_0x50cd('0x2e')],'velocidad':this[a20_0x50cd('0x2a')][a20_0x50cd('0x2b')][a20_0x50cd('0x2f')],'puerta':[{'estado':this['sensorsService'][a20_0x50cd('0x30')],'idPuerta':0x0,'ingresos':_0x1ce5e9!=null?_0x1ce5e9[a20_0x50cd('0x31')][0x0]['In']:0x0,'salidas':_0x1ce5e9!=null?_0x1ce5e9[a20_0x50cd('0x31')][0x0]['Out']:0x0},{'estado':0x0,'idPuerta':0x1,'ingresos':0x0,'salidas':0x0}]}]};return _0x33995c;}['createFile'](_0xd56876){const _0x4d7f15=require('fs');const _0x2da3d9=require(a20_0x50cd('0x32'));const _0x3a3fc6=stationSettings_1[a20_0x50cd('0x23')][a20_0x50cd('0x24')][a20_0x50cd('0x27')]+stationSettings_1[a20_0x50cd('0x23')]['settings'][a20_0x50cd('0x33')]+this['eventDateParts'][a20_0x50cd('0x20')]+this[a20_0x50cd('0x18')][a20_0x50cd('0x1f')]+this['eventDateParts'][a20_0x50cd('0x1e')]+this['eventDateParts']['hour']+this['eventDateParts'][a20_0x50cd('0x28')]+this['eventDateParts'][a20_0x50cd('0x29')];const _0x24dda2=stationSettings_1[a20_0x50cd('0x23')][a20_0x50cd('0x24')]['eventFileFolder']+_0x3a3fc6;const _0x505dca=JSON[a20_0x50cd('0x34')](_0xd56876);_0x4d7f15[a20_0x50cd('0x35')](_0x24dda2,_0x505dca,_0x591235=>{if(_0x591235)return console[a20_0x50cd('0x36')](_0x591235);const _0x3f1308=_0x24dda2+'.gz';const _0x437e19=_0x2da3d9['createGzip']();const _0x26e8c0=_0x4d7f15[a20_0x50cd('0x37')](_0x24dda2);const _0x2cf70a=_0x4d7f15[a20_0x50cd('0x38')](_0x3f1308);_0x26e8c0['pipe'](_0x437e19)[a20_0x50cd('0x39')](_0x2cf70a)['on'](a20_0x50cd('0x3a'),_0x591235=>{if(_0x591235)return console[a20_0x50cd('0x36')](_0x591235);else{if(_0x4d7f15[a20_0x50cd('0x3b')](_0x24dda2)){_0x4d7f15[a20_0x50cd('0x3c')](_0x24dda2,_0x591235=>{if(_0x591235)throw _0x591235;console[a20_0x50cd('0xd')](a20_0x50cd('0x3d')+_0x24dda2);});}console[a20_0x50cd('0xd')](a20_0x50cd('0x3e')+_0x3f1308);return _0x3f1308;}});});}[a20_0x50cd('0x3f')](_0xf7d76e){const _0x122a76=this['folder']+stationSettings_1[a20_0x50cd('0x23')]['settings'][a20_0x50cd('0x40')];const _0x216558=_0x122a76+uuidv4()+a20_0x50cd('0x41');const _0x1c5c4c=this['gpsService']?this[a20_0x50cd('0x2a')][a20_0x50cd('0x2b')]:{};const _0x31e013=_0xf7d76e[a20_0x50cd('0x42')];const _0xa23ba8=crypt_utils_1[a20_0x50cd('0x43')][a20_0x50cd('0x44')](String(_0x31e013));const _0x1f3b66=this[a20_0x50cd('0x9')]+a20_0x50cd('0x45');let _0x8bfc77=null;fsExtra[a20_0x50cd('0x46')](_0x122a76);const _0xe8f7e1={'event_type_id':_0xa23ba8,'vehicle_id':this[a20_0x50cd('0x47')],'latitude':_0x1c5c4c[a20_0x50cd('0x2e')]?_0x1c5c4c[a20_0x50cd('0x2e')][a20_0x50cd('0x48')](',','.'):0x0,'longitude':_0x1c5c4c[a20_0x50cd('0x2d')]?_0x1c5c4c[a20_0x50cd('0x2d')]['replace'](',','.'):0x0,'speed':_0x1c5c4c['speed']?_0x1c5c4c[a20_0x50cd('0x2f')]:0x0,'reported_at':new Date(),'image_data':_0x8bfc77};if(fsExtra[a20_0x50cd('0x3b')](_0x1f3b66)){_0x8bfc77=base64Img[a20_0x50cd('0x49')](_0x1f3b66);_0x8bfc77=JSON[a20_0x50cd('0x4a')](JSON[a20_0x50cd('0x34')](_0x8bfc77));_0xe8f7e1[a20_0x50cd('0x4b')]=_0x8bfc77;}const _0x290fac=JSON[a20_0x50cd('0x34')](_0xe8f7e1);fsExtra[a20_0x50cd('0x35')](_0x216558,_0x290fac,_0x58c510=>{if(_0x58c510)return console[a20_0x50cd('0x36')](_0x58c510);console[a20_0x50cd('0xd')](a20_0x50cd('0x4c'));});}}exports[a20_0x50cd('0x4d')]=EventsService;